/*! alpha-builder 2016-07-21 */
angular.module("alphaBuilder",["ngRoute","ui.bootstrap","ngAnimate","slick","ngSanitize","checklist-model","youtube-embed","angular.filter","ui.bootstrap","ui.select","ngMessages","uiGmapgoogle-maps","ngFacebook","ui.mask","angular-cardflow","bootstrapLightbox","duScroll","placeholderShim","angulartics","angulartics.google.analytics","smoothScroll","tmh.dynamicLocale","gettext"]),angular.module("alphaBuilder").config(["$routeProvider","$locationProvider","uiSelectConfig","$facebookProvider","uiGmapGoogleMapApiProvider","LightboxProvider","tmhDynamicLocaleProvider",function($routeProvider,$locationProvider,uiSelectConfig,$facebookProvider,uiGmapGoogleMapApiProvider,LightboxProvider,tmhDynamicLocaleProvider){$routeProvider.when("/:locale?/what-is-alpha",{templateUrl:"/templates/explore/explore.html"}).when("/:locale?/event/:eventId",{templateUrl:"/templates/event/event.html"}).when("/:locale?/product/:productId",{templateUrl:"/templates/product/product.html"}).when("/:locale?/faqs",{templateUrl:"/templates/faqs/faqs.html"}).when("/:locale?/logout",{controller:"LogoutController",template:""}).when("/:locale?/get-started/authenticate",{templateUrl:"/templates/authentication/authentication.html"}).when("/:locale?/dashboard",{templateUrl:"/templates/dashboard/dashboard.html"}).when("/:locale?/schedule",{templateUrl:"/templates/courses/schedule.html"}).when("/:locale?/materials",{templateUrl:"/templates/materials/materials.html"}).when("/:locale?/invite",{templateUrl:"/templates/promote/invite.html"}).when("/:locale?/invite/print",{templateUrl:"/templates/promote/print.html"}).when("/:locale?/invite/social",{templateUrl:"/templates/promote/social.html"}).when("/:locale?/my-account",{templateUrl:"/templates/authentication/my-account.html"}).when("/:locale?/update-alpha",{templateUrl:"/templates/courses/update-course.html"}).when("/:locale?/preview",{redirectTo:"/preview/training"}).when("/:locale?/preview/training",{templateUrl:"/templates/preview/training.html"}).when("/:locale?/preview/questions",{templateUrl:"/templates/preview/questions.html"}).when("/:locale?/preview/supporting-materials",{templateUrl:"/templates/preview/supporting-materials.html"}).when("/:locale?/preview/supporting-materials/:section",{redirectTo:function(params){var validUrls=["alpha-film-series","alpha-with-nicky-gumbel","alpha-youth-film-series","alpha-at-htb"];for(idx in validUrls)if(params.section==validUrls[idx])return;return"/preview/supporting-materials"},templateUrl:"/templates/preview/supporting-materials-film-page.html"}).when("/:locale?",{templateUrl:"/templates/home/home.html"}).otherwise({redirectTo:"/"}),$locationProvider.html5Mode(!0).hashPrefix("!"),uiSelectConfig.theme="bootstrap",uiSelectConfig.resetSearchInput=!0,$facebookProvider.setAppId("1406449516326384"),uiGmapGoogleMapApiProvider.configure({v:"3.17"}),LightboxProvider.templateUrl="/templates/promote/lightbox-modal.html",LightboxProvider.getImageUrl=function(imageUrl){return imageUrl},LightboxProvider.getImageCaption=function(imageUrl){return""},LightboxProvider.calculateImageDimensionLimits=function(dimensions){return{maxWidth:dimensions.windowWidth>=768?dimensions.windowWidth-92:dimensions.windowWidth-52,maxHeight:1600}},LightboxProvider.calculateModalDimensions=function(dimensions){var width=Math.max(400,dimensions.imageDisplayWidth+32);return(width>=dimensions.windowWidth-20||dimensions.windowWidth<768)&&(width="auto"),{width:width,height:"auto"}},tmhDynamicLocaleProvider.localeLocationPattern("/js/locales/angular-locale_{{locale}}.js")}]),angular.module("alphaBuilder").run(["$rootScope","gettextCatalog","translationSvc",function($rootScope,gettextCatalog,translationSvc){if($rootScope.buildTimestamp="1469091104266",$rootScope.envinronment="production","development"!==$rootScope.envinronment){var storageBuild=localStorage.getItem("buildID")||null;storageBuild&&storageBuild==$rootScope.buildTimestamp||(localStorage.clear(),localStorage.setItem("buildID",$rootScope.buildTimestamp))}!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];d.getElementById(id)||(js=d.createElement(s),js.id=id,js.src="//connect.facebook.net/en_US/sdk.js",fjs.parentNode.insertBefore(js,fjs))}(document,"script","facebook-jssdk"),translationSvc.restore()["finally"](function(){var defaultLocale=translationSvc.locale;gettextCatalog.setCurrentLanguage(defaultLocale),gettextCatalog.loadRemote("/js/translations/"+defaultLocale+".json")}),$rootScope.$on("$routeChangeSuccess",function(event,current,previous){current.pathParams.hasOwnProperty("locale")&&translationSvc.changeLocale(current.pathParams.locale,$rootScope)})}]),angular.module("alphaBuilder").value("resizeTiles",function(){var width=null,halfWidth=null;$(".item").each(function(index){width||(width=$(this).width(),halfWidth=width/2);var iWidth=width;$(window).width()<768&&(iWidth=halfWidth),$(this).hasClass("half")&&(iWidth=halfWidth),$(this).height(iWidth);var inner=$(this).find(".inner");inner.height(iWidth);var a=$(this).children("a");a.height(iWidth);var title=$(this).find("h3"),titleHeight=title.height(),offset=iWidth/2-titleHeight/2;title.css("paddingTop",offset+"px");var play=$(this).find(".play");if(play){var offset=iWidth/2-titleHeight/2;play.css("top",offset-45+"px")}}),$("[ab-ratio-resize]").each(function(index){var width=$(this).outerWidth(),sizes=($(this).height(),$(this).attr("ab-ratio-resize").split(":")),newHeight=sizes[1]*width;$(this).height(newHeight)})}),angular.module("alphaBuilder").filter("firstName",function(){return function(input,uppercase){input=input||"";var nameParts=input.split(" "),firstName=nameParts[0];return firstName}}),angular.module("alphaBuilder").directive("abAuthenticatedNav",["$location","authenticationSvc","courseSvc","contactSvc","getStartedSvc","translationSvc",function($location,authenticationSvc,courseSvc,contactSvc,getStartedSvc,translationSvc){return{restrict:"E",scope:{},templateUrl:"/templates/authenticatedNav/authenticatedNav.html",link:function(scope,element,attrs){scope.authSvc=authenticationSvc,scope.courseSvc=courseSvc,scope.contactSvc=contactSvc,scope.getStartedSvc=getStartedSvc,scope.translationSvc=translationSvc,scope.location=$location,scope.checkDisplayNav=function(){scope.authSvc.showNavigationBar="/get-started/authenticate"!=scope.location.path()&&scope.authSvc.isLoggedIn},scope.page=1,scope.loadMore=function(){courseSvc.loadMore&&courseSvc.loadMoreCourses(++scope.page)},scope.editAlpha=function(id){authenticationSvc.changeAlpha(id),$location.path("/update-alpha")},scope.$watch("location.path()",function(path){scope.checkDisplayNav()}),scope.$watch("authSvc.isLoggedIn",function(status){scope.checkDisplayNav()})}}}]),angular.module("alphaBuilder").controller("AuthenticationController",["$scope","$facebook","$http","$location","$modal","$timeout","authenticationSvc","getStartedSvc","courseSvc","organisationSvc","venueSvc","packageSvc","resizeTiles","translationSvc","gettextCatalog","crmSvc","$q","$window",function($scope,$facebook,$http,$location,$modal,$timeout,authenticationSvc,getStartedSvc,courseSvc,organisationSvc,venueSvc,packageSvc,resizeTiles,translationSvc,gettextCatalog,crmSvc,$q,$window){var that=this;"/get-started"==$location.path().substr(0,12)&&null==getStartedSvc.answers.chosenPackage&&$location.path("/"),this.authChanged=function(){$scope.step=7},this.changeProduct=function(){getStartedSvc.openModal(5)},this.packageSvc=packageSvc,this.packageChanged=function(){packageSvc.fetch(getStartedSvc.answers.chosenPackage,!0,1)},getStartedSvc.registerObserver(this),this.course=getStartedSvc.answers.course,this.authSvc=authenticationSvc,this.isRegistered=!1,this.networkActivity=!1,this.authSvc.registerObserver("authController",this),$scope.step=this.authSvc.isLoggedIn?7:6,$scope.$watch("step == 7",function(val){if(val&&courseSvc.fetchAllData(translationSvc.locale),7==$scope.step&&"/get-started"==$location.path().substr(0,12)&&!crmSvc.checkProfileComplete()){var defer=$q.defer();crmSvc.requestProfileUpdate(defer),defer.promise.then(function(){},function(){$window.history.back()})}}),this.networkActivity=!1,this.message={type:null,text:null},this.createAccount=function(profile,minimalSignup){this.networkActivity=!0,this.authSvc.register(profile,minimalSignup).then(function(data){that.isRegistered=!0,that.networkActivity=!1,that.message={type:"success",text:gettextCatalog.getString("Account created.")}},function(error){that.networkActivity=!1,that.message={type:"danger",text:gettextCatalog.getString("We could not create your account at this time, please try again or contact support.")}})},this.courseFailedMessage=null,this.courseFailedErrors=[],this.createCourse=function(course){courseSvc.create(course).then(function(newCourse){getStartedSvc.wipe(!0),that.courseFailedMessage=null,that.courseFailedErrors=[];$modal.open({templateUrl:"/templates/courses/new-course-modal.html",controller:"NewCourseController",controllerAs:"newCourseCtrl",windowClass:"modal-course-created",size:"lg",backdrop:"static",resolve:{course:function(){return newCourse}}})},function(data){that.courseFailedMessage=gettextCatalog.getString("Unable to create your course at this time, please try again or contact support"),that.courseFailedErrors=data.errors})},this.materialsOpen=!1,this.toggleMaterials=function(){this.materialsOpen=!this.materialsOpen,this.materialsOpen&&$timeout(function(){resizeTiles()})},this.selectLoginModalTab=function(){$("#tab-login").tab("show")},$(window).resize(function(){resizeTiles()})}]),angular.module("alphaBuilder").directive("abLogin",function(){return{restrict:"E",scope:{abBackgroundColor:"@",abLoginType:"@"},templateUrl:"/templates/authentication/login.html",controller:"LoginController",controllerAs:"loginCtrl"}}),angular.module("alphaBuilder").directive("abLoginModal",["$modal","$location",function($modal,$location){return{restrict:"E",template:'<a ng-click="login()" class="login-button" translate>Log in</a>',link:function(scope,element,attrs){scope.open=function(){scope.modalInstance=$modal.open({templateUrl:"/templates/authentication/login-modal.html",controller:["$scope","$modalInstance","authenticationSvc",function($scope,$modalInstance,authenticationSvc){$scope.close=function(){$modalInstance.dismiss()},authenticationSvc.registerObserver("onLoginModal",{authChanged:function(){$scope.close()}})}]})},scope.login=function(){},angular.element(document).ready(function(){angular.element(element).bind("click",function(){var shown=!1,homepageLogin=angular.element("#page-home .login-link");homepageLogin.size()>0&&(homepageLogin.trigger("click"),shown=!0);var getstartedLogin=angular.element("#page-authentication a.log-in");getstartedLogin.size()>0&&(getstartedLogin.trigger("click"),shown=!0),shown||scope.open()})})}}}]),angular.module("alphaBuilder").directive("abTermsAndConditions",function(){return{restrict:"E",templateUrl:"/templates/authentication/terms-and-conditions.html",controller:"TermsAndConditionsController",controllerAs:"termsAndConditionsCtrl"}}),angular.module("alphaBuilder").directive("toggleClass",function(){return{restrict:"A",link:function(scope,element,attrs){element.bind("click",function(){element.toggleClass(attrs.toggleClass)})}}}),angular.module("alphaBuilder").directive("abProfileForm",function(){return{restrict:"E",replace:!0,scope:{signup:"@",minimalSignup:"@",spinnerBackgroundColor:"@",spinnerZIndex:"@",networkActivity:"=",callback:"&submitCallback",submitLabel:"@",profile:"="},templateUrl:"/templates/authentication/profile-form.html",controller:"ProfileController",controllerAs:"profileCtrl"}}),angular.module("alphaBuilder").directive("abForgotPassword",["$modal",function($modal){return{restrict:"E",templateUrl:"/templates/authentication/forgot-password-button.html",scope:{email:"="},link:function(scope,element,attrs){scope.open=function(){$modal.open({templateUrl:"/templates/authentication/forgot-password-modal.html",controller:"ForgotPasswordController",controllerAs:"forgotPasswordCtrl",windowClass:"modal-forgot-password",size:"sm",resolve:{email:function(){return scope.email}}})}}}}]),angular.module("alphaBuilder").directive("abResendVerification",["$modal",function($modal){return{restrict:"E",templateUrl:"/templates/authentication/resend-verification-button.html",scope:{email:"="},link:function(scope,element,attrs){scope.open=function(){$modal.open({templateUrl:"/templates/authentication/resend-verification-modal.html",controller:"ResendVerificationController",controllerAs:"resendVerificationCtrl",windowClass:"modal-forgot-password",size:"sm",resolve:{email:function(){return scope.email}}})}}}}]),angular.module("alphaBuilder").directive("abVerifyEmail",["authenticationSvc",function(authenticationSvc){return{restrict:"E",templateUrl:"/templates/authentication/verify-email.html",scope:{},link:function(scope,element,attrs){scope.authSvc=authenticationSvc},controller:"ResendVerificationEmailController",controllerAs:"resendVerificationEmailCtrl"}}]),angular.module("alphaBuilder").directive("abConfirmClick",["dialogSvc",function(dialogSvc){return{restrict:"A",scope:{confirmFunction:"&abConfirmClick"},link:function(scope,element,attrs){element.bind("click",function(e){var message=attrs.abConfirmClickMessage?attrs.abConfirmClickMessage:"Are you sure?";dialogSvc.showModal({},{bodyText:message,headerText:!1,closeButtonText:"Stay on page",actionButtonText:"Leave"}).then(function(result){scope.confirmFunction()},function(){})})}}}]),angular.module("alphaBuilder").factory("authenticationSvc",["$http","$route","$q","$location","$timeout","tokenSvc","$rootScope","crmSvc","dateSvc","courseSvc","translationSvc","$modal",function($http,$route,$q,$location,$timeout,tokenSvc,$rootScope,crmSvc,dateSvc,courseSvc,translationSvc,$modal){var STORAGE_ID="alpha-builder-session-data",AUTH_BASE_URL="https://auth.alpha.org",myself={observers:{},networkActivity:!1,isAuthenticating:!1,isLoggedIn:!1,showNavigationBar:!1,verified:!1,canResendVerificationEmail:!0,navigationBarOpen:!1,userData:crmSvc.profile,sessionData:{},authorize:function(eventId){},validateEmail:function(email){var defer=$q.defer();if(this.networkActivity||this.isAuthenticating)return defer.reject(),defer.promise;var that=this;return $http.get(AUTH_BASE_URL+"/oauth2/validate/email/"+email).then(function(data){100==data.data.code?defer.resolve("Email is available"):defer.reject(data.data.code)},function(data){that.networkActivity=!1,defer.reject("Oops! Something went wrong.")}),defer.promise},checkVerificationResendEmail:function(){var object=JSON.parse(localStorage.getItem("resend-verification-"+this.userData.id));if(object){var now=new Date;now.getTime()<object.timestamp&&(this.canResendVerificationEmail=!1)}},login:function(username,password,type,path){var defer=$q.defer();if(this.networkActivity||this.isAuthenticating)return defer.reject(),defer.promise;this.clear(),crmSvc.wipeProfile(!1),courseSvc.clear(),this.networkActivity=!0,this.isAuthenticating=!0;var data={username:username,password:password},that=this;return $http.post("/api/auth/"+translationSvc.locale+"/login",data).then(function(data){tokenSvc.verifyToken(data.data.access_token,!0).then(function(data){crmSvc.fetchProfile().then(function(data){1==type?($location.path("/"),window.scrollTo(0,0)):2==type?($location.path(path),window.scrollTo(0,0)):3==type||$location.path("/get-started/authenticate"),that.isAuthenticating=!1,that.networkActivity=!1,defer.resolve()},function(){that.isAuthenticating=!1,that.networkActivity=!1,defer.reject()})},function(data){that.isAuthenticating=!1,that.networkActivity=!1,defer.reject(data)})},function(response){that.networkActivity=!1,that.isAuthenticating=!1,defer.reject(response.data.error.code)}),defer.promise},registerMinimal:function(defer){return modalInstance=$modal.open({templateUrl:"/templates/authentication/profile-minimal-modal.html",controller:"AuthenticationController",controllerAs:"authCtrl",windowClass:"modal-profile-minimal",size:"sm",backdrop:"static",resolve:{profile:function(){return[]}}}),this.registerObserver("onRegisterMinimalModal",{authChanged:function(){modalInstance.close()}}),modalInstance.result},register:function(data,minimalSignup){data=angular.copy(data),1!=minimalSignup&&(data.dateOfBirth=dateSvc.dateToString(data.dateOfBirth,"YYYY-MM-DDT00:00:00+0000")),data.minimalSignup=minimalSignup,delete data.id;var defer=$q.defer();if(this.networkActivity||this.isAuthenticating)return defer.reject(),defer.promise;this.clear(),this.networkActivity=!0,this.isAuthenticating=!0;var that=this;return $http.post("/api/auth/"+translationSvc.locale+"/register",data).then(function(data){tokenSvc.verifyToken(data.data.access_token).then(function(data){crmSvc.fetchProfile().then(function(data){minimalSignup||$location.path("/get-started/authenticate"),that.isAuthenticating=!1,that.networkActivity=!1,defer.resolve()},function(){that.isAuthenticating=!1,that.networkActivity=!1,defer.reject()})},function(data){that.isAuthenticating=!1,that.networkActivity=!1,defer.reject()})},function(data){that.networkActivity=!1,that.isAuthenticating=!1,defer.reject()}),defer.promise},logout:function(){this.clear(),tokenSvc.logout(),crmSvc.wipeProfile(!0),courseSvc.clear()},checkLoggedIn:function(){var before=this.isLoggedIn;tokenSvc.session.authenticated?this.isLoggedIn=!0:this.isLoggedIn=!1,before!=this.isLoggedIn&&(this.isLoggedIn&&courseSvc.restore(!0),this.notifyObservers())},sessionChanged:function(){crmSvc.restoreProfile()},profileChanged:function(){this.userData=crmSvc.profile,this.checkLoggedIn()},resetPassword:function(email){var defer=$q.defer();if(this.networkActivity)return defer.reject(),defer.promise;this.networkActivity=!0;var data={email:email},that=this;return $http.post("/api/auth/"+translationSvc.locale+"/reset-password",data).then(function(data){that.networkActivity=!1,defer.resolve()},function(data){that.networkActivity=!1,defer.reject()}),defer.promise},resendVerification:function(email){var defer=$q.defer();if(this.networkActivity)return defer.reject(),defer.promise;this.networkActivity=!0;var data={email:email},that=this;return $http.post("/api/auth/"+translationSvc.locale+"/resend-verification",data).then(function(data){that.networkActivity=!1,defer.resolve()},function(data){that.networkActivity=!1,defer.reject()}),defer.promise},registerObserver:function(key,callback){this.observers[key]=callback},notifyObservers:function(){_.forEach(this.observers,function(observer,key){void 0!==observer&&observer.hasOwnProperty("authChanged")&&observer.authChanged()})},removeObserver:function(key){this.observers[key]=void 0},coursesChanged:function(){var that=this;$timeout(function(){that.sessionData.currentAlpha?that.changeAlpha(that.sessionData.currentAlpha.id):that.changeAlpha(_.last(courseSvc.courses).id)})},changeAlpha:function(newId){var newCourse=_.find(courseSvc.courses,{id:newId});newCourse&&(this.sessionData.currentAlpha=newCourse),this.navigationBarOpen=!1,this.save(),this.notifyObservers()},save:function(){localStorage.setItem(STORAGE_ID,JSON.stringify(this.sessionData))},restore:function(){this.checkVerificationResendEmail();var localData=localStorage.getItem(STORAGE_ID)||null;if(localData&&"undefined"!==localData){var data=JSON.parse(localData);return this.sessionData=data,this.notifyObservers(),!0}return!1},clear:function(notify){this.sessionData={},this.save(),notify&&this.notifyObservers()},performAuthCheck:function(){this.isLoggedIn||$location.path("/")},performCurrentAlphaCheck:function(){this.sessionData.hasOwnProperty("currentAlpha")||$location.path("/")}};return myself.restore(),courseSvc.registerObserver("authSvc",myself),tokenSvc.registerObserver(myself),crmSvc.registerObserver(myself),tokenSvc.restoreSession(),myself}]),angular.module("alphaBuilder").factory("crmSvc",["$http","$location","$q","$modal","tokenSvc","dateSvc","translationSvc",function($http,$location,$q,$modal,tokenSvc,dateSvc,translationSvc){var STORAGE_ID="alpha-builder-profile",modalInstance=null,REGENT_API_BASE_URL="https://regent-api.alpha.org";return{observers:[],networkActivity:!1,profile:{id:null,firstName:null,lastName:null,dateOfBirth:null,gender:null,address:null,email:null,unsubscribed:!0},fetchProfile:function(force){force="undefined"!=typeof force?force:!1;var defer=$q.defer();if(!force&&this.restoreProfile())return defer.resolve(this.profile),defer.promise;if(this.networkActivity)return defer.reject(),defer.promise;this.networkActivity=!0;var that=this;return $http.get(REGENT_API_BASE_URL+"/2/me",{headers:{Authorization:"Bearer "+tokenSvc.session.token}}).then(function(response){that.cleanProfile(response);that.notifyObservers(),that.saveProfile(),that.networkActivity=!1,defer.resolve(that.profile)},function(data){that.networkActivity=!1,404==data.status?that.requestProfileUpdate(defer):defer.reject()}),defer.promise},cleanProfile:function(response){var profile=response.data.individual,newProfile={};return newProfile.id=profile.id,newProfile.firstName=profile.firstName,newProfile.lastName=profile.lastName,newProfile.dateOfBirth=profile.dateOfBirth?dateSvc.stringToDate(profile.dateOfBirth,"YYYY-MM-DD"):null,newProfile.gender=profile.gender,newProfile.email=profile.primaryEmail,newProfile.address=profile.primaryAddress,newProfile.unsubscribed=profile.unsubscribed,_.isPlainObject(newProfile.address)&&newProfile.address.hasOwnProperty("countryCode")&&(newProfile.address.country=newProfile.address.countryCode,delete newProfile.address.countryCode),newProfile.email||(newProfile.email=tokenSvc.session.username),angular.copy(newProfile,this.profile),newProfile},updateProfile:function(data){if(data=angular.copy(data),data.dateOfBirth&&(data.dateOfBirth=dateSvc.dateToString(data.dateOfBirth,"YYYY-MM-DDT00:00:00+0000")),data.email&&delete data.email,data.password&&delete data.password,data.email||(data.email=tokenSvc.session.username),null==data.id)return this.createProfile(data);var defer=$q.defer();if(this.networkActivity)return defer.reject(),defer.promise;this.networkActivity=!0;var that=this;return $http.put("/api/auth/"+translationSvc.locale+"/update-profile",data,{headers:{Authorization:"Bearer "+tokenSvc.session.token}}).then(function(response){that.cleanProfile(response),that.saveProfile(),that.networkActivity=!1,defer.resolve(that.profile)},function(data){that.networkActivity=!1,defer.reject()}),defer.promise},createProfile:function(data){var defer=$q.defer();this.networkActivity=!0;var that=this;return $http.post("/api/auth/"+translationSvc.locale+"/create-profile",data,{headers:{Authorization:"Bearer "+tokenSvc.session.token}}).then(function(response){that.cleanProfile(response),that.notifyObservers(),that.saveProfile(),that.networkActivity=!1,defer.resolve(that.profile)},function(data){that.networkActivity=!1,defer.reject()}),defer.promise},saveProfile:function(){localStorage.setItem(STORAGE_ID,JSON.stringify(this.profile))},restoreProfile:function(){var localData=localStorage.getItem(STORAGE_ID)||null;if(localData){var data=JSON.parse(localData);return void 0===data.id||null===data.id?!1:(this.profile.id=data.id,this.profile.firstName=data.firstName,this.profile.lastName=data.lastName,this.profile.dateOfBirth=new Date(data.dateOfBirth),this.profile.gender=data.gender,this.profile.email=data.email,this.profile.address=data.address,this.profile.unsubscribed=data.unsubscribed,this.notifyObservers(),!0)}return!1},wipeProfile:function(notify){this.profile.id=null,this.profile.title=null,this.profile.firstName=null,this.profile.lastName=null,this.profile.dateOfBirth=null,this.profile.gender=null,this.profile.address=null,this.profile.email=null,this.profile.unsubscribed=!0,this.saveProfile(),notify&&this.notifyObservers()},checkProfileComplete:function(){return null==this.profile.id||null==this.profile.firstName||null==this.profile.lastName||null==this.profile.dateOfBirth||null==this.profile.gender||null==this.profile.address||null==this.profile.address.county||null==this.profile.address.country?!1:!0},requestProfileUpdate:function(defer,data){modalInstance=$modal.open({templateUrl:"/templates/authentication/profile-update-modal.html",controller:"ProfileUpdateController",controllerAs:"profileCtrl",windowClass:"modal-profile-update",keyboard:!1,size:"sm",backdrop:"static",resolve:{profile:function(){return data}}});var that=this;modalInstance.result.then(function(data){that.notifyObservers(),defer&&defer.resolve(data)},function(){defer&&defer.reject()})},registerObserver:function(callback){this.observers.push(callback)},notifyObservers:function(){var i=0,num=this.observers.length;for(i;num>i;i++)this.observers[i].profileChanged()}}}]),angular.module("alphaBuilder").factory("dateSvc",function(){return{pad:function(n,width,z){return z=z||"0",n+="",n.length>=width?n:new Array(width-n.length+1).join(z)+n},stringToDate:function(str,format){var days=parseInt(str.substr(format.indexOf("DD"),2)),months=parseInt(str.substr(format.indexOf("MM"),2))-1,years=parseInt(str.substr(format.indexOf("YYYY"),4)),hours=-1!=format.indexOf("hh")?parseInt(str.substr(format.indexOf("hh"),2)):0,minutes=-1!=format.indexOf("hh")?parseInt(str.substr(format.indexOf("mm"),2)):0,seconds=-1!=format.indexOf("ss")?parseInt(str.substr(format.indexOf("ss"),2)):0;return new Date(years,months,days,hours,minutes,seconds)},standardizeFormat:function(format){var parts=format.split("/"),separator="/";1==parts.length&&(parts=parts[0].split("."),separator="."),1==parts.length&&(parts=parts[0].split("-"),separator="-"),1==parts.length&&(parts=parts[0].split(" "),separator=" ");var newParts=_.map(parts,function(n){return"d"==n||"dd"==n?"DD":"M"==n||"MM"==n||"MMM"==n||"MMMM"==n?"MM":"y"==n||"yy"==n||"yyyy"==n?"YYYY":void 0});return newParts.join("")},angularDateToString:function(date,format){var universalFormat=this.standardizeFormat(format);return this.dateToString(date,universalFormat)},angularStringToDate:function(str,format){var universalFormat=this.standardizeFormat(format);return this.stringToDate(str,universalFormat)},stringToTime:function(str,format){var hours=-1!=format.indexOf("hh")?str.substr(format.indexOf("hh"),2):"00",minutes=-1!=format.indexOf("hh")?str.substr(format.indexOf("mm"),2):"00";return hours+""+minutes},dateToString:function(date,format){var str=format;return str=str.replace("YYYY",this.pad(date.getFullYear(),4)),str=str.replace("MM",this.pad(date.getMonth()+1,2)),str=str.replace("DD",this.pad(date.getDate(),2))},combineDateTimeStringToDate:function(date,str,format){var hours=-1!=format.indexOf("hh")?parseInt(str.substr(format.indexOf("hh"),2)):0,minutes=-1!=format.indexOf("hh")?parseInt(str.substr(format.indexOf("mm"),2)):0;return date.setHours(hours),date.setMinutes(minutes),date},dateToAPIFriendlyString:function(date){return date.toLocalISOString().substr(0,17)+"00+0000"},nowUTC:function(){var now=new Date;return new Date(Date.UTC(now.getFullYear(),now.getMonth(),now.getDate(),now.getHours(),now.getMinutes(),now.getSeconds(),now.getMilliseconds()))}}}),Date.prototype.toLocalISOString||!function(){function pad(number){return 10>number?"0"+number:number}Date.prototype.toLocalISOString=function(){return this.getFullYear()+"-"+pad(this.getMonth()+1)+"-"+pad(this.getDate())+"T"+pad(this.getHours())+":"+pad(this.getMinutes())+":"+pad(this.getSeconds())+"."+(this.getMilliseconds()/1e3).toFixed(3).slice(2,5)+"Z"}}(),angular.module("alphaBuilder").controller("ForgotPasswordController",["$scope","$modalInstance","authenticationSvc","email","gettextCatalog",function($scope,$modalInstance,authenticationSvc,email,gettextCatalog){this.email=email,this.resetting=!1,this.errorMessage=null,this.success=!1,this.close=function(){$modalInstance.close("done")},this.reset=function(){this.resetting=!0;var that=this;authenticationSvc.resetPassword(this.email).then(function(data){that.errorMessage=null,that.resetting=!1,that.success=!0},function(data){that.errorMessage=gettextCatalog.getString("We could not reset your password, do you have an account?"),that.resetting=!1})}}]),angular.module("alphaBuilder").controller("LoginController",["$scope","authenticationSvc",function($scope,authenticationSvc){this.authSvc=authenticationSvc,this.errorCode=null,this.username=null,this.password=null,this.type=null,this.login=function(type){var that=this;authenticationSvc.login(this.username,this.password,type).then(function(){that.errorMessage=null},function(errorCode){that.errorCode=errorCode})}}]),angular.module("alphaBuilder").controller("LogoutController",["$scope","$location","authenticationSvc",function($scope,$location,authenticationSvc){authenticationSvc.logout(),$location.path("/")}]),angular.module("alphaBuilder").controller("MyAccountController",["$scope","$location","authenticationSvc","crmSvc","gettextCatalog",function($scope,$location,authenticationSvc,crmSvc,gettextCatalog){authenticationSvc.performAuthCheck(),this.message={type:null,text:null},this.networkActivity=!1,authenticationSvc.isLoggedIn||$location.path("/"),this.submit=function(profile){this.networkActivity=!0;var that=this;crmSvc.updateProfile(profile).then(function(data){that.message={type:"success",text:gettextCatalog.getString("Your account was updated.")},that.networkActivity=!1},function(error){that.message={type:"danger",text:gettextCatalog.getString("We could not update your account at this time, please try again or contact support.")},that.networkActivity=!1})}}]),angular.module("alphaBuilder").controller("ProfileController",["$scope","$facebook","$timeout","$locale","commonSvc","crmSvc","dateSvc","getStartedSvc","authenticationSvc","gettextCatalog","$http","translationSvc",function($scope,$facebook,$timeout,$locale,commonSvc,crmSvc,dateSvc,getStartedSvc,authenticationSvc,gettextCatalog,$http,translationSvc){var DEFAULT_TERMS_AND_CONDITIONS="http://alpha.org/Disclaimer_Privacy_Policy",that=this;if(this.authSvc=authenticationSvc,this.commonSvc=commonSvc,this.isFacebookLoggedIn=!1,this.networkActivity=!1,this.counties={},this.profile={firstName:null,lastName:null,subscribe:!1,dateOfBirth:null,gender:null,country:null,county:null,email:null,password:null,id:null},this.termsAndConditions=!1,this.emailError=null,$http.post("/api/auth/"+translationSvc.locale+"/terms-and-conditions-locale",{locale:translationSvc.locale}).then(function(dataTermsAndConditions){$scope.termsAndConditionsUrl=dataTermsAndConditions.data.url?dataTermsAndConditions.data.url:DEFAULT_TERMS_AND_CONDITIONS}),this.dateOfBirthFormat=dateSvc.standardizeFormat($locale.DATETIME_FORMATS.shortDate),this.fetchProfileFromCRM=function(){if(authenticationSvc.isLoggedIn){var profile=crmSvc.profile;this.profile.id=profile.id,this.profile.firstName=profile.firstName,this.profile.lastName=profile.lastName,this.profile.subscribe=!profile.unsubscribed,this.profile.dateOfBirth=profile.dateOfBirth?dateSvc.angularDateToString(profile.dateOfBirth,$locale.DATETIME_FORMATS.shortDate):null,this.profile.gender=profile.gender,this.profile.email=profile.email,profile.address&&(this.profile.country=profile.address.country?profile.address.country:null,this.profile.county=profile.address.county?profile.address.county:null)}},this.fetchProfileFromCRM(),$scope.profile){var profile=$scope.profile;this.profile.id=profile.id,this.profile.firstName=profile.firstName,this.profile.lastName=profile.lastName,this.profile.subscribe=!profile.unsubscribed,this.profile.dateOfBirth=profile.dateOfBirth?dateSvc.angularDateToString(profile.dateOfBirth,$locale.DATETIME_FORMATS.shortDate):null,this.profile.gender=profile.gender,this.profile.email=profile.email,profile.address&&(this.profile.country=profile.address.country?profile.address.country:null,this.profile.county=profile.address.county?profile.address.county:null)}if($scope.$on("abLocaleChanged",function(event,params){that.fetchProfileFromCRM(),$scope.profile&&(that.profile.dateOfBirth=profile.dateOfBirth?dateSvc.angularDateToString(profile.dateOfBirth,$locale.DATETIME_FORMATS.shortDate):null),that.dateOfBirthFormat=dateSvc.standardizeFormat($locale.DATETIME_FORMATS.shortDate)}),!this.profile.firstName&&(getStartedSvc.restoreResult(),
null!==getStartedSvc.answers.name)){var parts=getStartedSvc.answers.name.split(" ");this.profile.firstName=parts[0],parts.shift(),this.profile.lastName=parts.join(" ")}this.facebookLogin=function(){this.networkActivity=!0;var that=this;$facebook.login().then(function(){that.facebookRefresh()},function(){that.networkActivity=!1})},this.facebookRefresh=function(){var that=this;$facebook.api("/me").then(function(data){that.profile.firstName=data.first_name,that.profile.lastName=data.last_name,that.profile.email=data.email,that.profile.gender="male"==data.gender?"M":"F",that.isFacebookLoggedIn=!0,that.networkActivity=!1},function(err){that.networkActivity=!1})},this.submit=function(){var myEl=angular.element(document.querySelector("#emailErrorMessage")),emailText=angular.element(document.querySelector("#email"));if($.trim(myEl.text()).length>0)emailText.focus();else{var profile=angular.copy(this.profile);profile.unsubscribed=!0,"true"!=$scope.minimalSignup&&(profile.dateOfBirth=dateSvc.angularStringToDate(profile.dateOfBirth,$locale.DATETIME_FORMATS.shortDate)),delete profile.subscribe,$scope.callback({profile:profile})}},this.toggleSubscribe=function(){this.profile.subscribe=!this.profile.subscribe},this.toggleTermsAndConditions=function(){this.termsAndConditions=!this.termsAndConditions},this.genders=[{key:"M",label:gettextCatalog.getString("Male")},{key:"F",label:gettextCatalog.getString("Female")}],this.countryChanged=function(){var that=this;$timeout(function(){that.fetchCounties()})},this.commonSvc.fetchCountries(),this.fetchCounties=function(){this.networkActivity=!0,this.profile.country||(this.networkActivity=!1);var that=this;this.commonSvc.fetchCounties(this.profile.country).then(function(counties){that.counties=counties,that.networkActivity=!1},function(error){that.networkActivity=!1})},this.profile.country&&this.fetchCounties(),this.validateEmail=function($event){var that=this,e=angular.element(document.querySelector("#email"));authenticationSvc.validateEmail($event.currentTarget.value).then(function(msg){that.emailError=null,e.hasClass("invalid")&&e.removeClass("invalid")},function(code){that.emailError=code,e.addClass("invalid")})}}]),angular.module("alphaBuilder").controller("ProfileUpdateController",["$scope","$modalInstance","crmSvc","profile","gettextCatalog",function($scope,$modalInstance,crmSvc,profile,gettextCatalog){this.message={type:null,text:null},this.networkActivity=!1,this.profile=profile,this.submit=function(profile){this.networkActivity=!0;var that=this;crmSvc.updateProfile(profile).then(function(data){that.message={type:"success",text:gettextCatalog.getString("Your account was updated.")},that.networkActivity=!1,$modalInstance.close(data)},function(error){that.message={type:"danger",text:gettextCatalog.getString("We could not update your account at this time, please try again or contact support.")},that.networkActivity=!1})}}]),angular.module("alphaBuilder").controller("ResendVerificationController",["$scope","$modalInstance","authenticationSvc","email","gettextCatalog",function($scope,$modalInstance,authenticationSvc,email,gettextCatalog){this.email=email,this.resetting=!1,this.errorMessage=null,this.success=!1,this.close=function(){$modalInstance.close("done")},this.reset=function(){this.resetting=!0;var that=this;authenticationSvc.resendVerification(this.email).then(function(data){that.errorMessage=null,that.resetting=!1,that.success=!0},function(data){that.errorMessage=gettextCatalog.getString("We could not resend your verification email, we can only send it once every 24 hours."),that.resetting=!1})}}]),angular.module("alphaBuilder").controller("ResendVerificationEmailController",["$scope","authenticationSvc",function($scope,authenticationSvc){this.email=authenticationSvc.userData.email,this.resetting=!1,this.errorMessage=null,this.success=!1,this.reset=function(){authenticationSvc.resendVerification(this.email)["finally"](function(data){var date=new Date;date.setDate(date.getDate()+1);var object={timestamp:date.getTime()};localStorage.setItem("resend-verification-"+authenticationSvc.userData.id,JSON.stringify(object)),this.resetting=!0,authenticationSvc.canResendVerificationEmail=!1})}}]),angular.module("alphaBuilder").controller("TermsAndConditionsController",["$scope","translationSvc","$http","crmSvc","authenticationSvc","$modal","$location",function($scope,translationSvc,$http,crmSvc,authenticationSvc,$modal,$location){var DEFAULT_TERMS_AND_CONDITIONS="http://alpha.org/Disclaimer_Privacy_Policy",that=this;this.authSvc=authenticationSvc,this.termsAndConditions=!1,this.authSvc.registerObserver("tcController",this),this.authChanged=function(){if(authenticationSvc.removeObserver("tcController"),authenticationSvc.isLoggedIn){var profile=crmSvc.profile;$http.post("/api/auth/"+translationSvc.locale+"/terms-and-conditions",{username:profile.email}).then(function(dataTermsAndConditions){dataTermsAndConditions.data.tcAgreed===!1&&$scope.open()})}},$scope.open=function(){var modalInstance=$modal.open({templateUrl:"/templates/authentication/terms-and-conditions.html",controller:["$scope","$modalInstance","crmSvc",function($scope,$modalInstance,crmSvc){var profile=crmSvc.profile;$http.post("/api/auth/"+translationSvc.locale+"/terms-and-conditions-locale",{locale:translationSvc.locale}).then(function(dataTermsAndConditions){$scope.termsAndConditionsUrl=dataTermsAndConditions.data.url?dataTermsAndConditions.data.url:DEFAULT_TERMS_AND_CONDITIONS}),$scope.agreeTermsAndConditions=function(){$http.post("/api/auth/"+translationSvc.locale+"/agree-terms-and-conditions",{username:profile.email,tcLocale:translationSvc.locale}).then(function(dataTermsAndConditions){}),modalInstance.dismiss()},"/"===$location.path()?$scope.toggleClass=function(val){$scope.termsAndConditions=!val}:$scope.toggleClass=function(val){that.termsAndConditions=!val}}],size:"lg",backdrop:"static",keyboard:!1})}}]),angular.module("alphaBuilder").factory("tokenSvc",["$http","$interval","$q",function($http,$interval,$q){var STORAGE_ID="alpha-builder-session",sessionWatch=void 0,AUTH_BASE_URL="https://auth.alpha.org";return{observers:[],networkActivity:!1,session:{token:null,expiresAt:null,userId:null,username:null,roles:[],countries:[],expiresIn:0,authenticated:!1},verifyToken:function(token,checkVerification){var defer=$q.defer();if(this.networkActivity)return defer.reject(),defer.promise;this.networkActivity=!0;var that=this;return $http.get(AUTH_BASE_URL+"/oauth2/verify-token?token="+token).then(function(data){checkVerification&&"undefined"!=typeof data.data.verification&&!data.data.verification?(that.networkActivity=!1,defer.reject(901)):(that.session.countries=data.data.countries,that.session.roles=data.data.roles,that.session.userId=data.data.user_id,that.session.username=data.data.username,that.session.expiresAt=data.data.expires_at,that.session.token=token,that.calculateExpiresIn(),that.startWatchingSession(),that.saveSession(),that.networkActivity=!1,defer.resolve())},function(data){that.networkActivity=!1,defer.reject()}),defer.promise},startWatchingSession:function(){var that=this,check=function(){that.calculateExpiresIn(),that.session.expiresIn<=0?that.logout():that.session.authenticated||(that.session.authenticated=!0,that.notifyObservers())};sessionWatch=$interval(check(),1e3)},stopWatchingSession:function(){angular.isDefined(sessionWatch)&&($interval.cancel(sessionWatch),sessionWatch=void 0)},saveSession:function(){localStorage.setItem(STORAGE_ID,JSON.stringify(this.session))},restoreSession:function(){var localData=localStorage.getItem(STORAGE_ID)||null;if(localData){var data=JSON.parse(localData);this.session.token=data.token,this.session.countries=data.countries,this.session.roles=data.roles,this.session.userId=data.userId,this.session.username=data.username,this.session.expiresAt=data.expiresAt,this.session.authenticated=!1,this.calculateExpiresIn(),this.startWatchingSession()}return this.session},calculateExpiresIn:function(){if(this.session.expiresAt){var expiresAt=new Date(this.session.expiresAt),now=new Date,timeDiff=Math.floor((expiresAt.getTime()-now.getTime())/1e3);timeDiff>0?this.session.expiresIn=timeDiff:this.logout()}},logout:function(){this.session.expiresIn=0,this.session.username=null,this.session.roles=[],this.session.countries=[],this.session.token=null,this.session.expiresAt=null,this.session.userId=null,this.session.authenticated=!1,this.stopWatchingSession(),this.saveSession(),this.notifyObservers()},registerObserver:function(callback){this.observers.push(callback)},notifyObservers:function(){var i=0,num=this.observers.length;for(i;num>i;i++)this.observers[i].sessionChanged()}}}]),angular.module("alphaBuilder").directive("abCoachingHeaderSlider",["$modal","$timeout","$location","authenticationSvc","courseSvc","delayedActionSvc","coachingNotificationSvc",function($modal,$timeout,$location,authenticationSvc,courseSvc,delayedActionSvc,coachingNotificationSvc){return{restrict:"E",templateUrl:"/templates/coaching/coaching-header-slider.html",link:function(scope,elem,attr){scope.promote=function(){var promoteModalInstance=$modal.open({templateUrl:"/templates/promote/publish-alpha-modal.html",controller:"PublishAlphaController",controllerAs:"publishAlphaCtrl",windowClass:"modal-promote-alpha",size:"sm"});promoteModalInstance.result["finally"](function(){if(authenticationSvc.isLoggedIn){var currentAlpha=authenticationSvc.sessionData.currentAlpha;courseSvc.hasCompletedTask(currentAlpha,"promote")||courseSvc.completeTask(currentAlpha,"promote")}})},scope.performDelayedAction=function(path,anchor,sessionUUID){$location.path()==path?delayedActionSvc.performActionNow(anchor,sessionUUID):(delayedActionSvc.addDelayedAction(anchor,sessionUUID),$timeout(function(){$location.path(path)}))},$timeout(function(){function setupSessionSlider(){beltItems=$("#coaching-header-slider .belt > div:visible"),containerWidth=$("#coaching-header-slider").width(),num=beltItems.length,itemWidth=beltItems.first().width(),beltWidth=num*itemWidth,$("#coaching-header-slider .belt").width(beltWidth)}function handleStart(event){for(var touches=event.changedTouches,i=0;i<touches.length;i++)0==i&&(lastPosition=event.changedTouches[i].pageX)}function handleMove(event){for(var touches=event.changedTouches,i=0;i<touches.length;i++)if(0==i){var nowPosition=event.changedTouches[i].pageX;totalMovement+=nowPosition-lastPosition,lastPosition=nowPosition}}function handleEnd(event){var newIndex=void 0;Math.abs(totalMovement)>60&&(0>totalMovement&&num>currentIndex+1?newIndex=currentIndex+1:totalMovement>0&&0!==currentIndex&&(newIndex=currentIndex-1)),void 0!==newIndex&&moveToIndex(newIndex,!0),totalMovement=0}function handleCancel(event){for(var touches=event.changedTouches,i=0;i<touches.length;i++)ongoingTouches.splice(i,1)}function addTouchListeners(){beltElement.addEventListener("touchstart",handleStart,!1),beltElement.addEventListener("touchend",handleEnd,!1),beltElement.addEventListener("touchcancel",handleCancel,!1),beltElement.addEventListener("touchleave",handleEnd,!1),beltElement.addEventListener("touchmove",handleMove,!1)}function calculateOffsetToMakeIndexCenter(index){var center=containerWidth/2,centerOffset=center-itemWidth/2,offset=centerOffset-index*itemWidth;return"none"!=$("a.arrow").css("display")&&(offset-=56),offset}function adjustOffset(){containerWidth=$("#coaching-header-slider").width();var newOffset=calculateOffsetToMakeIndexCenter(currentIndex);$("#coaching-header-slider .belt").css("left",newOffset+"px")}function moveToIndex(index,animated){var item=$("#coaching-header-slider .belt > div:visible").eq(index);moveToItem(getItemClass(item),animated)}function indexFromItemName(itemName){var item=$("#coaching-header-slider .belt").find("."+itemName),index=$("#coaching-header-slider .belt > div:visible").index(item);return index}function moveToItem(itemName,animated){$("#coaching-header-slider .belt > div.active").removeClass("active"),currentIndex=indexFromItemName(itemName);var newOffset=calculateOffsetToMakeIndexCenter(currentIndex);animated?(animating=!0,$("#coaching-header-slider .belt").animate({left:newOffset},500,function(){animating=!1,$("#coaching-header-slider .belt").find("."+itemName).addClass("active")})):($("#coaching-header-slider .belt").css("left",newOffset+"px"),$("#coaching-header-slider .belt").find("."+itemName).addClass("active"))}function getItemClass(item){var classList=item.attr("class").split(/\s+/),itemName=void 0;return $.each(classList,function(index,item){"item"!==item&&"active"!==item&&"odd"!==item&&"even"!==item&&(itemName=item)}),itemName}function resetToSlides(slides){$("#coaching-header-slider .belt > div").hide(),$.each(slides,function(key,value){$("#coaching-header-slider").find("."+value).show()}),beltItems=$("#coaching-header-slider .belt > div:visible"),num=beltItems.length,itemWidth=beltItems.first().width(),beltWidth=num*itemWidth,$("#coaching-header-slider .belt").width(beltWidth);var firstVisibleItem=getItemClass($("#coaching-header-slider .belt > div:visible:first"));moveToItem(firstVisibleItem,!1)}var beltItems=0,num=0,itemWidth=0,beltWidth=0,containerWidth=0,animating=!1,currentIndex=0,beltElement=$("#coaching-header-slider .belt")[0],lastPosition=void 0,totalMovement=0;setupSessionSlider(),addTouchListeners(),$(window).resize(function(){adjustOffset()}),$("#coaching-header-slider .arrow").click(function(event){if(!animating&&!$(this).hasClass("disabled")){var next,current=$("div.active:first",$(this).parent()),forward=$(this).hasClass("forwards");do{if(next=forward?current.next():current.prev(),0==next.size()){next=!1;break}next.is(":visible")||(current=next,next=!1)}while(!next);if(next&&next.size()>0){var itemName=getItemClass(next);moveToItem(itemName,!0)}}});var lastActive;$("#coaching-header-slider .icon").hover(function(event){lastActive=$("div.active:first","#coaching-header-slider");var parent=$(this).parents("div:first");parent.is(lastActive)?lastActive=null:($("div.active","#coaching-header-slider").removeClass("active"),parent.addClass("active"))},function(out){lastActive&&($("div.active","#coaching-header-slider").removeClass("active"),lastActive.addClass("active"))});var currentAlpha=authenticationSvc.sessionData.currentAlpha,tasks=["schedule","promote","prepared","shared","trained"],remainingTasks=_.xor(tasks,currentAlpha.tasks);resetToSlides(remainingTasks);var listener={coursesChanged:function(){var currentAlpha=authenticationSvc.sessionData.currentAlpha,remainingTasks=_.xor(tasks,currentAlpha.tasks);resetToSlides(remainingTasks)},authChanged:function(){var currentAlpha=authenticationSvc.sessionData.currentAlpha,remainingTasks=_.xor(tasks,currentAlpha.tasks);resetToSlides(remainingTasks)}};courseSvc.registerObserver("coachingDirective",listener),authenticationSvc.registerObserver("coachingDirective",listener),scope.$on("$destroy",function(){courseSvc.removeObserver("coachingDirective"),authenticationSvc.removeObserver("coachingDirective")})})}}}]),angular.module("alphaBuilder").factory("coachingNotificationSvc",["$modal","dateSvc","gettextCatalog",function($modal,dateSvc,gettextCatalog){function Session(UUID,title,start){this.UUID=UUID,this.title=title,this.start=start,this.startDate=dateSvc.stringToDate(start,"YYYY-MM-DDThh:mm:ss"),this.startTime=dateSvc.stringToTime(start,"YYYY-MM-DDThh:mm:ss"),this.iconTitle=void 0,this.preTitle=void 0,this.description=void 0,this.type=void 0,this.products=[],this.enabled=!1,this.pickerOpen=!1,this.editable=!1,this.num=0}return Session.prototype.calculateTitle=function(counter){switch(this.UUID[0]){case"S":counter.s++,this.num=counter.s,this.iconTitle=counter.s,this.preTitle=gettextCatalog.getString("Session")+" "+counter.s,this.editable=!0,this.type="standard";break;case"W":counter.w++,this.num=counter.w,this.iconTitle=gettextCatalog.getString("W")+counter.w,this.preTitle=gettextCatalog.getString("Weekend Session")+" "+counter.w,this.editable=!0,this.type="weekend";break;case"T":counter.t++,this.num=counter.t,this.iconTitle=gettextCatalog.getString("T")+counter.t,this.preTitle=gettextCatalog.getString("Training")+" "+counter.t,this.editable=!0,this.enabled=!0,this.type="training";break;case"P":this.iconTitle=gettextCatalog.getString("G"),this.preTitle=gettextCatalog.getString("Get Trained"),this.enabled=!0,this.type="preparation";break;case"A":this.iconTitle=gettextCatalog.getString("A"),this.preTitle=gettextCatalog.getString("After Alpha"),this.enabled=!0,this.type="after"}return this},Session.prototype.setProducts=function(products){return this.products=products,this},Session.prototype.unlock=function(courseEndDate,areSessionsUnlocked){switch(areSessionsUnlocked&&new Date<courseEndDate&&(this.enabled=!0),this.UUID[0]){case"T":this.enabled=!0;break;case"P":this.enabled=!0;break;case"A":this.enabled=!0}return this},{completedTasks:function(course){var completedTasks={download:!1,schedule:!1,promote:!1,prepared:!1,shared:!1,trained:!1};if(_.has(course,"tasks")){var tasks=course.tasks;-1!==_.indexOf(tasks,"download")&&(completedTasks.download=!0),-1!==_.indexOf(tasks,"schedule")&&(completedTasks.schedule=!0),(-1!==_.indexOf(tasks,"promote")||_.has(course,"published")&&course.published===!0)&&(completedTasks.promote=!0),-1!==_.indexOf(tasks,"prepared")&&(completedTasks.prepared=!0),-1!==_.indexOf(tasks,"shared")&&(completedTasks.shared=!0),-1!==_.indexOf(tasks,"trained")&&(completedTasks.trained=!0)}return completedTasks},progressPercentage:function(completedTasks){var percentage=0;return completedTasks.download&&(percentage+=16.6),completedTasks.schedule&&(percentage+=16.6),completedTasks.promote&&(percentage+=16.6),completedTasks.prepared&&(percentage+=16.6),completedTasks.shared&&(percentage+=16.6),completedTasks.trained&&(percentage+=16.6),percentage=Math.ceil(percentage)},hasCourseStarted:function(course){if(_.has(course,"sessions")&&_.isArray(course.sessions)){var firstSession=this.firstSession(course.sessions,"standard");if(void 0==firstSession)return!1;var firstSessionDate=dateSvc.stringToDate(firstSession.start,"YYYY-MM-DDThh:mm:ss"),now=new Date;if(now>firstSessionDate)return!0}return!1},pastFirstTrainingDate:function(course){if(_.has(course,"sessions")&&_.isArray(course.sessions)){var firstSession=this.firstSession(course.sessions,"training");if(void 0==firstSession)return!1;var firstSessionDate=dateSvc.stringToDate(firstSession.start,"YYYY-MM-DDThh:mm:ss"),now=new Date;if(now>firstSessionDate)return!0}return!1},beforeFirstSessionDate:function(course){if(_.has(course,"sessions")&&_.isArray(course.sessions)){var firstSession=this.firstSession(course.sessions,"s");if(void 0==firstSession)return!1;var firstSessionDate=dateSvc.stringToDate(firstSession.start,"YYYY-MM-DDThh:mm:ss"),now=new Date;if(now>firstSessionDate)return!0}return!1},nextSession:function(course){var nextSession=void 0,lastSession=void 0;if(_.has(course,"sessions")&&_.isArray(course.sessions)){var sortedSessions=this.processSessions(course.sessions),now=new Date;_.forEach(sortedSessions,function(session){if(void 0===nextSession&&_.has(session,"start")){var sessionDate=dateSvc.stringToDate(session.start,"YYYY-MM-DDThh:mm:ss");sessionDate>now&&(nextSession=session)}lastSession=session})}return void 0===nextSession&&(nextSession=lastSession),this.sortSessions(course.sessions),nextSession},sortSessions:function(sessions){return _.sortByOrder(sessions,["start","UUID"],[!0,!0])},processSessions:function(sessions){var counter={s:0,t:0,w:0},newSessions=[];return _.forEach(this.sortSessions(sessions),function(session){_.has(session,"UUID")&&null!=session.UUID&&newSessions.push(new Session(session.UUID,session.title,session.start).calculateTitle(counter))}),newSessions},firstSession:function(sessions,type){var sortedSessions=this.processSessions(sessions),firstSession=void 0;return _.forEach(sortedSessions,function(session){void 0===firstSession&&_.has(session,"type")&&session.type===type&&(firstSession=session)}),firstSession},remainingTaks:function(course){var tasks=["download","schedule","promote","prepared","shared","trained"];return _.xor(tasks,course.tasks)},presentDownloadedMaterial:function(){$modal.open({templateUrl:"/templates/coaching/notification-modal.html",controller:"CoachingNotificationController",controllerAs:"notifcationCtrl",windowClass:"modal-coaching-notification",size:"sm",resolve:{notification:function(){return{icon:"high-five",title:gettextCatalog.getString("Hurrah!"),subtitle:gettextCatalog.getString("You've downloaded your first material – virtual high five!")}}}})},presentScheduled:function(){$modal.open({templateUrl:"/templates/coaching/notification-modal.html",controller:"CoachingNotificationController",controllerAs:"notifcationCtrl",windowClass:"modal-coaching-notification",size:"sm",resolve:{notification:function(){return{icon:"tea",title:gettextCatalog.getString("Great job!"),subtitle:gettextCatalog.getString("You've unlocked session-by-session view - have a cup of tea.")}}}})},presentPromoted:function(){$modal.open({templateUrl:"/templates/coaching/notification-modal.html",controller:"CoachingNotificationController",controllerAs:"notifcationCtrl",windowClass:"modal-coaching-notification",size:"sm",resolve:{notification:function(){return{icon:"doughnut",title:gettextCatalog.getString("Congratulations!"),subtitle:gettextCatalog.getString("You've promoted your Alpha – treat yourself to a doughnut.")}}}})},presentTrainingWatched:function(){$modal.open({templateUrl:"/templates/coaching/notification-modal.html",controller:"CoachingNotificationController",controllerAs:"notifcationCtrl",windowClass:"modal-coaching-notification",size:"sm",resolve:{notification:function(){return{icon:"star",title:gettextCatalog.getString("Go You!"),subtitle:gettextCatalog.getString("You're on the road to a stellar Alpha – gold star!")}}}})},presentShared:function(){$modal.open({templateUrl:"/templates/coaching/notification-modal.html",controller:"CoachingNotificationController",controllerAs:"notifcationCtrl",windowClass:"modal-coaching-notification",size:"sm",resolve:{notification:function(){return{icon:"thumb",title:gettextCatalog.getString("Great progress!"),subtitle:gettextCatalog.getString("We like that a lot.")}}}})},presentTrainingDone:function(){$modal.open({templateUrl:"/templates/coaching/notification-modal.html",controller:"CoachingNotificationController",controllerAs:"notifcationCtrl",windowClass:"modal-coaching-notification",size:"sm",resolve:{notification:function(){return{icon:"hand",title:gettextCatalog.getString("Your preparation is complete!"),subtitle:gettextCatalog.getString("We'll be praying you have an amazing Alpha.")}}}})}}}]),angular.module("alphaBuilder").factory("delayedActionSvc",function(){return{sessionUUID:void 0,scrollToAnchor:void 0,delegate:void 0,setDelegate:function(delegate){this.delegate=delegate},addDelayedAction:function(scrollToAnchor,sessionUUID){this.sessionUUID=sessionUUID,this.scrollToAnchor=scrollToAnchor},performActionNow:function(scrollToAnchor,sessionUUID){this.sessionUUID=sessionUUID,this.delegate&&this.delegate.performDelayedAction(scrollToAnchor,sessionUUID)},getDelayedAnchor:function(){var anchor=this.scrollToAnchor;return this.wipeScroll(),anchor},getDelayedSession:function(){var session=this.sessionUUID;return this.wipeSession(),session},wipeScroll:function(){this.scrollToAnchor=void 0},wipeSession:function(){this.sessionUUID=void 0}}}),angular.module("alphaBuilder").controller("CoachingNotificationController",["$scope","$modalInstance","notification",function($scope,$modalInstance,notification){this.notification=notification,this.close=function(){$modalInstance.close("done")}}]),angular.module("alphaBuilder").factory("queuedNotificationSvc",["$q","$timeout","$interval","authenticationSvc","courseSvc","coachingNotificationSvc",function($q,$timeout,$interval,authenticationSvc,courseSvc,coachingNotificationSvc){var STORAGE_ID="alpha-builder-notifications",notificationWatch=void 0,myself={notifications:[],processing:void 0,save:function(){localStorage.setItem(STORAGE_ID,JSON.stringify(this.notifications)),0===this.notifications.length?this.stopWatching():this.startWatching()},restore:function(){var defer=$q.defer(),localData=localStorage.getItem(STORAGE_ID)||null;if(localData&&"undefined"!==localData){var data=JSON.parse(localData);this.notifications=data,this.startWatching(),defer.resolve(this.notifications)}else this.startWatching(),defer.resolve(this.notifications);return defer.promise},startWatching:function(){this.stopWatching();var that=this,check=function(){var notification=_.first(that.notifications);void 0!=notification&&that.beginProcessing(notification)};sessionWatch=$interval(check(),5e3)},stopWatching:function(){$interval.cancel(notificationWatch),notificationWatch=void 0},scheduleNotification:function(task){-1===_.indexOf(this.notifications,task)&&(this.notifications.push(task),this.save())},beginProcessing:function(task){this.processing=task,this.removeTask(task,!1);var that=this;$timeout(function(){that.processTask(task)},6e3)},processTask:function(task){if(authenticationSvc.isLoggedIn){var currentAlpha=authenticationSvc.sessionData.currentAlpha;if(courseSvc.hasCompletedTask(currentAlpha,task))this.removeTask(task,!0);else{var that=this;courseSvc.completeTask(currentAlpha,task).then(function(){"download"===task?coachingNotificationSvc.presentDownloadedMaterial():"prepared"===task?coachingNotificationSvc.presentTrainingWatched():"shared"===task&&coachingNotificationSvc.presentShared(),that.removeTask(task,!0)},function(){})}}},removeTask:function(task,save){var index=_.indexOf(this.notifications,task);-1!==index&&_.pullAt(this.notifications,index),save&&this.save()}};return myself.restore(),myself}]),angular.module("alphaBuilder").directive("downloadTracking",["$window","queuedNotificationSvc",function($window,queuedNotificationSvc){return{restrict:"A",scope:{downloadTracking:"="},link:function(scope,element,attrs){var proceed=function(){var expression="downloadTracking.downloadURL | download:downloadTracking.id";if("promotional"===scope.downloadTracking.productType)var expression="downloadTracking.downloadURL | download:''";var url=scope.$eval(expression);$window.location=url},onDownload=function(){scope.$apply(function(){"preparatory"==scope.downloadTracking.productType?queuedNotificationSvc.scheduleNotification("prepared"):"promotional"==scope.downloadTracking.productType?queuedNotificationSvc.scheduleNotification("shared"):queuedNotificationSvc.scheduleNotification("download"),proceed()})};element.on("click",onDownload),scope.$on("$destroy",function(){element.off("click",onDownload)})}}}]),angular.module("alphaBuilder").controller("BaseController",["$scope","authenticationSvc","translationSvc",function($scope,authenticationSvc,translationSvc){this.authSvc=authenticationSvc,this.transSvc=translationSvc}]),angular.module("alphaBuilder").factory("cacheSvc",function(){return{tiles:{}}}),angular.module("alphaBuilder").directive("abNoBounce",function(){var xStart,yStart=0;document.addEventListener("touchstart",function(e){xStart=e.touches[0].screenX,yStart=e.touches[0].screenY}),document.addEventListener("touchmove",function(e){var xMovement=Math.abs(e.touches[0].screenX-xStart),yMovement=Math.abs(e.touches[0].screenY-yStart);xMovement>yMovement&&e.preventDefault()})}),angular.module("alphaBuilder").directive("abSessionWatcher",function(){return{restrict:"A",scope:{startDate:"=",dateChange:"&startDateChange"},link:function(scope,element){scope.$watch("startDate",function(newVal,oldVal){newVal!=oldVal&&scope.dateChange()})}}}),angular.module("alphaBuilder").directive("abGlobalNav",["authenticationSvc","translationSvc","contactSvc",function(authenticationSvc,translationSvc,contactSvc){return{restrict:"E",scope:{},templateUrl:"/templates/common/global-nav.html",link:function(scope,element,attrs){function closeSearch(){$("li.search").animate({width:"56px"},600,function(){}).removeClass("open"),$("li.search .search-open").delay(200).addClass("closed").removeClass("opened"),$("#global-nav li.account-dropdown").delay(200).fadeIn(),$("#global-nav li .login-button").delay(200).fadeIn(),$("#global-nav li.flags").delay(200).fadeIn(),$("#global-nav li.social").delay(200).fadeIn(),$("li.search #search-form-nav").delay(200).hide(),$("li.search .close-search").delay(200).fadeOut()}scope.authSvc=authenticationSvc,scope.translationSvc=translationSvc,scope.contactSvc=contactSvc,$("li.search .search-open").click(function(){return $("li.search").hasClass("open")?!1:($("li.search .search-open").removeClass("closed").addClass("opened"),$("#global-nav li.account-dropdown").fadeOut(),$("#global-nav li .login-button").fadeOut(),$("#global-nav li.flags").fadeOut(),$("#global-nav li.social").fadeOut(),$("li.search #search-form-nav").show(),$("li.search .close-search").fadeIn(),setTimeout(function(){$("li.search #edit-ai-search-string").focus()},50),$("li.search").animate({width:"100%"},600,function(){}).addClass("open"),!1)}),$("li.search .close-search").click(function(){return $("li.search").hasClass("open")?void closeSearch():!1})}}}]),angular.module("alphaBuilder").directive("abGlobalFooter",["translationSvc","contactSvc",function(translationSvc,contactSvc){return{restrict:"E",replace:!0,scope:{},templateUrl:"/templates/common/global-footer.html",link:function(scope,element,attrs){scope.translationSvc=translationSvc,scope.contactSvc=contactSvc,scope.today=new Date}}}]),angular.module("alphaBuilder").directive("abMiddleNav",["authenticationSvc","translationSvc",function(authenticationSvc,translationSvc){return{restrict:"E",scope:{},templateUrl:"/templates/common/middle-nav.html",link:function(scope){scope.authSvc=authenticationSvc,scope.translationSvc=translationSvc}}}]),angular.module("alphaBuilder").directive("abCoachingHeader",["$location","$timeout","coachingNotificationSvc","authenticationSvc","delayedActionSvc","getStartedSvc",function($location,$timeout,coachingNotificationSvc,authenticationSvc,delayedActionSvc,getStartedSvc){return{restrict:"E",scope:{},templateUrl:"/templates/common/coaching-header.html",link:function(scope){scope.percentageComplete=.4;var course=void 0,listener={authChanged:function(){_.has(authenticationSvc.sessionData,"currentAlpha")&&(course=authenticationSvc.sessionData.currentAlpha);var sessions=coachingNotificationSvc.processSessions(course.sessions);if(0==sessions.length)return void(scope.headerDisabled=!0);var completedTasks=coachingNotificationSvc.completedTasks(course),completedPercentage=coachingNotificationSvc.progressPercentage(completedTasks),showCoachingHeader=!0;completedPercentage>99&&(showCoachingHeader=!1),coachingNotificationSvc.hasCourseStarted(course)&&(showCoachingHeader=!1);var nextSession={UUID:"P01",iconTitle:"P"};showCoachingHeader===!1&&(nextSession=coachingNotificationSvc.nextSession(course)),scope.percentageComplete=completedPercentage,scope.showCoachingHeader=showCoachingHeader,scope.nextSession=nextSession,scope.tasks=completedTasks,scope.headerDisabled=!1}};authenticationSvc.registerObserver("coachingHeaderDirective",listener),listener.authChanged(),scope.getStarted=function(){getStartedSvc.duplicateFromCourse(course)},scope.performDelayedAction=function(path,anchor,sessionUUID){$location.path()==path?delayedActionSvc.performActionNow(anchor,sessionUUID):(delayedActionSvc.addDelayedAction(anchor,sessionUUID),$timeout(function(){$location.path(path)}))}}}}]),angular.module("alphaBuilder").directive("abSpinner",function(){return{restrict:"E",scope:{},template:"",link:function(scope,element,attrs){var zIndex=1e3;attrs.abZindex&&(zIndex=attrs.spinnerZindex);var opts={lines:11,length:6,width:2,radius:7,corners:1,rotate:0,direction:1,color:attrs.spinnerColor,speed:1.2,trail:36,shadow:!1,hwaccel:!1,className:"spinner",zIndex:zIndex,top:"50%",left:"50%"},spinner=new Spinner(opts).spin();element.append(spinner.el);var div=document.createElement("div");div.className="spinner-bg",div.style.backgroundColor=attrs.spinnerBackgroundColor,element.append(div);
}}}),angular.module("alphaBuilder").directive("abTile",["$timeout","resizeTiles",function($timeout,resizeTiles){return{restrict:"E",scope:{data:"=",size:"@",style:"@",type:"@"},templateUrl:"/templates/common/tile.html",link:function(scope,element,attrs){scope.data.hasVideo=!1,void 0==scope.type&&(scope.type="normal"),void 0==scope.style&&(scope.style="normal"),scope.data.style=scope.style,"square"==scope.size?(scope.data.imageURL=scope.data.squareImageURL,scope.data.imageConfig={w:480,h:480,fit:"crop",sharp:5,q:60}):"rectangle"==scope.size&&(scope.data.imageURL=scope.data.rectangleImageURL,scope.data.imageConfig={w:480,h:240,fit:"crop",sharp:5,q:60}),"event"==scope.data.type?scope.data.linkURL="/event/"+scope.data.id:"product"==scope.data.type?scope.data.linkURL="/product/"+scope.data.id:null!=scope.data.previewVideoURL?(scope.data.hasVideo=!0,"normal"==scope.data.style&&(scope.data.style="video")):scope.data.linkURL=scope.data.moreDetailsURL,$timeout(function(){resizeTiles()})}}}]),angular.module("alphaBuilder").directive("abBackgroundUrl",function(){return{restrict:"A",link:function(scope,element,attrs){attrs.$observe("abBackgroundUrl",function(val){element.css({"background-image":"url("+val+")"})})}}}),angular.module("alphaBuilder").directive("abShare",["$modal",function($modal){return{restrict:"E",templateUrl:"/templates/common/share-button.html",scope:{event:"=abEvent",product:"=abProduct"},link:function(scope,element,attrs){scope.open=function(){$modal.open({templateUrl:"/templates/common/share-modal.html",controller:"ShareInstanceController",windowClass:"modal-share",size:"sm",resolve:{event:function(){return scope.event},product:function(){return scope.product}}})}}}}]),angular.module("alphaBuilder").directive("abPopoutVideo",["$modal","queuedNotificationSvc",function($modal,queuedNotificationSvc){return{restrict:"E",scope:{videoUrl:"=abVideoUrl",data:"=abVideoData",label:"@abLabel"},templateUrl:function(element,attrs){return void 0===attrs.abType&&(attrs.abType="button"),"/templates/common/video-"+attrs.abType+".html"},link:function(scope,element,attrs){scope.open=function(){var modalInstance=$modal.open({templateUrl:"/templates/common/video-modal.html",controller:"VideoInstanceController",windowClass:"modal-video",size:"lg",resolve:{videoUrl:function(){return scope.videoUrl},size:function(){return scope.size}}});modalInstance.result["finally"](function(){_.has(scope.data,"productType")&&"preparatory"==scope.data.productType&&queuedNotificationSvc.scheduleNotification("prepared")})}}}}]),angular.module("alphaBuilder").directive("abRow",function(){return{restrict:"E",scope:{items:"=",type:"@"},templateUrl:"/templates/common/row.html",link:function(scope,element,attrs){void 0==scope.type&&(scope.type="normal")}}}),angular.module("alphaBuilder").directive("abRelated",["$timeout","resizeTiles",function($timeout,resizeTiles){return{restrict:"E",scope:{related:"="},templateUrl:"/templates/common/related.html",link:function(scope,element,attrs){$timeout(function(){resizeTiles()})}}}]),angular.module("alphaBuilder").directive("abHelpMenu",["translationSvc","contactSvc",function(translationSvc,contactSvc){return{restrict:"E",scope:{},templateUrl:"/templates/common/help-menu.html",link:function(scope,element,attrs){scope.translationSvc=translationSvc,scope.contactSvc=contactSvc}}}]),angular.module("alphaBuilder").directive("abDate",function(){return{restrict:"A",require:"ngModel",priority:1e4,link:function(scope,elem,attr,ngModel){ngModel.$parsers.push(function(value){var passed=!1;if(null!=value){var day=value.substr(0,2),month=value.substr(2,2)-1,year=value.substr(4,4);if(attr.hasOwnProperty("abDate")&&attr.abDate)var format=attr.abDate,day=parseInt(value.substr(format.indexOf("DD"),2)),month=parseInt(value.substr(format.indexOf("MM"),2))-1,year=parseInt(value.substr(format.indexOf("YYYY"),4));var date=new Date(year,month,day);date.getDate()==day&&date.getMonth()==month&&date.getFullYear()==year&&(passed=!0)}return ngModel.$setValidity("ab-date",passed),value})}}}),angular.module("alphaBuilder").directive("abPassword",function(){return{restrict:"A",require:"ngModel",priority:1e4,link:function(scope,elem,attr,ngModel){ngModel.$parsers.push(function(value){var passed=!1;return value.toUpperCase()!=value&&value.toLowerCase()!=value&&/[0-9]/.test(value)&&value.length>=6&&(passed=!0),ngModel.$setValidity("ab-password",passed),value})}}}),angular.module("alphaBuilder").directive("abTime",function(){return{restrict:"A",require:"ngModel",priority:1e4,link:function(scope,elem,attr,ngModel){ngModel.$parsers.push(function(value){var passed=!1;if(null!=value){var hours=parseInt(value.substring(0,2)),minutes=parseInt(value.substring(2));hours>=0&&23>=hours&&minutes>=0&&59>=minutes&&(passed=!0)}return ngModel.$setValidity("ab-time",passed),value})}}}),angular.module("alphaBuilder").directive("abParentRowHeight",["$timeout",function($timeout){return{restrict:"A",link:function(scope,elem,attr){$timeout(function(){angular.element(document.querySelector("#congrats-row"))[0].offsetHeight;$(elem).css("height","auto")})}}}]),angular.module("alphaBuilder").directive("abSelect",["$timeout",function($timeout){return{restrict:"E",require:"ngModel",transclude:!0,replace:!0,scope:{options:"=",ngModel:"=",onSelectCallback:"&onSelect",createTitle:"@",labelProperty:"@",onCreateCallback:"&onCreate",onModifyCallback:"&onModify"},templateUrl:"/templates/common/select.html",link:function(scope,elem,attr,ngModel,transclude){scope.placeholder=attr.placeholder||void 0,scope.opened=!1,scope.selected=null,scope.selectedTitle=function(){return(scope.selected?scope.selected[scope.labelProperty]:void 0)||scope.placeholder||"Choose an option"},ngModel.$render=function(){scope.selected=ngModel.$viewValue,$timeout(function(){scope.onSelectCallback&&scope.selected&&scope.onSelectCallback()}),scope.close()},scope.choose=function(id){var i=0,num=scope.options.length;for(i;num>i;i++)scope.options[i].id===id&&(scope.selected=scope.options[i]);scope.ngModel=scope.selected,$timeout(function(){scope.onSelectCallback&&scope.onSelectCallback()}),scope.close()},scope.create=function(){scope.onCreateCallback&&scope.onCreateCallback()},scope.modify=function(data){scope.onModifyCallback&&scope.onModifyCallback(data)},scope.isSelected=function(option){return scope.selected?option.id==scope.selected.id:!1},scope.open=function(){scope.opened=!0},scope.close=function(){scope.opened=!1},scope.toggle=function(){scope.opened=!scope.opened},transclude(scope,function(clone,scope){angular.element(elem[0].querySelector(".options")).append(clone)})}}}]);var API_BASE_URL="https://api.alpha.org";angular.module("alphaBuilder").filter("firstName",function(){return function(input){input=input||"";var nameParts=input.split(" "),firstName=nameParts[0];return firstName}}),angular.module("alphaBuilder").filter("youTubeId",function(){return function(input){function getURLParameter(name,params){return decodeURIComponent((new RegExp("[?|&]"+name+"=([^&;]+?)(&|#|;|$)").exec(params)||[,""])[1].replace(/\+/g,"%20"))||null}var parser=document.createElement("a");return parser.href=input,getURLParameter("v",parser.search)}}),angular.module("alphaBuilder").filter("img",function(){return function(input,options){if(void 0===input||null===input||""===input)return input;if("http://stage.files.alpha.org.s3.amazonaws.com/images/"==input.substring(0,53)){var filename=input.substring(53,input.length),additions=[];_.forEach(options,function(val,key){additions.push(key+"="+val)});var additionsStr=additions.join("&"),output=API_BASE_URL+"/images/"+filename+"?"+additionsStr;return output}if("http://files.alpha.org.s3.amazonaws.com/images/"==input.substring(0,47)){var filename=input.substring(47,input.length),additions=[];_.forEach(options,function(val,key){additions.push(key+"="+val)});var additionsStr=additions.join("&"),output="https://d5mcw96usafvk.cloudfront.net/"+filename+"?"+additionsStr;return output}return input}}),angular.module("alphaBuilder").filter("download",["authenticationSvc",function(authenticationSvc){return function(input,productId){if(void 0===input||null===input||""===input)return input;if("file://"==input.substring(0,7)){var fileId=input.substring(7,input.length),courseId=0;authenticationSvc.sessionData.hasOwnProperty("currentAlpha")&&(courseId=authenticationSvc.sessionData.currentAlpha.id);var output=API_BASE_URL+"/public/file-download/"+fileId+"-"+authenticationSvc.userData.id+"-"+courseId+"-"+productId;return output}if("file-stage://"==input.substring(0,13)){var fileId=input.substring(13,input.length),courseId=0;authenticationSvc.sessionData.hasOwnProperty("currentAlpha")&&(courseId=authenticationSvc.sessionData.currentAlpha.id);var output=API_BASE_URL+"/public/file-download/"+fileId+"-"+authenticationSvc.userData.id+"-"+courseId+"-"+productId;return output}return input}}]),angular.module("alphaBuilder").filter("debug",function(){return function(input){console.log(input)}}),angular.module("alphaBuilder").factory("commonSvc",["$http","$q",function($http,$q){return{countries:[],languages:null,counties:{},countiesAvailable:!1,fetchCountries:function(){var defer=$q.defer();if(0===this.countries.length){var that=this;$http.get("/api/country").then(function(response){that.countries=response.data.body,defer.resolve(that.countries)},function(response){defer.reject()})}else defer.resolve(this.countries);return defer.promise},fetchCounties:function(countryCode){var defer=$q.defer();if(!countryCode)return defer.promise;if(void 0===this.counties[countryCode]&&(this.counties[countryCode]=[],this.countiesAvailable=!1),0===this.counties[countryCode].length){this.countiesAvailable=!1;var that=this;$http.get("/api/county/"+countryCode).then(function(response){angular.forEach(response.data.body,function(value){that.counties[countryCode].push({label:value.replace(/(\r\n|\n|\r)/gm,"")})}),that.counties[countryCode].length>0?that.countiesAvailable=!0:that.countiesAvailable=!1,defer.resolve(that.counties[countryCode])},function(response){that.countiesAvailable=!1,defer.reject()})}else this.countiesAvailable=!0,defer.resolve(this.counties[countryCode]);return defer.promise},countryForISO:function(iso){var countries=this.countries,keys=Object.keys(countries),aCountry=null,i=0,len=keys.length;for(i=0;len>i;i++)countries[i].iso==iso&&(aCountry=countries[i]);return aCountry},fetchLang:function(locale){var defer=$q.defer();this.networkConnections++;var that=this;$http.get("/api/langauge/"+locale).then(function(response){that.languages=response.data.languages,that.networkConnections--,defer.resolve(response.data)},function(response){that.networkConnections--,defer.reject()})}}}]),angular.module("alphaBuilder").directive("abGlobalSearch",["globalSearchSvc",function(globalSearchSvc){return{restrict:"E",replace:!0,scope:{},templateUrl:"/templates/common/global-search.html",link:function(scope,element,attrs){function search(str){if(str&&str.length>=3){var i=0,newResults=[];_.forEach(globalSearchSvc.results,function(val,index){var regex=new RegExp(str);regex.test(val)&&10>i&&-1==newResults.indexOf(val)&&(newResults.push(val),i++)}),scope.search.results=newResults}else scope.search.results=[]}function closeSearch(){$("li.search").animate({width:"56px"},600,function(){scope.search.str=null,scope.search.results=[]}).removeClass("open"),$("li.search .search-open").delay(200).addClass("closed").removeClass("opened"),$("#global-nav li.account-dropdown").delay(200).fadeIn(),$("#global-nav li .login-button").delay(200).fadeIn(),$("#global-nav li.flags").delay(200).fadeIn(),$("#global-nav li.social").delay(200).fadeIn(),$("li.search #search-form-nav").delay(200).hide(),$("li.search .close-search").delay(200).fadeOut()}scope.service=globalSearchSvc,scope.search={str:null,results:[]};scope.$watch(function(){return scope.search.str},function(newVal,oldVal){search(newVal)}),$("li.search .search-open").click(function(){return $("li.search").hasClass("open")?!1:($("li.search .search-open").removeClass("closed").addClass("opened"),$("#global-nav li.account-dropdown").fadeOut(),$("#global-nav li .login-button").fadeOut(),$("#global-nav li.flags").fadeOut(),$("#global-nav li.social").fadeOut(),$("li.search #search-form-nav").show(),$("li.search .close-search").fadeIn(),$("li.search").animate({width:"100%"},600,function(){$("li.search input").focus()}).addClass("open"),!1)}),$("li.search .close-search").click(function(){return $("li.search").hasClass("open")?void closeSearch():!1})}}}]),angular.module("alphaBuilder").factory("globalSearchSvc",["$http","$q","$modal",function($http,$q,$modal){var API_BASE_URL="https://api.alpha.org";return{networkConnections:0,results:[],fetchAutocompleteResults:function(){var defer=$q.defer();if(this.networkConnections>0)return defer.reject(),defer.promise;if(this.results.length>0)return defer.resolve(this.results),defer.promise;this.networkConnections++;var that=this;return $http.get(API_BASE_URL+"/public/global/search/autocomplete").then(function(response){that.results=response.data.results,defer.resolve(that.results)},function(response){defer.reject()})["finally"](function(){that.networkConnections--}),defer.promise}}}]),angular.module("alphaBuilder").service("dialogSvc",["$modal",function($modal){var modalDefaults={backdrop:!0,keyboard:!1,modalFade:!0,templateUrl:"/templates/common/modal-dialog.html"},modalOptions={closeButtonText:"Cancel",actionButtonText:"OK",headerText:"Proceed?",bodyText:"Perform this action?"};this.showModal=function(customModalDefaults,customModalOptions){return customModalDefaults||(customModalDefaults={}),customModalDefaults.backdrop="static",this.show(customModalDefaults,customModalOptions)},this.show=function(customModalDefaults,customModalOptions){var tempModalDefaults={},tempModalOptions={};return angular.extend(tempModalDefaults,modalDefaults,customModalDefaults),angular.extend(tempModalOptions,modalOptions,customModalOptions),tempModalDefaults.controller||(tempModalDefaults.controller=function($scope,$modalInstance){$scope.modalOptions=tempModalOptions,$scope.modalOptions.ok=function(result){$modalInstance.close(result)},$scope.modalOptions.close=function(result){$modalInstance.dismiss("cancel")}}),$modal.open(tempModalDefaults).result}}]),angular.module("alphaBuilder").controller("ShareInstanceController",["$scope","$modalInstance","$location","$window","event","product","translationSvc",function($scope,$modalInstance,$location,$window,event,product,translationSvc){event?$scope.item=event:product&&($scope.item=product);var url=window.location.href.toString().replace("#!/","");url=url.replace("/product/","/"+translationSvc.locale+"/product/").replace("/event/","/"+translationSvc.locale+"/event/"),$scope.item.sharingURL=url,$scope.share=function(network){var externalURL=null;switch(network){case"twitter":externalURL="http://twitter.com/home?status="+$scope.item.sharingURL+"%20"+$scope.item.title+"%20%23Alpha";break;case"facebook":externalURL="http://www.facebook.com/sharer/sharer.php?u="+$scope.item.sharingURL;break;case"google":externalURL="http://plus.google.com/share?url="+$scope.item.sharingURL;break;case"email":externalURL="mailto:?&subject="+$scope.item.title+"&body="+$scope.item.subtitle+"%0D%0A%0D%0A"+$scope.item.sharingURL}$window.open(externalURL,"_blank")},$scope.close=function(){$modalInstance.close("done")}}]),angular.module("alphaBuilder").controller("VideoInstanceController",["$scope","$modalInstance","videoUrl","size",function($scope,$modalInstance,videoUrl,size){$scope.videoURL=videoUrl,$scope.size=size,$scope.close=function(){$modalInstance.close("done")}}]),angular.module("alphaBuilder").controller("ContactController",["$scope","$modalInstance","contactSvc","gettextCatalog","translationSvc",function($scope,$modalInstance,contactSvc,gettextCatalog,translationSvc){this.contactSvc=contactSvc,this.serverMessage={type:null,text:null},this.message={to:null,from:null,message:null},this.send=function(){var that=this;contactSvc.sendMessage(this.message).then(function(){that.serverMessage={type:"success",text:gettextCatalog.getString("Thank you for your message, will be in touch soon to answer your query.")}},function(){that.serverMessage={type:"danger",text:gettextCatalog.getString("Sorry we could not send your message at this time, please try again or contact support.")}})},this.close=function(){$modalInstance.close("done")},contactSvc.fetchOffice(translationSvc.locale)}]),angular.module("alphaBuilder").factory("contactSvc",["$http","$q","$modal","commonSvc",function($http,$q,$modal,commonSvc){var API_BASE_URL="https://api.alpha.org";return{office:null,networkActivity:!1,fetchedLocale:void 0,fetchOffice:function(locale){var defer=$q.defer();if(null!=this.office&&locale==this.fetchedLocale)return defer.resolve(this.office),defer.promise;this.office=null,this.networkActivity=!0;var that=this;return $http.get(API_BASE_URL+"/public/"+locale+"/contact").then(function(response){commonSvc.fetchCountries().then(function(countries){that.office=response.data.office,that.office.address=[],that.office.address1&&that.office.address.push(that.office.address1),that.office.address2&&that.office.address.push(that.office.address2),that.office.town&&that.office.address.push(that.office.town),that.office.county&&that.office.address.push(that.office.county),that.office.postcode&&that.office.address.push(that.office.postcode),that.office.country&&2===that.office.country.length?that.office.address.push(commonSvc.countryForISO(that.office.country).name):that.office.country&&that.office.address.push(that.office.country),that.fetchedLocale=locale,that.networkActivity=!1,defer.resolve(that.office)},function(error){that.networkActivity=!1,defer.reject()})},function(response){that.networkActivity=!1,defer.reject()}),defer.promise},sendMessage:function(message){var defer=$q.defer();this.networkActivity=!0;var that=this;return $http.post(API_BASE_URL+"/public/send-message",message).then(function(response){that.networkActivity=!1,defer.resolve()},function(response){that.networkActivity=!1,defer.reject()}),defer.promise},openForm:function(){$modal.open({templateUrl:"/templates/contact/contact-modal.html",controller:"ContactController",controllerAs:"contactCtrl",windowClass:"modal-contact",size:"sm"})}}}]),angular.module("alphaBuilder").controller("AddOrganisationController",["$scope","$modalInstance","courseSvc","commonSvc","organisationSvc","crmSvc","authenticationSvc","gettextCatalog","translationSvc",function($scope,$modalInstance,courseSvc,commonSvc,organisationSvc,crmSvc,authenticationSvc,gettextCatalog,translationSvc){authenticationSvc.performAuthCheck(),this.courseSvc=courseSvc,this.commonSvc=commonSvc,this.organisationSvc=organisationSvc,this.getCounties=commonSvc.fetchCounties(crmSvc.profile.address.country);var locale=translationSvc.locale;this.networkMessage={type:null,message:null},this.organisation={id:null,name:null,locale:locale,website:null,addressLine1:null,addressLine2:null,addressLine3:null,city:null,country:crmSvc.profile.address.country,county:null,postcode:null,latitude:null,longitude:null,phone:null,type:null},this.createOrganisation=function(){this.organisationSvc.create(this.organisation).then(function(organisation){this.networkMessage={type:"success",message:gettextCatalog.getString("New organisation created.")},$modalInstance.close(organisation)},function(){this.networkMessage={type:"danger",message:gettextCatalog.getString("Failed to create new organisation, please try again or contact support.")}})},this.close=function(){$modalInstance.close("done")},this.organisationSvc.fetchTypes(locale),this.commonSvc.fetchCountries(),this.fetchCounties=function(){this.networkActivity=!0,this.countyLength=0;var that=this;this.commonSvc.fetchCounties(this.organisation.country).then(function(counties){that.networkActivity=!1,that.countyLength=counties.length},function(error){that.networkActivity=!1})}}]),angular.module("alphaBuilder").controller("AddVenueController",["$scope","$modalInstance","courseSvc","commonSvc","venueSvc","crmSvc","authenticationSvc","gettextCatalog","translationSvc",function($scope,$modalInstance,courseSvc,commonSvc,venueSvc,crmSvc,authenticationSvc,gettextCatalog,translationSvc){authenticationSvc.performAuthCheck(),this.courseSvc=courseSvc,this.commonSvc=commonSvc,this.venueSvc=venueSvc;var locale=translationSvc.locale;this.networkActivity=!1,this.venue={name:null,address1:null,address2:null,city:null,county:crmSvc.profile.address.county,country:crmSvc.profile.address.country,postcode:null,locale:locale},this.createVenue=function(){this.venueSvc.create(this.venue).then(function(venue){this.networkMessage={type:"success",message:gettextCatalog.getString("New venue created.")},$modalInstance.close(venue)},function(){this.networkMessage={type:"danger",message:gettextCatalog.getString("Failed to create new venue, please try again or contact support.")}})},this.close=function(){$modalInstance.close("done")},this.commonSvc.fetchCountries(),this.fetchCounties=function(){this.networkActivity=!0;var that=this;this.commonSvc.fetchCounties(this.venue.country)["finally"](function(){that.networkActivity=!1})}}]),angular.module("alphaBuilder").controller("CourseController",["$scope","$location","$modal","$timeout","$locale","authenticationSvc","commonSvc","courseSvc","organisationSvc","venueSvc","dateSvc","gettextCatalog","translationSvc",function($scope,$location,$modal,$timeout,$locale,authenticationSvc,commonSvc,courseSvc,organisationSvc,venueSvc,dateSvc,gettextCatalog,translationSvc){authenticationSvc.performAuthCheck(),authenticationSvc.registerObserver("coursesController",this),this.authChanged=function(){var that=this;$timeout(function(){that.loadCourse()})};var dateFormat,dateIndicate,localeDateFormat,locale=translationSvc.locale,that=this;-1!=navigator.userAgent.indexOf("Safari")&&-1==navigator.userAgent.indexOf("Chrome")?(dateIndicate="-",localeDateFormat=$locale.DATETIME_FORMATS.shortDate.replace("/","-").replace("/","-")):(dateIndicate="/",localeDateFormat=$locale.DATETIME_FORMATS.shortDate),dateFormat="en_US"==locale?"MM"+dateIndicate+"dd"+dateIndicate+"yy":localeDateFormat,this.commonSvc=commonSvc,this.courseSvc=courseSvc,this.organisationSvc=organisationSvc,this.venueSvc=venueSvc,this.courseFailedMessage=null,commonSvc.fetchLang(locale),this.courseSvc.fetchAllData(locale)["finally"](function(){$scope.course&&that.loadCourse()}),this.loadCourse=function(){if($scope.course&&$scope.course.hasOwnProperty("id")||$scope.course&&$scope.forceNew){this.course.name=$scope.course.name,this.course.startTime=dateSvc.stringToTime($scope.course.start,"YYYY-MM-DDThh:mm:ss"),this.course.language=$scope.course.language.ISO,this.course.denomination=$scope.course.denomination.UUID,this.course.organisation=$scope.course.organisation,this.course.venue=$scope.course.venue,this.course.venueSameAsOrganisation=this.course.organisation.id===this.course.venue.id;var aLocation=this.course.venue||this.course.organisation;this.course.latitude=aLocation.latitude,this.course.longitude=aLocation.longitude,this.course.timezone=$scope.course.timezone,this.course.published=$scope.course.published,$scope.course.hasOwnProperty("id")&&!$scope.forceNew&&(this.course.id=$scope.course.id),$scope.course.hasOwnProperty("start")&&!$scope.forceNew?(this.course.startDate=dateSvc.stringToDate($scope.course.start,"YYYY-MM-DD"),this.course.endDate=dateSvc.stringToDate($scope.course.start,"YYYY-MM-DD")):(this.course.startDate=null,this.course.endDate=null)}},this.course={id:null,name:null,startDate:null,endDate:null,startTime:null,language:null,denomination:null,organisation:null,venue:null,venueSameAsOrganisation:!0,latitude:null,longitude:null,timezone:null},this.createOrganisation=function(){var createOrganisationModalInstance=$modal.open({templateUrl:"/templates/courses/add-organisation-modal.html",controller:"AddOrganisationController",controllerAs:"orgCtrl",windowClass:"modal-add-organisation",size:"sm"}),that=this;createOrganisationModalInstance.result.then(function(organisation){that.course.organisation=organisation})},this.modifyOrganisation=function(organisation){$scope.orgId=organisation;var modifyOrganisationModalInstance=$modal.open({templateUrl:"/templates/courses/edit-organisation-modal.html",controller:"EditOrganisationController",controllerAs:"orgCtrl",windowClass:"modal-edit-organisation",size:"sm",resolve:{editOrg:function(){return $scope.orgId}}}),that=this;modifyOrganisationModalInstance.result.then(function(organisation){that.course.organisation=organisation})},this.updateVenueMap=function(lat,lng){var latitude=lat||null,longitude=lng||null;null===lat&&null===longitude&&("undefined"==typeof this.course.venue||null===this.course.venue?"undefined"!=typeof this.course.organisation&&null!==this.course.organisation&&(latitude=this.course.organisation.latitude,longitude=this.course.organisation.longitude):(latitude=this.course.venue.latitude,longitude=this.course.venue.longitude)),this.course.latitude=latitude,this.course.longitude=longitude,this.map.marker.coords.latitude=latitude,this.map.marker.coords.longitude=longitude,this.map.center.latitude=latitude,this.map.center.longitude=longitude},this.onSelectOrganisation=function(){this.course.venueSameAsOrganisation===!0&&this.updateVenueMap(this.course.organisation.latitude,this.course.organisation.longitude)},this.createVenue=function(){var createVenueModalInstance=$modal.open({templateUrl:"/templates/courses/add-venue-modal.html",controller:"AddVenueController",controllerAs:"venueCtrl",windowClass:"modal-add-venue",size:"sm"}),that=this;createVenueModalInstance.result.then(function(venue){that.course.venue=venue})},this.modifyVenue=function(venue){$scope.venue=venue;var modifyVenueModalInstance=$modal.open({templateUrl:"/templates/courses/edit-venue-modal.html",controller:"EditVenueController",controllerAs:"venueCtrl",windowClass:"modal-edit-venue",size:"sm",resolve:{editVen:function(){return $scope.venue}}});return modifyVenueModalInstance},this.onSelectVenue=function(){var latitude=this.course.venue.latitude,longitude=this.course.venue.longitude;this.course.latitude=latitude,this.course.longitude=longitude,this.map.marker.coords.latitude=latitude,this.map.marker.coords.longitude=longitude,this.map.center.latitude=latitude,this.map.center.longitude=longitude},this.autoAddDays=function(v){var d=new Date(v);d.setDate(d.getDate()+parseInt(105));var dateNum,endDate,month=d.getMonth()+1;dateNum=d.getDate()<9?"0"+d.getDate():d.getDate(),endDate="en_US"==locale?month+dateIndicate+dateNum+dateIndicate+d.getFullYear():dateNum+dateIndicate+month+dateIndicate+d.getFullYear(),that.course.endDate=d},this.createCourse=function(){courseSvc.create(this.course).then(function(course){this.courseFailedMessage=null;$modal.open({templateUrl:"/templates/courses/new-course-modal.html",controller:"NewCourseController",controllerAs:"newCourseCtrl",windowClass:"modal-course-created",size:"lg",backdrop:"static",resolve:{course:function(){return course}}})},function(){this.courseFailedMessage=gettextCatalog.getString("Unable to create your course at this time, please try again or contact support")})},this.startDatePicker={opened:!1,dateOptions:{formatYear:"yy",startingDay:1,formatDayHeader:"EEE",showWeeks:!1},format:dateFormat,openPicker:function($event){$event.preventDefault(),$event.stopPropagation(),this.opened=!0}},$scope.$on("abLocaleChanged",function(event,params){that.startDatePicker.format=dateFormat}),this.endDatePicker={opened:!1,dateOptions:{formatYear:"yy",startingDay:1,formatDayHeader:"EEE",showWeeks:!1},format:dateFormat,openPicker:function($event){$event.preventDefault(),$event.stopPropagation(),this.opened=!0}},$scope.$on("abLocaleChanged",function(event,params){that.endDatePicker.format=dateFormat}),this.toggleVenueSameAsOrganisation=function(){this.course.venueSameAsOrganisation=!this.course.venueSameAsOrganisation,this.course.venueSameAsOrganisation===!0&&"undefined"!=typeof this.course.organisation&&null!==this.course.organisation?this.updateVenueMap(this.course.organisation.latitude,this.course.organisation.longitude):"undefined"!=typeof this.course.venue&&null!==this.course.venue&&this.updateVenueMap(this.course.venue.latitude,this.course.venue.longitude),that.course.venueSameAsOrganisation===!1&&0===that.venueSvc.venues.length&&that.createVenue()},this.map={center:{latitude:this.course.latitude,longitude:this.course.longitude},zoom:16,options:{scrollwheel:!1},marker:{id:0,coords:{latitude:this.course.latitude,longitude:this.course.longitude},options:{draggable:!0},events:{dragend:function(marker,eventName,args){that.course.latitude=marker.getPosition().lat(),that.course.longitude=marker.getPosition().lng()}}}},this.submit=function(){var data=this.course;if(null===data.organisation.name||null===data.organisation.addressLine1)return!1;if(null===data.organisation.city||null===data.organisation.country)return!1;if(null===data.organisation.county||null===data.organisation.type.UUID)return!1;var course=angular.copy(this.course);$scope.callback({course:course})}}]),angular.module("alphaBuilder").directive("abCourseForm",function(){return{restrict:"E",replace:!0,scope:{spinnerBackgroundColor:"@",spinnerZIndex:"@",course:"=",callback:"&submitCallback",submitLabel:"@",profile:"=",forceNew:"="},templateUrl:"/templates/courses/course-form.html",controller:"CourseController",controllerAs:"courseCtrl"}}),angular.module("alphaBuilder").directive("abCoursePromotion",function(){return{restrict:"E",templateUrl:"/templates/courses/course-promotion.html",controller:"PromoteController",controllerAs:"promoteCtrl"}}),angular.module("alphaBuilder").directive("select2",["$timeout","$parse",function($timeout,$parse){return{restrict:"AC",require:"ngModel",link:function(scope,element,attrs){$timeout(function(){element.select2(),element.select2Initialized=!0});var recreateSelect=function(){element.select2Initialized&&$timeout(function(){element.trigger("change"),element.select2()})};if(attrs.ngOptions){var list=attrs.ngOptions.match(/ in ([^ ]*)/)[1];scope.$watch(list,recreateSelect)}}}}]),angular.module("alphaBuilder").factory("courseSvc",["$http","$q","tokenSvc","crmSvc","getStartedSvc","organisationSvc","venueSvc","dateSvc","translationSvc",function($http,$q,tokenSvc,crmSvc,getStartedSvc,organisationSvc,venueSvc,dateSvc,translationSvc,$filter){var STORAGE_ID="alpha-builder-courses",COURSES_API_BASE_URL="https://courses-api.alpha.org";return{loadingCourses:!1,observers:{},networkConnections:0,languages:null,denominations:null,timezones:null,newCourse:null,courses:[],lastResponse:null,loadMore:!0,fetch:function(forceReload,page){var defer=$q.defer();if(!tokenSvc.session.authenticated)return defer.reject(),defer.promise;if(!forceReload&&this.courses.length>0)return defer.resolve(this.courses),defer.promise;this.networkConnections++,this.loadingCourses=!0;var that=this;return $http.get(COURSES_API_BASE_URL+"/3/courses?active=true",{headers:{Authorization:"Bearer "+tokenSvc.session.token},params:{page:void 0===page?1:page,orderBy:"c.id",orderType:"DESC","type[]":["Alpha","Alpha in a Catholic context","Alpha for Seniors","Youth Alpha","Student Alpha","Alpha for Prisons","Alpha in the Workplace","Alpha for Forces","Alpha for ESOL"]}}).then(function(response){forceReload&&void 0!==page?that.courses=that.courses.concat(response.data.courses):that.courses=response.data.courses,that.courses=_.sortBy(that.courses,"start"),that.save(),forceReload&&void 0!==page||that.notifyObservers(),that.networkConnections--,that.loadingCourses=!1,that.lastResponse=response,defer.resolve(that.courses)},function(response){that.networkConnections--,that.loadingCourses=!1,that.loadMore=!1,defer.reject()}),defer.promise},create:function(data){var defer=$q.defer(),that=this;this.newCourse=data;var startDate=dateSvc.combineDateTimeStringToDate(data.startDate,data.startTime,"hhmm"),course={name:data.name,locale:translationSvc.locale,denomination:data.denomination,language:data.language,
start:dateSvc.dateToAPIFriendlyString(startDate),email:crmSvc.profile.email,contact:crmSvc.profile.firstName+" "+crmSvc.profile.lastName,contexts:getStartedSvc.answers.contexts,length:parseInt(getStartedSvc.answers.numSessions),presentationStyle:getStartedSvc.answers.how,packages:[getStartedSvc.answers.chosenPackage],approved:!0,published:!1,source:"alphabuilder",organisation:data.organisation.id,latitude:data.latitude,longitude:data.longitude,venue:null};return null!==data.venue&&(course.venue=data.venue.id),this.networkConnections++,$http.post(COURSES_API_BASE_URL+"/3/courses",course,{headers:{Authorization:"Bearer "+tokenSvc.session.token}}).then(function(response){getStartedSvc.wipe(!0),that.networkConnections--,that.newCourse=response.data.course,that.courses.push(response.data.course),that.courses=_.sortBy(that.courses,"start"),that.save(),that.notifyObservers(),defer.resolve(response.data.course)},function(response){that.networkConnections--,defer.reject(response.data)}),defer.promise},update:function(id,data){var defer=$q.defer();data.contact=crmSvc.profile.firstName+" "+crmSvc.profile.lastName;var that=this;return this.networkConnections++,$http.put(COURSES_API_BASE_URL+"/3/courses/"+id,data,{headers:{Authorization:"Bearer "+tokenSvc.session.token}}).then(function(response){that.networkConnections--;var course=response.data.course,index=_.findIndex(that.courses,{id:course.id});that.courses[index]=course,that.courses=_.sortBy(that.courses,"start"),that.save(),that.notifyObservers(),defer.resolve(course)},function(response){that.networkConnections--,defer.reject(response.data)}),defer.promise},promote:function(id){return this.update(id,{published:!0})},unpromote:function(id){return this.update(id,{published:!1})},fetchLanguages:function(locale,forceReload){var defer=$q.defer();if(!forceReload&&this.languages)return defer.resolve(this.languages),defer.promise;this.networkConnections++;var that=this;return $http.get("/api/language/"+locale).then(function(response){that.languages=response.data.languages,that.networkConnections--,defer.resolve(that.languages)},function(response){that.networkConnections--,defer.reject()}),defer.promise},fetchDenominations:function(locale,forceReload){var defer=$q.defer();if(!forceReload&&this.denominations)return defer.resolve(this.denominations),defer.promise;this.networkConnections++;var that=this;return $http.get(COURSES_API_BASE_URL+"/3/public/utilities/"+locale+"/denominations").then(function(response){that.denominations=response.data.denominations,that.networkConnections--,defer.resolve(that.denominations)},function(response){that.networkConnections--,defer.reject()}),defer.promise},fetchTimezones:function(locale,country,forceReload){var defer=$q.defer();if(!forceReload&&this.timezones)return defer.resolve(this.timezones),defer.promise;this.networkConnections++;var that=this;return $http.get(COURSES_API_BASE_URL+"/3/public/utilities/"+locale+"/timezones/"+country).then(function(response){that.timezones=that.processTimezones(response.data.timezones),that.networkConnections--,defer.resolve(that.timezones)},function(response){that.networkConnections--,defer.reject()}),defer.promise},fetchAllData:function(locale){var defer=$q.defer();this.networkConnections++;var that=this;return $http.get(COURSES_API_BASE_URL+"/3/helper/all/"+locale,{headers:{Authorization:"Bearer "+tokenSvc.session.token}}).then(function(response){that.denominations=response.data.denominations,that.languages=response.data.languages,that.timezones=that.processTimezones(response.data.timezones),organisationSvc.types=response.data.organisationTypes,organisationSvc.organisations=response.data.organisations,venueSvc.venues=response.data.venues,that.networkConnections--,defer.resolve(response.data)},function(response){that.networkConnections--,defer.reject()}),defer.promise},registerObserver:function(key,callback){this.observers[key]=callback},notifyObservers:function(){_.forEach(this.observers,function(observer,key){void 0!==observer&&observer.hasOwnProperty("coursesChanged")&&observer.coursesChanged()})},removeObserver:function(key){this.observers[key]=void 0},restore:function(force){var localData=localStorage.getItem(STORAGE_ID)||null;if(localData){var data=JSON.parse(localData);this.courses=data,this.courses.length>0?(this.loadMore="true"===localStorage.getItem(STORAGE_ID+"_loadMore"),this.notifyObservers()):this.fetch()}else this.fetch()},save:function(){localStorage.setItem(STORAGE_ID,JSON.stringify(this.courses)),localStorage.setItem(STORAGE_ID+"_loadMore",this.loadMore)},clear:function(){this.courses=[],this.loadMore=!0,this.save()},reschedule:function(id,startDate,timezone){var defer=$q.defer(),that=this;return this.networkConnections++,$http.put(COURSES_API_BASE_URL+"/3/courses/"+id+"/reschedule",{start:dateSvc.dateToAPIFriendlyString(startDate),timezone:timezone},{headers:{Authorization:"Bearer "+tokenSvc.session.token}}).then(function(response){that.networkConnections--;var course=response.data.course,index=_.findIndex(that.courses,{id:course.id});that.courses[index]=course,that.save(),that.notifyObservers(),defer.resolve(course)},function(data){that.networkConnections--,defer.reject()}),defer.promise},updateSessions:function(id,sessions,timezone){var defer=$q.defer(),data={sessions:sessions};void 0!==timezone&&(data.timezone=timezone);var that=this;return this.networkConnections++,$http.put(COURSES_API_BASE_URL+"/3/courses/"+id+"/sessions",data,{headers:{Authorization:"Bearer "+tokenSvc.session.token}}).then(function(response){that.networkConnections--;var course=response.data.course,index=_.findIndex(that.courses,{id:course.id});that.courses[index]=course,that.save(),that.notifyObservers(),defer.resolve(course)},function(data){that.networkConnections--,defer.reject()}),defer.promise},hasCompletedTask:function(course,task){return _.isArray(course.tasks)?-1===_.indexOf(course.tasks,task)?!1:!0:!1},completeTask:function(course,task){var defer=$q.defer(),that=this;return this.networkConnections++,$http.put(COURSES_API_BASE_URL+"/3/courses/"+course.id+"/tasks/complete/"+task,null,{headers:{Authorization:"Bearer "+tokenSvc.session.token}}).then(function(response){that.networkConnections--;var course=response.data.course,index=_.findIndex(that.courses,{id:course.id});that.courses[index]=course,that.save(),that.notifyObservers(),defer.resolve(course)},function(data){that.networkConnections--,defer.reject()}),defer.promise},inviteEmailContent:function(course){var defer=$q.defer(),that=this;return this.networkConnections++,$http.get(COURSES_API_BASE_URL+"/3/public/courses/"+course.id+"/invite-email-copy").then(function(response){that.networkConnections--,defer.resolve(response.data.content)},function(data){that.networkConnections--,defer.reject()}),defer.promise},processTimezones:function(timezones){var finalZones=[];return _.forEach(timezones,function(zones,continent){_.forEach(zones,function(name,id){finalZones.push({label:name,UUID:id,continent:continent})})}),finalZones},fetchByUsername:function(username){var defer=$q.defer();this.networkConnections++;var that=this;return $http.get(COURSES_API_BASE_URL+"/3/courses/fetch/"+username,{headers:{Authorization:"Bearer "+tokenSvc.session.token}}).then(function(response){that.id=response.data.id,that.networkConnections--,defer.resolve(response.data)},function(response){that.networkConnections--,defer.reject()}),defer.promise},loadMoreCourses:function(page){var that=this;this.fetch(!0,page).then(function(){if(that.lastResponse.hasOwnProperty("data")){var pager=that.lastResponse.data.pager;pager.currentPage>=pager.totalPages&&(that.loadMore=!1,that.save())}})}}}]),angular.module("alphaBuilder").controller("EditOrganisationController",["$scope","$modalInstance","courseSvc","commonSvc","organisationSvc","crmSvc","authenticationSvc","gettextCatalog","translationSvc","editOrg","$timeout",function($scope,$modalInstance,courseSvc,commonSvc,organisationSvc,crmSvc,authenticationSvc,gettextCatalog,translationSvc,editOrg,$timeout){authenticationSvc.performAuthCheck(),this.courseSvc=courseSvc,this.commonSvc=commonSvc,this.organisationSvc=organisationSvc,this.editOrg=editOrg;var locale=translationSvc.locale;this.networkMessage={type:null,message:null},this.organisation={id:this.editOrg.id,name:this.editOrg.name,locale:this.editOrg.locale,website:this.editOrg.website,addressLine1:this.editOrg.addressLine1,addressLine2:this.editOrg.addressLine2,addressLine3:this.editOrg.addressLine3,city:this.editOrg.city,country:this.editOrg.country,county:this.editOrg.county,postcode:this.editOrg.postcode,latitude:this.editOrg.latitude,longitude:this.editOrg.longitude,phone:this.editOrg.phone,type:this.editOrg.type.UUID},this.modifyOrganisation=function(){this.organisationSvc.update(this.organisation).then(function(organisation){this.networkMessage={type:"success",message:gettextCatalog.getString("Organisation modified.")},$modalInstance.close(organisation)},function(){this.networkMessage={type:"danger",message:gettextCatalog.getString("Failed to modify organisation, please try again or contact support.")}})},this.close=function(){$modalInstance.close("done")},this.organisationSvc.fetchTypes(locale),this.commonSvc.fetchCountries(),this.fetchCounties=function(){this.networkActivity=!0;var that=this,countySelected=that.organisation.county;this.commonSvc.fetchCounties(that.organisation.country).then(function(counties){var e=angular.element(document.querySelector("#county option:first-child")),el=e.val(),newElement=el.substr(0,8);newElement&&e.remove(),that.networkActivity=!1,that.organisation.county=countySelected},function(error){that.networkActivity=!1})},this.fetchCounties()}]),angular.module("alphaBuilder").controller("EditVenueController",["$scope","$modalInstance","courseSvc","commonSvc","venueSvc","crmSvc","authenticationSvc","gettextCatalog","translationSvc","editVen",function($scope,$modalInstance,courseSvc,commonSvc,venueSvc,crmSvc,authenticationSvc,gettextCatalog,translationSvc,editVen){authenticationSvc.performAuthCheck(),this.courseSvc=courseSvc,this.commonSvc=commonSvc,this.venueSvc=venueSvc,this.editVen=editVen;translationSvc.locale;this.networkActivity=!1,this.venue={id:this.editVen.id,name:this.editVen.name,address1:this.editVen.addressLine1,address2:this.editVen.addressLine2,city:this.editVen.city,county:this.editVen.county,country:this.editVen.country,postcode:this.editVen.postcode,locale:this.editVen.locale,longitude:this.editVen.longitude,latitude:this.editVen.latitude},this.modifyVenue=function(){console.log(this.venue),this.venueSvc.update(this.venue).then(function(venue){this.networkMessage={type:"success",message:gettextCatalog.getString("Venue modified.")},$modalInstance.close(venue)},function(){this.networkMessage={type:"danger",message:gettextCatalog.getString("Failed to modify venue, please try again or contact support.")}})},this.close=function(){$modalInstance.close("done")},this.commonSvc.fetchCountries(),this.fetchCounties=function(){this.networkActivity=!0;var that=this;this.commonSvc.fetchCounties(this.venue.country)["finally"](function(){that.networkActivity=!1})}}]),angular.module("alphaBuilder").controller("NewCourseController",["$scope","$modalInstance","$location","crmSvc","authenticationSvc","courseSvc","dateSvc","commonSvc","course","gettextCatalog",function($scope,$modalInstance,$location,crmSvc,authenticationSvc,courseSvc,dateSvc,commonSvc,course,gettextCatalog){authenticationSvc.performAuthCheck(),this.crmSvc=crmSvc,this.courseSvc=courseSvc,this.course=course,this.networkActivity=!1,this.errorMessage=null,this.promoteAlpha=!1,this.togglePromoteAlpha=function(){this.promoteAlpha=!this.promoteAlpha},this.startDate=dateSvc.stringToDate(this.courseSvc.newCourse.start,"YYYY-MM-DDThh:mm:ss"),this.endDate=dateSvc.stringToDate(this.courseSvc.newCourse.finish,"YYYY-MM-DDThh:mm:ss"),this.address="",this.addLineToAddress=function(line){line&&(this.address+=line+"<br/>")};var that=this;commonSvc.fetchCountries()["finally"](function(countries){that.addLineToAddress(that.courseSvc.newCourse.venue.addressLine1),that.addLineToAddress(that.courseSvc.newCourse.venue.addressLine2),that.addLineToAddress(that.courseSvc.newCourse.venue.addressLine3),that.addLineToAddress(that.courseSvc.newCourse.venue.city),that.addLineToAddress(that.courseSvc.newCourse.venue.county),that.addLineToAddress(commonSvc.countryForISO(that.courseSvc.newCourse.venue.country).name),that.addLineToAddress(that.courseSvc.newCourse.postcode),that.address=that.address.substr(0,that.address.length-5)}),this.next=function(){if(1==this.promoteAlpha){this.networkActivity=!0;var that=this;this.courseSvc.promote(this.course.id).then(function(updatedCourse){that.errorMessage=null,that.networkActivity=!1,courseSvc.hasCompletedTask(updatedCourse,"promote")||courseSvc.completeTask(updatedCourse,"promote"),that.redirect(updatedCourse)},function(error){that.networkActivity=!1,that.errorMessage=gettextCatalog.getString("We could not promote your Alpha at this time, please try again or contact support")})}else this.redirect(this.course)},this.redirect=function(course){authenticationSvc.changeAlpha(course.id),courseSvc.newCourse=void 0,$modalInstance.close("done"),$location.path("/dashboard")},this.map={center:{latitude:this.courseSvc.newCourse.venue.latitude,longitude:this.courseSvc.newCourse.venue.longitude},zoom:9,options:{scrollwheel:!1,draggable:!1,zoomControl:!1,maxZoom:9,minZoom:9,disableDefaultUI:!0},marker:{id:1,coords:{latitude:this.courseSvc.newCourse.venue.latitude,longitude:this.courseSvc.newCourse.venue.longitude},options:{draggable:!1}}}}]),angular.module("alphaBuilder").factory("organisationSvc",["$http","$q","tokenSvc",function($http,$q,tokenSvc){var COURSES_API_BASE_URL="https://courses-api.alpha.org";return{networkActivity:!1,organisations:[],types:null,fetch:function(forceReload){var defer=$q.defer();if(!forceReload&&this.organisations.length>0)return defer.resolve(this.organisations),defer.promise;if(this.networkActivity)return defer.reject(),defer.promise;this.networkActivity=!0;var that=this;return $http.get(COURSES_API_BASE_URL+"/3/organisations",{headers:{Authorization:"Bearer "+tokenSvc.session.token}}).then(function(response){that.organisations=response.data.organisations,that.networkActivity=!1,defer.resolve(that.organisations)},function(error){that.networkActivity=!1,defer.reject()}),defer.promise},create:function(organisation){var defer=$q.defer();if(this.networkActivity)return defer.reject(),defer.promise;this.networkActivity=!0;var that=this;return $http.post(COURSES_API_BASE_URL+"/3/organisations",organisation,{headers:{Authorization:"Bearer "+tokenSvc.session.token}}).then(function(response){var newOrganisation=response.data.organisation;that.organisations.push(newOrganisation),that.networkActivity=!1,defer.resolve(newOrganisation)},function(data){that.networkActivity=!1,defer.reject()}),defer.promise},update:function(organisation){var defer=$q.defer();if(this.networkActivity)return defer.reject(),defer.promise;var updatedOrganisation=angular.copy(organisation),id=updatedOrganisation.id;id||defer.reject(),delete updatedOrganisation.id,this.networkActivity=!0;var that=this;return $http.put(COURSES_API_BASE_URL+"/3/organisations/"+id,updatedOrganisation,{headers:{Authorization:"Bearer "+tokenSvc.session.token}}).then(function(response){var i=0,num=that.organisations.length,theUpdatedOrganisation=response.data.organisation;for(i;num>i;i++)that.organisations[i].id==theUpdatedOrganisation.id&&(that.organisations[i]=theUpdatedOrganisation);that.networkActivity=!1,defer.resolve(theUpdatedOrganisation)},function(data){that.networkActivity=!1,defer.reject()}),defer.promise},fetchTypes:function(locale,forceReload){var defer=$q.defer();if(!forceReload&&this.types)return defer.resolve(this.types),defer.promise;if(this.networkActivity)return defer.reject(),defer.promise;this.networkActivity=!0;var that=this;return $http.get(COURSES_API_BASE_URL+"/3/public/utilities/"+locale+"/organisation-types").then(function(response){that.types=response.data.organisationTypes,that.networkActivity=!1,defer.resolve(that.types)},function(response){that.networkActivity=!1,defer.reject()}),defer.promise}}}]),angular.module("alphaBuilder").factory("packageSvc",["$http","$q",function($http,$q){var API_BASE_URL="https://api.alpha.org";return{networkConnections:0,limited:!1,products:[],fetch:function(packageIds,forceReload,limit){var defer=$q.defer();if(void 0==limit&&(limit=!1),!forceReload&&this.limited==limit&&this.products.length>0)return defer.resolve(this.products),defer.promise;this.limited=limit,packageIds.constructor===Array&&(packageIds=packageIds.join(",")),this.networkConnections++;var that=this;return limit&&(limit=1),$http.get(API_BASE_URL+"/public/package-products/"+packageIds+"?limit="+limit).then(function(response){that.products=response.data.products,that.networkConnections--,defer.resolve(that.products)},function(error){that.networkConnections--,defer.reject()}),defer.promise}}}]),angular.module("alphaBuilder").controller("ScheduleController",["$scope","$location","$timeout","$modal","$locale","courseSvc","authenticationSvc","crmSvc","dateSvc","coachingNotificationSvc","smoothScroll","gettextCatalog","translationSvc",function($scope,$location,$timeout,$modal,$locale,courseSvc,authenticationSvc,crmSvc,dateSvc,coachingNotificationSvc,smoothScroll,gettextCatalog,translationSvc){function Session(UUID,title,start){this.UUID=UUID,this.title=title,this.start=start,this.iconTitle=void 0,this.startDate=void 0,this.pickerOpen=!1,this.num=20,this.process=function(counter){switch(this.UUID[0]){case"S":counter.s++,this.iconTitle=counter.s,this.num=counter.s;break;case"T":counter.t++,this.iconTitle=gettextCatalog.getString("T")+counter.t,this.num=counter.t;break;case"W":counter.w++,this.iconTitle=gettextCatalog.getString("W")+counter.w,this.num=counter.w;break;case"P":this.iconTitle=gettextCatalog.getString("P");break;case"A":this.iconTitle=gettextCatalog.getString("A")}return this.startDate=dateSvc.stringToDate(this.start,"YYYY-MM-DDThh:mm:ss"),this}}var COURSES_API_BASE_URL="https://courses-api.alpha.org",locale=translationSvc.locale;authenticationSvc.performAuthCheck(),authenticationSvc.performCurrentAlphaCheck(),this.sessionWatcher=void 0,this.courseSvc=courseSvc,this.crmSvc=crmSvc,this.ready=!1,authenticationSvc.registerObserver("scheduleController",this),this.scheduleDisabled=!1,this.authChanged=function(){var that=this;$timeout(function(){that.loadCurrentCourse()})},this.courseSvc.fetchAllData(locale).then(function(){this.ready=!0},function(){}),this.message={type:null,text:null},this.course={id:void 0,startDate:new Date,startTime:"0000",timezone:null,sessions:[],subscribed:!crmSvc.profile.unsubscribed};var that=this;this.processSessions=function(){if(authenticationSvc.sessionData.currentAlpha){void 0!==this.sessionWatcher&&(this.sessionWatcher(),this.sessionWatcher=void 0);var orderedSessions=authenticationSvc.sessionData.currentAlpha.sessions.sort(function(a,b){return new Date(a.start)-new Date(b.start)}),i=0,num=orderedSessions.length,session=null,counter={s:0,t:0,w:0};for(i;num>i;i++)session=orderedSessions[i],null!==session.UUID&&"P"!=session.UUID[0]&&"A"!=session.UUID[0]&&this.course.sessions.push(new Session(session.UUID,session.title,session.start).process(counter));0===this.course.sessions.length&&(this.scheduleDisabled=!0),$scope.course=this.course,this.datesChanged=!1,this.sessionWatcher=$scope.$watch(function(){return that.course.sessions},function(newVal,oldVal){for(var i=0;i<that.course.sessions.length;i++)+newVal[i].startDate!==+oldVal[i].startDate&&(that.datesChanged=!0)},!0)}},this.loadCurrentCourse=function(){if(this.scheduleDisabled=!1,!authenticationSvc.isLoggedIn)return void $location.path("/");if(authenticationSvc.sessionData.currentAlpha){dateSvc.stringToDate(authenticationSvc.sessionData.currentAlpha.start,"YYYY-MM-DD"),dateSvc.stringToTime(authenticationSvc.sessionData.currentAlpha.start,"YYYY-MM-DDThh:mm:ss");this.course={id:authenticationSvc.sessionData.currentAlpha.id,startDate:dateSvc.stringToDate(authenticationSvc.sessionData.currentAlpha.start,"YYYY-MM-DD"),startTime:dateSvc.stringToTime(authenticationSvc.sessionData.currentAlpha.start,"YYYY-MM-DDThh:mm:ss"),timezone:authenticationSvc.sessionData.currentAlpha.timezone,sessions:[],subscribed:!crmSvc.profile.unsubscribed},this.processSessions()}else $location.path("/dashboard");$scope.scheduleForm&&$scope.scheduleForm.$setPristine(),$scope.sessionForm&&$scope.sessionForm.$setPristine()},this.loadCurrentCourse(),this.startDatePicker={opened:!1,dateOptions:{formatYear:"yy",startingDay:1,formatDayHeader:"EEE",showWeeks:!1},format:$locale.DATETIME_FORMATS.shortDate,openPicker:function($event){$event.preventDefault(),$event.stopPropagation(),this.opened=!0}},$scope.$on("abLocaleChanged",function(event,params){that.startDatePicker.format=$locale.DATETIME_FORMATS.shortDate}),this.togglePicker=function($event,session){$event.preventDefault(),$event.stopPropagation(),session.pickerOpen?this.watcher():("function"==typeof this.watcher&&this.watcher(),_(this.course.sessions).forEach(function(session){session.pickerOpen=!1}),this.watcher=$scope.$watch(function(){return session.startDate},function(val,old){val!==old&&(session.pickerOpen=!session.pickerOpen)})),session.pickerOpen=!session.pickerOpen},this.autoRescheduleAlpha=function(){this.checkForms("reschedule","confirmRescheduleAlpha")},this.confirmRescheduleAlpha=function(){var startDate=dateSvc.combineDateTimeStringToDate(this.course.startDate,this.course.startTime,"hhmm"),that=this;this.courseSvc.reschedule(this.course.id,startDate,this.course.timezone).then(function(){that.loadCurrentCourse(),that.message={type:"success",text:gettextCatalog.getString('Your Alpha dates have been rescheduled. Check them below and click "Confirm & Save" to accept your changes.')}},function(){that.message={type:"danger",text:gettextCatalog.getString("We could not reschedule your Alpha at this time, please try again or contact support.")}})},this.toggleUnsubscribed=function(){this.course.subscribed=!this.course.subscribed},this.updateSessions=function(){this.checkForms("confirm","confirmUpdateSessions")},this.confirmUpdateSessions=function(){if(this.course.subscribed==crmSvc.profile.unsubscribed){var data={unsubscribed:!this.course.subscribed,id:crmSvc.profile.id},that=this;crmSvc.updateProfile(data)["finally"](function(){that.postSessionUpdate()})}else this.postSessionUpdate()},this.postSessionUpdate=function(){var dataPayload=[],startDate=null;for(that=this,i=0,len=this.course.sessions.length;i<len;i++){var session=this.course.sessions[i];startDate=dateSvc.combineDateTimeStringToDate(session.startDate,that.course.startTime,"hhmm"),dataPayload.push({UUID:session.UUID,start:dateSvc.dateToAPIFriendlyString(startDate)})}this.courseSvc.updateSessions(this.course.id,dataPayload).then(function(course){that.loadCurrentCourse(),that.message={type:"success",text:gettextCatalog.getString("Your sessions were updated.")},that.courseSvc.hasCompletedTask(course,"schedule")||that.courseSvc.completeTask(course,"schedule")["finally"](function(){coachingNotificationSvc.presentScheduled()}),$scope.sessionForm.$setPristine(),that.postSessionUpdateRedirect?$location.$$parse(that.postSessionUpdateRedirect):$timeout(function(){$location.path("/dashboard")},3e3)},function(){that.message={type:"danger",text:gettextCatalog.getString("We could not update your sessions at this time, please try again or contact support.")};var element=document.getElementById("page-top");smoothScroll(element,{duration:700,easing:"easeInOutQuad",offset:112})})},this.edit=function(){$location.path("/update-alpha")},this.checkForms=function(action,functionName){if("reschedule"===action){if(that.datesChanged)return void that.showDatesWarning(functionName)}else if("confirm"===action){if($scope.scheduleForm.$dirty)return void that.showRescheduleWarning(functionName)}else if("edit"===action){if($scope.scheduleForm.$dirty)return void that.showRescheduleWarning(functionName);if(that.datesChanged)return void that.showDatesWarning(functionName)}that[functionName]()},this.showRescheduleWarning=function(functionName){var modalInstance=$modal.open({templateUrl:"/templates/courses/reschedule-warning-modal.html",controller:"WarningInstanceController",windowClass:"modal-warning",size:"sm",backdrop:"static"});modalInstance.result.then(function(msg){that[functionName]()},function(){})},this.showDatesWarning=function(functionName){var modalInstance=$modal.open({templateUrl:"/templates/courses/dates-warning-modal.html",controller:"WarningInstanceController",windowClass:"modal-warning dates-warning-modal",size:"sm",backdrop:"static"});modalInstance.result.then(function(msg){"function"==typeof functionName?functionName(msg):that[functionName](msg)},function(){})},this.ical=function(){window.location=COURSES_API_BASE_URL+"/3/public/courses/"+this.course.id+"/ical"},this.session01DateChange=function(){for(var len=this.course.sessions.length,i=0;len>i;i++)if("S01"==this.course.sessions[i].UUID){this.course.startDate=this.course.sessions[i].startDate;break}this.datesChanged=!1,this.autoRescheduleAlpha()},$scope.$on("$locationChangeStart",function(event,next,current){that.datesChanged&&-1===next.indexOf("get-started/authenticate")&&(that.showDatesWarning(function(save){that.datesChanged=!1,save?(that.postSessionUpdateRedirect=next,that.updateSessions()):$location.$$parse(next)}),event.preventDefault())}),window.onbeforeunload=function(e){return that.datesChanged&&-1!==$location.path().indexOf("/schedule")?gettextCatalog.getString("Do you want to save the changes you've made to your Alpha's sessions?")+"\n"+gettextCatalog.getString("Your changes will be lost if you don't save them."):void 0}}]),angular.module("alphaBuilder").factory("sessionSvc",["$http","$q",function($http,$q){var API_BASE_URL="https://api.alpha.org";return{networkConnections:0,sessions:{},fetch:function(alpha,forceReload){var defer=$q.defer();if(!forceReload&&this.sessions.length>0)return defer.resolve(this.sessions),defer.promise;this.networkConnections++;var that=this;return $http.get(API_BASE_URL+"/public/package-session-by-session/"+alpha.packages+"/"+alpha.length).then(function(response){that.sessions=response.data.sessions,that.networkConnections--,defer.resolve(that.sessions)},function(error){that.networkConnections--,defer.reject()}),defer.promise}}}]),angular.module("alphaBuilder").controller("UpdateCourseController",["$scope","$location","courseSvc","authenticationSvc","gettextCatalog",function($scope,$location,courseSvc,authenticationSvc,gettextCatalog){authenticationSvc.performAuthCheck(),authenticationSvc.performCurrentAlphaCheck(),this.authSvc=authenticationSvc,authenticationSvc.isLoggedIn||$location.path("/"),this.message={type:null,text:null},this.updateCourse=function(course){var aCourse=angular.copy(course),id=aCourse.id;delete aCourse.id,delete aCourse.startDate,delete aCourse.startTime,aCourse.organisation=aCourse.organisation.id,aCourse.venueSameAsOrganisation?aCourse.venue=null:aCourse.venue=aCourse.venue.id,console.log(course);var that=this;courseSvc.update(id,aCourse).then(function(response){that.message={type:"success",text:gettextCatalog.getString("Your Alpha was updated.")}},function(error){that.message={type:"danger",text:gettextCatalog.getString("We could not update your Alpha at this time, please try again or contact support.")}})}}]),angular.module("alphaBuilder").factory("venueSvc",["$http","$q","tokenSvc",function($http,$q,tokenSvc){var COURSES_API_BASE_URL="https://courses-api.alpha.org";return{networkActivity:!1,venues:[],fetch:function(forceReload){var defer=$q.defer();if(!forceReload&&this.venues.length>0)return defer.resolve(this.venues),defer.promise;if(this.networkActivity)return defer.reject(),defer.promise;this.networkActivity=!0;var that=this;return $http.get(COURSES_API_BASE_URL+"/3/venues",{headers:{Authorization:"Bearer "+tokenSvc.session.token}}).then(function(response){that.venues=response.data.venues,that.networkActivity=!1,defer.resolve(that.venues)},function(error){that.networkActivity=!1,defer.reject()}),defer.promise},create:function(venue){var defer=$q.defer();if(this.networkActivity)return defer.reject(),defer.promise;this.networkActivity=!0;var that=this;return $http.post(COURSES_API_BASE_URL+"/3/venues",venue,{headers:{Authorization:"Bearer "+tokenSvc.session.token}}).then(function(response){var newVenue=response.data.venue;that.venues.push(newVenue),that.networkActivity=!1,defer.resolve(newVenue)},function(data){that.networkActivity=!1,defer.reject()}),defer.promise},update:function(venue){var defer=$q.defer();if(this.networkActivity)return defer.reject(),defer.promise;var updatedVenue=angular.copy(venue),id=updatedVenue.id;id||defer.reject(),delete updatedVenue.id,this.networkActivity=!0;var that=this;return $http.put(COURSES_API_BASE_URL+"/3/venues/"+id,updatedVenue,{headers:{Authorization:"Bearer "+tokenSvc.session.token}}).then(function(response){var i=0,num=that.venues.length,theUpdatedVenue=response.data.venue;for(i;num>i;i++)that.venues[i].id==theUpdatedVenue.id&&(that.venues[i]=theUpdatedVenue);that.networkActivity=!1,defer.resolve(theUpdatedVenue)},function(data){that.networkActivity=!1,defer.reject()}),defer.promise}}}]),angular.module("alphaBuilder").controller("WarningInstanceController",["$scope","$modalInstance",function($scope,$modalInstance){$scope.ok=function(){$modalInstance.close()},$scope.save=function(){$modalInstance.close(!0)},$scope.cancel=function(){$modalInstance.dismiss()}}]),angular.module("alphaBuilder").factory("afterAlphaSvc",["$http","$q","translationSvc",function($http,$q,translationSvc){var API_BASE_URL="https://api.alpha.org",locale=translationSvc.locale;return{networkConnections:0,tiles:{primary:[],other:[]},fetch:function(forceReload){var defer=$q.defer();if(!forceReload&&_.has(this.tiles,"primary")&&this.tiles.primary.length>0)return defer.resolve(this.tiles),defer.promise;this.networkConnections++;var that=this;return $http.get(API_BASE_URL+"/public/"+locale+"/after-alpha-tiles").then(function(response){that.tiles=response.data.sections,that.networkConnections--,defer.resolve(that.tiles)},function(error){that.networkConnections--,defer.reject()}),defer.promise}}}]),angular.module("alphaBuilder").factory("alphaService",["$http",function($http){return{currentAlpha:null,fetchAlpha:function(id){},fetchMyCurrentAlphas:function(){}}}]),angular.module("alphaBuilder").controller("DashboardController",["$scope","$modal","$window","$timeout","$location","$anchorScroll","alphaService","authenticationSvc","dateSvc","sessionSvc","packageSvc","courseSvc","coachingNotificationSvc","resizeTiles","delayedActionSvc","smoothScroll","gettextCatalog",function($scope,$modal,$window,$timeout,$location,$anchorScroll,alphaService,authenticationSvc,dateSvc,sessionSvc,packageSvc,courseSvc,coachingNotificationSvc,resizeTiles,delayedActionSvc,smoothScroll,gettextCatalog){authenticationSvc.performAuthCheck(),authenticationSvc.performCurrentAlphaCheck(),this.alphaSvc=alphaService,this.courseSvc=courseSvc,this.isAlphaCurrentlyRunning=!1,this.hasAlphaBeenPlanned=!0,this.sessions=[],this.sessionsUnlocked=!1,this.sessionBySessionReady=!1,this.inviteContent=null,this.sessionBySessionDisabled=!1,authenticationSvc.registerObserver("dashboardController",this),this.authChanged=function(){var that=this;$timeout(function(){that.loadCurrentCourse()})},courseSvc.registerObserver("dashboardController",this),this.coursesChanged=function(){var that=this;$timeout(function(){that.loadCurrentCourse()})},this.processSessions=function(products){var course=authenticationSvc.sessionData.currentAlpha;if(course){if(_.has(course,"sessions")&&_.isArray(course.sessions)&&void 0!==products){var sessions=coachingNotificationSvc.processSessions(course.sessions),courseEndDate=dateSvc.stringToDate(authenticationSvc.sessionData.currentAlpha.finish,"YYYY-MM-DDThh:mm:ss"),sessionsUnlocked=this.sessionsUnlocked;
_.forEach(sessions,function(session){var sessionProducts=_.sortBy(products[session.UUID],"priority");session.unlock(courseEndDate,sessionsUnlocked).setProducts(sessionProducts)}),_.sortByOrder(sessions,["start","UUID"],[!0,!0]);var afterAlphaIndex=_.findIndex(sessions,{UUID:"A01"});if(-1!=afterAlphaIndex){var afterAlpha=_.pullAt(sessions,afterAlphaIndex);sessions.push(afterAlpha[0])}this.sessions=sessions}if(0==this.sessions.length)this.sessionBySessionDisabled=!0;else{if(sessionsUnlocked)var nextSession=coachingNotificationSvc.nextSession(authenticationSvc.sessionData.currentAlpha);void 0===nextSession&&(nextSession={UUID:"P01"}),this.selectSession(nextSession.UUID),this.sessionBySessionReady=!0}$scope.course=this.course;var delayedSessionUUID=delayedActionSvc.getDelayedSession();void 0!==delayedSessionUUID&&that.selectSession(delayedSessionUUID)}},this.loadCurrentCourse=function(){var currentCourse=authenticationSvc.sessionData.currentAlpha;this.sessionBySessionReady=!1,this.sessionBySessionDisabled=!1,this.sessions=[],this.inviteContent=null,this.sessionsUnlocked=this.courseSvc.hasCompletedTask(authenticationSvc.sessionData.currentAlpha,"schedule");var that=this;sessionSvc.fetch(currentCourse,!0).then(function(products){that.processSessions(products)},function(){}),this.courseSvc.inviteEmailContent(currentCourse).then(function(content){that.inviteContent=content},function(){}),0!=currentCourse.sessions.length&&(courseSvc.hasCompletedTask(currentCourse,"trained")||(_.isArray(currentCourse.tasks)&&currentCourse.tasks.length>=5?courseSvc.completeTask(currentCourse,"trained").then(function(){coachingNotificationSvc.presentTrainingDone()},function(){}):coachingNotificationSvc.pastFirstTrainingDate(currentCourse)&&!coachingNotificationSvc.hasCourseStarted(currentCourse)&&coachingNotificationSvc.pastFirstTrainingDate(currentCourse)&&courseSvc.completeTask(currentCourse,"trained").then(function(){},function(){})))},this.loadCurrentCourse(),this.selectSession=function(sessionUUID){var that=this;angular.forEach(this.sessions,function(aSession){aSession&&aSession.UUID==sessionUUID&&(that.currentSession=null,$timeout(function(){that.currentSession=aSession}))}),this.iconTitle=this.calculateIconTitle(sessionUUID)},this.editSession=function(session){$modal.open({templateUrl:"/templates/dashboard/edit-session-modal.html",controller:"EditSessionController",controllerAs:"editSessionCtrl",windowClass:"modal-edit-session",size:"sm",resolve:{session:function(){return session}}})},this.currentSession=null,this.calculateIconTitle=function(sessionUUID){switch(sessionUUID[0]){case"S":return parseInt(sessionUUID);case"W":return gettextCatalog.getString("W")+parseInt(sessionUUID);case"T":return gettextCatalog.getString("T")+parseInt(sessionUUID);case"P":return gettextCatalog.getString("P");case"A":return gettextCatalog.getString("A")}},$(document).ready(function(){$(window).resize(function(){resizeTiles()})}),this.performDelayedAction=function(anchor,session){this.selectSession(session),this.scrollToAnchor(anchor)};var that=this;$timeout(function(){var anchor=delayedActionSvc.getDelayedAnchor();void 0!==anchor&&that.scrollToAnchor(anchor)}),this.scrollToAnchor=function(anchor){var element=document.getElementById(anchor);smoothScroll(element,{duration:700,easing:"easeInOutQuad",offset:112})},$scope.$on("$destroy",function(){courseSvc.removeObserver("dashboardController")}),delayedActionSvc.setDelegate(this)}]),angular.module("alphaBuilder").directive("abSessionSlider",["$timeout",function($timeout){return{restrict:"E",templateUrl:"/templates/dashboard/session-slider.html"}}]),angular.module("alphaBuilder").directive("abSessionSliderItems",["$timeout",function($timeout){return{link:function(scope,elem,attr){scope.$last&&$timeout(function(){$(document).ready(function(){function setupSessionSlider(){arrowWidth=$("#session-slider .arrow.backwards").width(),beltItems=$("#session-slider .belt > .slider-item"),num=beltItems.length,width=beltItems.first().width(),navigationWidth=2*arrowWidth,beltWidth=num*width,$("#session-slider .belt").width(beltWidth)}function refreshSessionSliderUI(){screenWidth=$(window).width(),outerContainerWidth=$(".session-nav").width(),maxNum=Math.floor((outerContainerWidth-navigationWidth)/width),maxNum>num&&(maxNum=num),containerWidth=maxNum*width,leftOffset=(outerContainerWidth-containerWidth)/2,$("#session-slider .container").css("left",leftOffset+"px"),$("#session-slider .container").width(containerWidth+"px"),refreshArrows();var currentOffset=Math.abs(parseInt($("#session-slider .belt").css("left"))),beltWidth=num*width;containerWidth>beltWidth-currentOffset&&$("#session-slider .belt").css("left",containerWidth-beltWidth+"px")}function refreshArrows(){maxNum===num?($("#session-slider .arrow.backwards").addClass("disabled"),$("#session-slider .arrow.forwards").addClass("disabled"),$("#session-slider .arrow").hide(),allowPanning=!1):0===beltStartingIndex()?($("#session-slider .arrow").show(),$("#session-slider .arrow.backwards").addClass("disabled"),$("#session-slider .arrow.forwards").removeClass("disabled"),allowPanning=!0):beltEndingIndex()===num?($("#session-slider .arrow").show(),$("#session-slider .arrow.backwards").removeClass("disabled"),$("#session-slider .arrow.forwards").addClass("disabled"),allowPanning=!0):($("#session-slider .arrow").show(),$("#session-slider .arrow.backwards").removeClass("disabled"),$("#session-slider .arrow.forwards").removeClass("disabled"),allowPanning=!0)}function beltStartingIndex(){var beltOffset=Math.abs(Math.floor(parseInt($("#session-slider .belt").css("left"))/width));return beltOffset}function beltEndingIndex(){return beltStartingIndex()+maxNum}function moveToActive(){if(maxNum!==num){var activeItemIndex=$("#session-slider .belt .slider-item.active").index(),beltOffset=activeItemIndex*width;containerWidth>beltWidth-beltOffset&&(beltOffset=beltWidth-containerWidth),$("#session-slider .belt").css("left",-beltOffset+"px"),refreshArrows()}}function moveBeltForwards(){var startingIndex=Math.abs(Math.ceil(parseInt($("#session-slider .belt").css("left"))/width)),extra=num-(startingIndex+maxNum);extra>maxNum&&(extra=maxNum);var currentOffset=(parseInt($("#session-slider .belt").css("left")),-(width*startingIndex)),beltOffset=currentOffset-extra*width;animating=!0,$("#session-slider .belt").animate({left:beltOffset},500,function(){animating=!1,refreshArrows()})}function moveBeltBackwards(){var startingIndex=beltStartingIndex(),extra=startingIndex;extra>maxNum&&(extra=maxNum);var currentOffset=-(width*startingIndex),beltOffset=currentOffset+extra*width;animating=!0,$("#session-slider .belt").animate({left:beltOffset},500,function(){animating=!1,refreshArrows()})}function handleStart(event){if(allowPanning)for(var touches=event.changedTouches,i=0;i<touches.length;i++)0==i&&(lastPosition=event.changedTouches[i].pageX)}function handleMove(event){if(allowPanning)for(var touches=event.changedTouches,i=0;i<touches.length;i++)if(0==i){var nowPosition=event.changedTouches[i].pageX,moved=nowPosition-lastPosition;beltElement.style.left?beltElement.style.left=parseInt(beltElement.style.left)+moved+"px":beltElement.style.left=moved+"px",parseInt(beltElement.style.left)>0&&(beltElement.style.left="0px");var currentOffset=Math.abs(parseInt(beltElement.style.left)),beltWidth=num*width;containerWidth>beltWidth-currentOffset&&(beltElement.style.left=containerWidth-beltWidth+"px"),lastPosition=nowPosition}}function handleEnd(event){allowPanning&&refreshArrows()}function handleCancel(event){if(allowPanning){refreshArrows();for(var touches=event.changedTouches,i=0;i<touches.length;i++)ongoingTouches.splice(i,1)}}function addTouchListeners(){beltElement.addEventListener("touchstart",handleStart,!1),beltElement.addEventListener("touchend",handleEnd,!1),beltElement.addEventListener("touchcancel",handleCancel,!1),beltElement.addEventListener("touchleave",handleEnd,!1),beltElement.addEventListener("touchmove",handleMove,!1)}var arrowWidth=0,beltItems=0,num=0,width=0,beltWidth=0,outerContainerWidth=0,screenWidth=0,navigationWidth=0,maxNum=0,containerWidth=0,leftOffset=0,animating=!1,allowPanning=!1,beltElement=$("#session-slider .belt")[0],lastPosition=void 0;setupSessionSlider(),refreshSessionSliderUI(),addTouchListeners(),moveToActive(),$(window).resize(function(){refreshSessionSliderUI()}),$("#session-slider .arrow.forwards").click(function(event){event.preventDefault(),animating||$(this).hasClass("disabled")||moveBeltForwards()}),$("#session-slider .arrow.backwards").click(function(event){event.preventDefault(),animating||$(this).hasClass("disabled")||moveBeltBackwards()})})})}}}]),angular.module("alphaBuilder").directive("abSessionDetail",["$modal","getStartedSvc","afterAlphaSvc","authenticationSvc",function($modal,getStartedSvc,afterAlphaSvc,authenticationSvc){return{restrict:"E",scope:{session:"="},templateUrl:function(element,attrs){return void 0===attrs.type&&(attrs.type="session"),"/templates/dashboard/"+attrs.type+".html"},link:function(scope){scope.getStartedSvc=getStartedSvc,scope.authSvc=authenticationSvc,scope.primaryTiles=[],scope.otherTiles=[],afterAlphaSvc.fetch().then(function(sections){var groupedPrimaryTiles=_.chunk(sections.primary,3),lastGroup=_.last(groupedPrimaryTiles);if(_.isArray(lastGroup)&&3!=lastGroup.length&&groupedPrimaryTiles.length>1){var last=_.takeRight(groupedPrimaryTiles)[0];groupedPrimaryTiles=_.dropRight(groupedPrimaryTiles);var newLast=_.last(groupedPrimaryTiles).concat(last);groupedPrimaryTiles[groupedPrimaryTiles.length-1]=newLast}scope.primaryTiles=groupedPrimaryTiles;var groupedOtherTiles=_.chunk(sections.other,3),lastGroup=_.last(groupedOtherTiles);if(_.isArray(lastGroup)&&3!=lastGroup.length&&groupedOtherTiles.length>1){var last=_.takeRight(groupedOtherTiles)[0];groupedOtherTiles=_.dropRight(groupedOtherTiles);var newLast=_.last(groupedOtherTiles).concat(last);groupedOtherTiles[groupedOtherTiles.length-1]=newLast}scope.otherTiles=groupedOtherTiles},function(){})}}}]),angular.module("alphaBuilder").controller("EditSessionController",["$scope","$modalInstance","$locale","dateSvc","session","courseSvc","authenticationSvc","gettextCatalog","translationSvc",function($scope,$modalInstance,$locale,dateSvc,session,courseSvc,authenticationSvc,gettextCatalog,translationSvc){authenticationSvc.performAuthCheck();var locale=translationSvc.locale,that=this;this.courseSvc=courseSvc,this.session=session,this.courseSvc.fetchAllData(locale).then(function(){this.ready=!0},function(){}),this.session.timezone=authenticationSvc.sessionData.currentAlpha.timezone,this.updateSession=function(){var dataPayload=[],startDate=null;that=this,startDate=dateSvc.combineDateTimeStringToDate(this.session.startDate,this.session.startTime,"hhmm"),dataPayload.push({UUID:this.session.UUID,start:dateSvc.dateToAPIFriendlyString(startDate)}),this.courseSvc.updateSessions(authenticationSvc.sessionData.currentAlpha.id,dataPayload,this.session.timezone).then(function(){that.message={type:"success",text:gettextCatalog.getString("Session details updated.")},$modalInstance.close("done")},function(){that.message={type:"danger",text:gettextCatalog.getString("We could not update your session at this time, please try again or contact support.")}})},this.startDatePicker={opened:!1,dateOptions:{formatYear:"yy",startingDay:1,formatDayHeader:"EEE",showWeeks:!1},format:$locale.DATETIME_FORMATS.shortDate,openPicker:function($event){$event.preventDefault(),$event.stopPropagation(),this.opened=!0}},$scope.$on("abLocaleChanged",function(event,params){that.startDatePicker.format=$locale.DATETIME_FORMATS.shortDate}),this.close=function(){$modalInstance.close("done")}}]),angular.module("alphaBuilder").controller("EventCtrl",["$scope","$routeParams","eventSvc","resizeTiles",function($scope,$routeParams,eventSvc,resizeTiles){this.event=eventSvc.fetchEvent($routeParams.eventId),this.eventService=eventSvc,resizeTiles(),$(window).resize(function(){resizeTiles()})}]),angular.module("alphaBuilder").factory("eventSvc",["$http","cacheSvc",function($http,cacheSvc){var API_BASE_URL="https://api.alpha.org";return{networkActivity:!1,ready:!1,event:null,related:[],fetchEvent:function(eventId){if(this.ready=!1,this.event=null,this.related=[],void 0!==cacheSvc.tiles[eventId]){var event=cacheSvc.tiles[eventId];return this.processEvent(event,!1),this.ready=!0,void(this.networkActivity=!1)}this.fetchRelated(eventId),this.networkActivity=!0;var that=this;$http.get(API_BASE_URL+"/public/events/"+eventId).then(function(data){var event=data.data.event;that.processEvent(event,!0),that.ready=!0,that.networkActivity=!1},function(data){that.ready=!1,that.networkActivity=!1})},processEvent:function(event,updateCache){this.fetchRelated(event.id),this.event=event,updateCache&&(cacheSvc.tiles[event.id]=event)},fetchRelated:function(eventId){this.networkActivity=!0,this.related=[];var that=this;$http.get(API_BASE_URL+"/public/tile/"+eventId+"/related").then(function(data){for(var i=0;i<data.data.tiles.length;i++){var tile=data.data.tiles[i];cacheSvc.tiles[data.data.tiles[i].id]=data.data.tiles[i],that.related.push(tile)}0==data.data.tiles.length&&($(".loading-tile").remove(),$(".main .content").addClass("col-sm-12").removeClass("col-sm-6")),that.ready=!0,that.networkActivity=!1},function(data){that.ready=!0,that.networkActivity=!1})}}}]),angular.module("alphaBuilder").factory("carouselSvc",["$q","$http","$rootScope","tmhDynamicLocale","gettextCatalog","translationSvc",function($q,$http,$rootScope,tmhDynamicLocale,gettextCatalog,translationSvc){var API_BASE_URL="https://api.alpha.org";return{locale:translationSvc.locale,settings:void 0,networkConnections:0,ready:!1,requestTimeout:void 0,fetchCarousel:function(){var defer=$q.defer();this.requestTimeout&&this.requestTimeout.resolve(),this.requestTimeout=$q.defer(),this.networkConnections++;var that=this;return $http.get(API_BASE_URL+"/public/"+translationSvc.locale+"/settings",{timeout:this.requestTimeout.promise}).then(function(response){response.data.settings?that.settings=response.data.settings:that.settings=void 0,defer.resolve(that.settings)},function(data){that.settings=void 0,defer.reject()})["finally"](function(){that.networkConnections--}),defer.promise},fileDownload:function(id){var defer=$q.defer();this.requestTimeout&&this.requestTimeout.resolve(),this.requestTimeout=$q.defer(),this.networkConnections++;var that=this;return $http.get(API_BASE_URL+"/media/files/d/"+id+"/download").then(function(data){console.log(data)},function(data){that.settings=void 0,defer.reject()})["finally"](function(){that.networkConnections--}),defer.promise}}}]),angular.module("alphaBuilder").controller("ExploreCtrl",["$scope","$timeout","homeTilesSvc","homeQuotesSvc","resizeTiles","translationSvc","carouselSvc",function($scope,$timeout,homeTilesSvc,homeQuotesSvc,resizeTiles,translationSvc,carouselSvc){this.translationSvc=translationSvc;var promise=carouselSvc.fetchCarousel();promise.then(function(){$scope.alphaTalk=function(){return carouselSvc.settings.hasOwnProperty("carouselOne")&&carouselSvc.settings.carouselOne?($scope.alphaTalk2=carouselSvc.settings.carouselOne.boxes,carouselSvc.settings.carouselOne.boxes):null},$scope.alphaTraining=function(){return carouselSvc.settings.hasOwnProperty("carouselTwo")&&carouselSvc.settings.carouselTwo?($scope.alphaTraining2=carouselSvc.settings.carouselTwo.boxes,carouselSvc.settings.carouselTwo.boxes):null}},function(reason){}),this.ready=!0,$timeout(function(){$scope.loaded=!0,angular.element(document).trigger("resize")},350)}]),angular.module("alphaBuilder").directive("abAlphaTalkVideo",["$modal",function($modal){return{restrict:"E",templateUrl:"/templates/explore/explore-alpha-video-button.html",link:function(scope,element,attrs){scope.open=function(url,desc){scope.modalInstance=$modal.open({templateUrl:"/templates/explore/explore-alpha-video-modal.html",windowClass:"modal-explore-alpha-videos",size:"lg",keyboard:!1,controller:["$scope","$modalInstance",function($scope,$modalInstance){$scope.close=function(){$modalInstance.dismiss()},$scope.url=url,$scope.description=desc}]})}}}}]),angular.module("alphaBuilder").directive("abAlphaContext",function(){return{restrict:"E",templateUrl:"/templates/explore/alpha-context.html",link:function(scope,element,attrs){function changeItem(){var activeItemId=angular.element(".contexts-container .slick-list").find(".slick-active").attr("id"),activeItemIndex=angular.element("#"+activeItemId).index(),nextItemIndex=activeItemIndex+1;10===nextItemIndex&&(nextItemIndex=3);var nextItemId=angular.element(".contexts-container .item").eq(nextItemIndex).attr("id"),nextItemDescId="#"+nextItemId+"-desc";angular.element(".context-description-cont .selected").hide(),angular.element(".context-description-cont "+nextItemDescId).addClass("selected").show()}var winWidth=angular.element(window).width();winWidth>=1025?(scope.layout="desktop",scope.slideToShow=7):(scope.layout="mobile",scope.slideToShow=3),$(window).resize(function(){var winWidth=angular.element(window).width();winWidth>=1025?(scope.layout="desktop",scope.slideToShow=7):(scope.layout="mobile",scope.slideToShow=3)}),$(window).load(function(){var winWidth=angular.element(window).width();winWidth>=1025?(scope.layout="desktop",scope.slideToShow=7):(scope.layout="mobile",scope.slideToShow=3)}),angular.element(document).on("click",".contexts-container .slick-next",function(){changeItem()}),angular.element(document).on("click",".contexts-container .slick-prev",function(){changeItem()}),angular.element(document).on("click",".contexts-container .item",function(){if("desktop"===scope.layout){var itemId=angular.element(this).attr("id");angular.element(".contexts-container .item").removeClass("selected"),angular.element(".icon-cont").removeClass("selected"),angular.element(this).addClass("selected"),angular.element(this).children(".icon-cont").addClass("selected"),angular.element(".context-description-cont .selected").hide(),angular.element("#"+itemId+"-desc").addClass("selected").show()}})}}}),angular.module("alphaBuilder").directive("abAlphaKey",function(){return{restrict:"E",templateUrl:"/templates/explore/alpha-key.html",link:function(scope,element,attrs){angular.element(".full-desc").on("mouseleave touchend",function(){angular.element(".title").show(),angular.element(this).hide()}),angular.element("#ak-food").hover(function(){angular.element(this).parent().parent().hide(),angular.element("#ak-food-desc").show()}),angular.element("#ak-talk").hover(function(){angular.element(this).parent().parent().hide(),angular.element("#ak-talk-desc").show()}),angular.element("#ak-discussion").hover(function(){angular.element(this).parent().parent().hide(),angular.element("#ak-discussion-desc").show()})}}}),angular.module("alphaBuilder").directive("abDefaultContextOnMobile",function(){return{restrict:"E",templateUrl:"/templates/explore/default-context-on-mobile.html",link:function($window,scope){angular.element(window).width()<=1025&&angular.element("#wia-context .contexts-container .slick-prev").click(),$(window).load(function(){$(".slick-prev").is(":visible")===!0&&$(".slick-prev").click()}),$(window).load(function(){var width=$(".slick-slide").css("width"),contextWidth=$(".contexts-container").find("#youth-context").css("width");"0px"===width&&$(".slick-slide").click(function(){}),"0px"===contextWidth&&($(".slick-prev").click(),$("#youth-context").click())}),angular.element(".ac-get-started").click(function(){angular.element(".get-started").click()})}}}),angular.module("alphaBuilder").controller("FaqsCtrl",["$scope","faqsSvc",function($scope,faqsSvc){this.service=faqsSvc,$scope.$on("abLocaleChanged",function(event,params){faqsSvc.getFAQs()}),faqsSvc.getFAQs()}]),angular.module("alphaBuilder").directive("abFaq",function(){return{restrict:"E",scope:{faq:"="},templateUrl:"./templates/faqs/faq.html"}}),angular.module("alphaBuilder").factory("faqsSvc",["$http","$q","translationSvc",function($http,$q,translationSvc){var API_BASE_URL="https://api.alpha.org";return{networkActivity:!1,faqs:[],fetchedLocale:void 0,requestTimeout:void 0,getFAQs:function(){var locale=translationSvc.locale;if(!(this.faqs.length>0&&this.fetchedLocale==locale)){this.requestTimeout&&this.requestTimeout.resolve(),this.requestTimeout=$q.defer(),this.networkActivity=!0;var that=this;$http.get(API_BASE_URL+"/public/"+locale+"/faqs?limit=100",{timeout:this.requestTimeout.promise}).then(function(response){that.faqs=[],response.data.hasOwnProperty("faqs")&&(that.faqs=response.data.faqs,that.fetchedLocale=locale),that.networkActivity=!1},function(data){that.networkActivity=!1})}}}}]),angular.module("alphaBuilder").controller("GetStartedController",["$scope","$modalInstance","$compile","$location","getStartedSvc","crmSvc",function($scope,$modalInstance,$compile,$location,getStartedSvc,crmSvc){this.service=getStartedSvc,null===this.service.answers.name&&(this.service.answers.name=null!==crmSvc.profile.firstName&&null!==crmSvc.profile.lastName?crmSvc.profile.firstName+" "+crmSvc.profile.lastName:null),this.close=function(){$modalInstance.dismiss()},getStartedSvc.scope=$scope,getStartedSvc.getOptions(!0),this.showProducts=!1,this.showVideo=function(){getStartedSvc.playingVideo=!0;var that=this;$scope.$on("youtube.player.ended",function($event,player){that.service.playingVideo=!1})},this.toggleShowProducts=function(){1==this.showProducts?this.showProducts=!1:this.showProducts=!0},this.selectNewPackage=function(aPackage){getStartedSvc.setPackage(aPackage),getStartedSvc.playingVideo=!1,$(".product-video").html("")},this.finish=function(){getStartedSvc.saveResult(),$modalInstance.close(),$location.path("/get-started/authenticate")}}]),angular.module("alphaBuilder").directive("abGetStarted",["getStartedSvc","gettextCatalog",function(getStartedSvc,gettextCatalog){return{restrict:"E",scope:{},templateUrl:"./templates/getStarted/get-started-button.html",link:function(scope,element,attrs){scope.title=attrs.title?attrs.title:gettextCatalog.getString("Build your Alpha"),scope.open=function(){getStartedSvc.openModal()}}}}]),angular.module("alphaBuilder").directive("abChooseProduct",["getStartedSvc","$modal",function(getStartedSvc,$modal){return{restrict:"E",scope:{abProductId:"="},templateUrl:"./templates/getStarted/choose-product-button.html",link:function(scope,element,attrs){element.hide(),scope.$watch("abProductId",function(newValue,oldValue){newValue&&(getStartedSvc.forcedProductId=scope.abProductId,getStartedSvc.getOptions(!0)["finally"](function(){angular.forEach(getStartedSvc.defaultPackages,function(anotherPackage){anotherPackage.mainProduct.id===scope.abProductId&&element.show()}),getStartedSvc.wipe()}))}),scope.open=function(){getStartedSvc.openModal(void 0,scope.abProductId)}}}}]),angular.module("alphaBuilder").directive("abGetStartedBlock",function(){return{restrict:"E",scope:{},templateUrl:"./templates/getStarted/get-started-block.html"}}),angular.module("alphaBuilder").factory("getStartedSvc",["$http","$q","$modal","$timeout","crmSvc","translationSvc","productSvc",function($http,$q,$modal,$timeout,crmSvc,translationSvc,productSvc){var API_BASE_URL="https://api.alpha.org",STORAGE_ID="alpha-builder-get-started",object={observers:[],networkActivity:!1,ready:!1,options:null,whos:[],hows:[],contexts:[],answers:{name:null,who:null,how:null,contexts:[],numSessions:null,chosenPackage:null,course:null},scope:null,stage:1,suggestedProduct:null,suggestedProductLengths:[],defaultPackages:[],otherPackages:[],animationDirection:!0,playingVideo:!1,forcedProductId:null,fetchedLocale:void 0,requestTimeout:void 0,getOptions:function(preload){var defer=$q.defer(),locale=translationSvc.locale;if(this.options&&this.fetchedLocale==locale&&!preload&&(!this.forcedProductId||this.fetchedLocale==productSvc.product.locale))return defer.reject(),defer.promise;this.requestTimeout&&this.requestTimeout.resolve(),this.requestTimeout=$q.defer(),this.networkActivity=!0;var that=this,optionsLocale=this.forcedProductId?productSvc.product.locale:translationSvc.locale;return $http.get(API_BASE_URL+"/public/"+optionsLocale+"/get-started-options",{timeout:this.requestTimeout.promise}).then(function(response){that.options=response.data.options,that.defaultPackages=response.data.defaultPackages,that.whos=[],angular.forEach(that.options.whos,function(value,key){that.whos.push({key:key,label:value.label})}),that.fetchedLocale=locale,that.networkActivity=!1,void 0!==preload&&(that.ready=!0),defer.resolve()},function(data){that.networkActivity=!1,defer.reject()}),defer.promise},getAnswers:function(packageId){var defer=$q.defer();this.networkActivity=!0;var that=this;return $http.get(API_BASE_URL+"/public/answers-for-package/"+packageId).then(function(response){that.networkActivity=!1,defer.resolve(response.data)},function(response){that.networkActivity=!1,defer.reject()}),defer.promise},getSuggestedProduct:function(){if(null!==this.forcedProductId){var that=this;angular.forEach(this.defaultPackages,function(anotherPackage){anotherPackage.mainProduct.id===that.forcedProductId&&(that.setPackage(anotherPackage),that.forcedProductId=null)})}else{var gsPackage=this.options.whos[this.answers.who].hows[this.answers.how].contexts[this.answers.contexts[0]]["package"];this.setPackage(gsPackage)}this.playingVideo=!1},setPackage:function(aPackage){this.answers.chosenPackage=aPackage.id,this.suggestedProduct=aPackage.mainProduct;var that=this,lengths=[],chosenLength=this.answers.numSessions;angular.forEach(aPackage.mainProduct.lengths,function(value,key){1==value.isDefault&&(that.answers.numSessions=key),lengths.push({key:key,label:value.label,isDefault:value.isDefault})}),this.suggestedProductLengths=lengths,angular.forEach(this.suggestedProductLengths,function(value){value.key==chosenLength&&(that.answers.numSessions=chosenLength)});var packages=new Array;angular.forEach(this.defaultPackages,function(anotherPackage){anotherPackage.mainProduct.id!=that.suggestedProduct.id&&packages.push(anotherPackage)}),this.otherPackages=packages,this.notifyObservers()},addName:function(name){this.answers.name=name,this.goTo(2,!0)},populateHows:function(){var that=this;this.hows=[],angular.forEach(this.options.whos[this.answers.who].hows,function(value,key){that.hows.push({key:key,label:value.label})})},addWho:function(who){this.answers.who=who,this.populateHows(),this.goTo(3,!0)},populateContexts:function(restore){var that=this,currentContexts=this.answers.contexts;this.contexts=[],this.answers.contexts=[],angular.forEach(this.options.whos[this.answers.who].hows[this.answers.how].contexts,function(value,key){value.hidden||(that.contexts.push({key:key,label:value.label}),currentContexts.indexOf(key)>-1&&that.answers.contexts.push(key))}),restore&&0==this.answers.contexts.length&&this.answers.contexts.push("none")},addHow:function(how){this.answers.how=how,this.populateContexts(),this.goTo(4,!0)},addContexts:function(contexts){0==contexts.length&&contexts.push("none"),this.answers.contexts=contexts,this.getSuggestedProduct(),this.goTo(5,!0)},goTo:function(stage,canGoForward){if(canGoForward="undefined"!=typeof canGoForward?canGoForward:!1,canGoForward||stage<this.stage){this.animationDirection=this.stage<=stage?!1:!0,this.direction=this.stage<=stage?"forwards":"backwards";var that=this;$timeout(function(){that.stage=stage,that.playingVideo=!1})}},isCurrentStep:function(stage){return this.stage==stage},isStepActive:function(stage){return this.stage>stage},isWho:function(who){return this.answers.who==who?!0:!1},isHow:function(how){return this.answers.how==how?!0:!1},isLength:function(length){return this.answers.numSessions==length?!0:!1},canLengthGoBack:function(currentLength){var currentIndex=null;angular.forEach(this.suggestedProductLengths,function(aLength,key){aLength.key==currentLength&&(currentIndex=key)});var newIndex=currentIndex-1;return void 0!==this.suggestedProductLengths[newIndex]?!0:!1},canLengthGoForward:function(currentLength){var currentIndex=null;angular.forEach(this.suggestedProductLengths,function(aLength,key){aLength.key==currentLength&&(currentIndex=key)});var newIndex=currentIndex+1;return void 0!==this.suggestedProductLengths[newIndex]?!0:!1},moveLength:function(direction){var that=this,currentIndex=null;angular.forEach(this.suggestedProductLengths,function(aLength,key){aLength.key==that.answers.numSessions&&(currentIndex=key)}),"forwards"==direction?this.canLengthGoForward(this.answers.numSessions)&&(this.answers.numSessions=this.suggestedProductLengths[currentIndex+1].key):this.canLengthGoBack(this.answers.numSessions)&&(this.answers.numSessions=this.suggestedProductLengths[currentIndex-1].key)},saveResult:function(){localStorage.setItem(STORAGE_ID,JSON.stringify(this.answers))},restoreResult:function(){var localData=localStorage.getItem(STORAGE_ID)||null;if(localData){var data=JSON.parse(localData);return void 0===data.name||null===data.name?!1:(this.answers.name=data.name,this.answers.who=data.who,this.answers.how=data.how,this.answers.contexts=data.contexts,this.answers.numSessions=data.numSessions,this.answers.chosenPackage=data.chosenPackage,this.answers.course=data.course,!0)}return!1},wipe:function(save){this.answers.name=null,this.answers.who=null,this.answers.how=null,this.answers.contexts=[],this.answers.numSessions=null,this.answers.chosenPackage=null,this.answers.course=null,this.stage=1,this.suggestedProduct=null,this.suggestedProductLengths=[],this.animationDirection=!0,this.playingVideo=!1,this.forcedProductId=null,save&&this.saveResult()},openModal:function(stage,forceProductId,course){if(void 0!==stage){if(this.stage=stage,this.stage>=2){var that=this;this.ready=!1,this.getOptions()["finally"](function(){void 0!==course?that.duplicate(course):(that.stage>=3&&that.populateHows(),that.stage>=4&&that.populateContexts(!0),that.stage>=5&&that.getSuggestedProduct(),forceProductId&&(that.forcedProductId=forceProductId,that.saveResult()),that.ready=!0)})}}else void 0!==forceProductId?(this.wipe(!1),this.forcedProductId=forceProductId,this.saveResult()):this.wipe(!0);var modalInstance=$modal.open({templateUrl:"/templates/getStarted/get-started-modal.html",controller:"GetStartedController",controllerAs:"getStartedCtrl",windowClass:"modal-get-started",size:"lg"}),that=this;modalInstance.result.then(function(){},function(){that.wipe(!0)})},registerObserver:function(callback){this.observers.push(callback)},notifyObservers:function(){var i=0,num=this.observers.length;for(i;num>i;i++)this.observers[i].packageChanged()},duplicate:function(course){this.ready=!1;var packageId=course.packages[0],that=this;this.getAnswers(packageId).then(function(data){that.answers.name=course.contact,that.answers.who=data.answers.who,that.answers.how=data.answers.how,that.answers.contexts=data.answers.contexts,that.answers.numSessions=course.length,that.answers.chosenPackage=packageId,that.answers.course=course,that.stage>=3&&that.populateHows(),that.stage>=4&&that.populateContexts(!0),that.stage>=5&&that.getSuggestedProduct(),that.forcedProductId=data.answers.productId,that.saveResult(),that.ready=!0},function(){that.stage=1,that.ready=!0})},duplicateFromCourse:function(course){this.ready=!1,this.openModal(5,void 0,course)}};return object.restoreResult(),object}]),angular.module("alphaBuilder").controller("HomeCtrl",["$scope","$timeout","homeTilesSvc","homeQuotesSvc","resizeTiles","translationSvc","$location",function($scope,$timeout,homeTilesSvc,homeQuotesSvc,resizeTiles,translationSvc,$location){this.translationSvc=translationSvc,this.quotesService=homeQuotesSvc,this.quotesService.fetchQuotes(),this.tilesService=homeTilesSvc,this.tilesService.fetchTiles(),$scope.$on("abLocaleChanged",function(event,params){homeTilesSvc.fetchTiles(),homeQuotesSvc.fetchQuotes()}),this.whyCollapsed=!0,this.loginCollapsed=!0,this.ready=!0,this.explore=function(){this.translationSvc.settings.hasOwnProperty("explore_page")&&this.translationSvc.settings.explore_page?$location.path("/what-is-alpha"):this.whyCollapsed=!1;
},$(window).resize(function(){resizeTiles()})}]),angular.module("alphaBuilder").factory("homeQuotesSvc",["$http","$q","translationSvc",function($http,$q,translationSvc){var API_BASE_URL="https://api.alpha.org";return{ready:!1,networkActivity:!1,quotes:[],fetchedLocale:void 0,requestTimeout:void 0,fetchQuotes:function(){var locale=translationSvc.locale;if(!(this.quotes.length>0&&locale==this.fetchedLocale)){this.requestTimeout&&this.requestTimeout.resolve(),this.requestTimeout=$q.defer(),this.ready=!1,this.networkActivity=!0;var that=this;$http.get(API_BASE_URL+"/public/"+locale+"/quotes?limit=5",{timeout:this.requestTimeout.promise}).then(function(data){that.quotes=[];for(var i=0;i<data.data.quotes.length;i++){var quote=data.data.quotes[i];that.quotes.push(quote),that.shuffle(that.quotes)}that.networkActivity=!1,that.ready=!0},function(data){that.networkActivity=!1})}},shuffle:function(array){for(var t,i,m=array.length;m;)i=Math.floor(Math.random()*m--),t=array[m],array[m]=array[i],array[i]=t;return array}}}]),angular.module("alphaBuilder").factory("homeTilesSvc",["$q","$http","cacheSvc","translationSvc","$timeout",function($q,$http,cacheSvc,translationSvc,$timeout){var API_BASE_URL="https://api.alpha.org";return{ready:!1,networkActivity:!1,tiles:[],topTiles:[],bottomTiles:[],fetchedLocale:void 0,requestTimeout:void 0,fetchTiles:function(){var that=this,locale=translationSvc.locale;this.tiles.length>0&&this.fetchedLocale==locale||(this.requestTimeout&&$timeout(function(){that.requestTimeout.resolve()},1e3),this.requestTimeout=$q.defer(),this.networkActivity=!0,this.ready=!1,$http.get(API_BASE_URL+"/public/"+locale+"/home-tiles",{timeout:this.requestTimeout.promise}).then(function(data){that.tiles=[],that.topTiles=[],that.bottomTiles=[];for(var i=0;i<data.data.tiles.length;i++){var tile=data.data.tiles[i];cacheSvc.tiles[data.data.tiles[i].id]=data.data.tiles[i],that.tiles.push(tile)}that.sortTiles(),that.networkActivity=!1,that.ready=!0},function(data){that.networkActivity=!1},1e3))},sortTiles:function(){this.topTiles=[],this.tiles.length>=4&&(this.topTiles=this.tiles.slice(0,4)),this.bottomTiles=[],this.tiles.length>=7&&(this.bottomTiles=this.tiles.slice(4,7))}}}]),angular.module("alphaBuilder").controller("MaterialsController",["$scope","$document","$timeout","materialsSvc","courseSvc","authenticationSvc","packageSvc","resizeTiles","delayedActionSvc","smoothScroll","gettextCatalog",function($scope,$document,$timeout,materialsSvc,courseSvc,authenticationSvc,packageSvc,resizeTiles,delayedActionSvc,smoothScroll,gettextCatalog){authenticationSvc.performAuthCheck(),authenticationSvc.performCurrentAlphaCheck(),this.service=materialsSvc,this.materials=[],$scope.search=null,$scope.format="any",$scope.context="any",$scope.session="any",this.contexts=[{id:"any",label:gettextCatalog.getString("Any Alpha")},{id:"standard",label:gettextCatalog.getString("Alpha")},{id:"youth",label:gettextCatalog.getString("Alpha - Youth")},{id:"students",label:gettextCatalog.getString("Alpha - Students")},{id:"prisons",label:gettextCatalog.getString("Alpha - Prisons")},{id:"forces",label:gettextCatalog.getString("Alpha - Forces")},{id:"seniors",label:gettextCatalog.getString("Alpha - Seniors")},{id:"catholics",label:gettextCatalog.getString("Alpha - Catholics")}],this.formats=[{id:"any",label:gettextCatalog.getString("All Formats")},{id:"book",label:gettextCatalog.getString("Books")},{id:"booklet",label:gettextCatalog.getString("Booklets")},{id:"dvd",label:gettextCatalog.getString("DVDs")},{id:"video",label:gettextCatalog.getString("Videos")}],materialsSvc.fetchSessionNames();var that=this;$scope.$watch("search",function(newVal,oldVal){that.search()}),$scope.$watch("format",function(newVal,oldVal){that.search()}),$scope.$watch("context",function(newVal,oldVal){that.search()}),$scope.$watch("session",function(newVal,oldVal){that.search()}),this.search=function(){_.isEmpty($scope.search)?that.clear():materialsSvc.findMaterials($scope.search,$scope.format,$scope.context,$scope.session,1).then(function(){$timeout(function(){that.gotoResultsTop()})},function(){})},this.clear=function(){materialsSvc.results=[],materialsSvc.noResults=!1,$scope.format="any",$scope.type="any",$scope.session="any",$scope.search=null},this.gotoResultsTop=function(){var results=angular.element(document.getElementById("results-top"));$document.scrollToElementAnimated(results,150,500)},this.pageChanged=function(){this.gotoResultsTop()},materialsSvc.registerObserver(this),authenticationSvc.registerObserver("materialsController",this),this.authChanged=function(){var that=this;$timeout(function(){that.loadCurrentCourse()})},courseSvc.registerObserver("materialsController",this),this.coursesChanged=function(){var that=this;$timeout(function(){that.loadCurrentCourse()})},this.loadCurrentCourse=function(){this.materials=[],packageSvc.fetch(authenticationSvc.sessionData.currentAlpha.packages).then(function(materials){var groupedMaterials=_.chunk(materials,3),lastGroup=_.last(groupedMaterials);if(_.isArray(lastGroup)&&3!=lastGroup.length){var last=_.takeRight(groupedMaterials)[0];groupedMaterials=_.dropRight(groupedMaterials);var newLast=_.last(groupedMaterials).concat(last);groupedMaterials[groupedMaterials.length-1]=newLast}that.materials=groupedMaterials},function(){})},this.loadCurrentCourse(),$(window).resize(function(){resizeTiles()});var that=this;$timeout(function(){var anchor=delayedActionSvc.getDelayedAnchor();void 0!==anchor&&that.scrollToAnchor(anchor)}),this.scrollToAnchor=function(anchor){var element=document.getElementById(anchor);smoothScroll(element,{duration:700,easing:"easeInOutQuad",offset:112})},$scope.$on("$destroy",function(){courseSvc.removeObserver("materialsController")})}]),angular.module("alphaBuilder").directive("abMaterialsPager",["materialsSvc",function(materialsSvc){return{restrict:"E",templateUrl:"/templates/materials/pager.html",link:function(scope,element,attrs){scope.pages=0,scope.pageNums=[],scope.firstPage=!0,scope.lastPage=!1,scope.$watch(function(){return materialsSvc.numResults},function(newVal,oldVal){scope.pages=Math.ceil(materialsSvc.numResults/materialsSvc.limit),scope.updateUI()}),scope.$watch(function(){return materialsSvc.page},function(newVal,oldVal){scope.updateUI()}),scope.updateUI=function(){1===scope.pages?(scope.firstPage=!0,scope.lastPage=!0):scope.pages>1&&1===materialsSvc.page?(scope.firstPage=!0,scope.lastPage=!1):scope.pages>1&&materialsSvc.page===scope.pages?(scope.firstPage=!1,scope.lastPage=!0):scope.pages>1&&(scope.firstPage=!1,scope.lastPage=!1),scope.pageNums=[];for(var i=0;i<scope.pages;i++){var x=i;scope.pageNums.push({num:x+1})}},scope.isCurrentPage=function(page){return page==materialsSvc.page?!0:!1},scope.changePage=function(page){materialsSvc.setPage(page)},scope.previousPage=function(){var page=materialsSvc.page-1;materialsSvc.setPage(page)},scope.nextPage=function(){var page=materialsSvc.page+1;materialsSvc.setPage(page)}}}}]),angular.module("alphaBuilder").factory("materialsSvc",["$http","$q","gettextCatalog","translationSvc",function($http,$q,gettextCatalog,translationSvc){var API_BASE_URL="https://api.alpha.org",locale=translationSvc.locale;return{observers:[],networkConnections:0,results:[],sessionNames:[],page:1,limit:15,numResults:0,requestPage:1,noResults:!1,lastSearch:{},findMaterials:function(search,format,context,session,page){var defer=$q.defer();void 0!==page&&(this.requestPage=page),this.lastSearch={search:search,format:format,context:context,session:session};var request={query:search,filters:[]};"any"!=format&&request.filters.push("formats:"+format),"any"!=context&&request.filters.push("contexts:"+context),"any"!=session&&request.filters.push("sessionUUID:"+session),this.networkConnections++;var that=this;return $http.post(API_BASE_URL+"/public/"+locale+"/products/search?page="+this.requestPage+"&limit="+this.limit,request).then(function(response){that.numResults=response.data.pager.totalItems,that.results=response.data.products,that.page=that.requestPage,0==that.results.length?that.noResults=!0:that.noResults=!1,that.notifyObservers(),defer.resolve()},function(response){that.noResults=!0,defer.reject()})["finally"](function(){that.networkConnections--}),defer.promise},setPage:function(page){page!==this.page&&(this.requestPage=page,this.findMaterials(this.lastSearch.search,this.lastSearch.format,this.lastSearch.context,this.lastSearch.session))},fetchSessionNames:function(force){var defer=$q.defer();if(this.sessionNames.length>0&&force!==!0)return defer.resolve(),defer.promise;this.networkConnections++;var that=this;return $http.get(API_BASE_URL+"/public/"+locale+"/all-session-names").then(function(response){that.sessionNames.push({id:"any",label:gettextCatalog.getString("All Sessions")}),_.forEach(response.data.sessions,function(session){that.sessionNames.push({id:session.UUID,label:session.title})}),defer.resolve()},function(response){defer.reject()})["finally"](function(){that.networkConnections--}),defer.promise},registerObserver:function(callback){this.observers.push(callback)},notifyObservers:function(){var i=0,num=this.observers.length;for(i;num>i;i++)this.observers[i].pageChanged()}}}]),angular.module("alphaBuilder").controller("PreviewCtrl",["$scope","$timeout","translationSvc","$location","$route","$sce","faqsSvc","supportingMaterialsVideosSvc","supportingMaterialsDownloadsSvc","trainingSvc","contactSvc","getStartedSvc","videoWatchedSvc",function($scope,$timeout,translationSvc,$location,$route,$sce,faqsSvc,supportingMaterialsVideosSvc,supportingMaterialsDownloadsSvc,trainingSvc,contactSvc,getStartedSvc,videoWatchedSvc){this.translationSvc=translationSvc,this.trainingSvc=trainingSvc,this.faqsSvc=faqsSvc,this.supportingMaterialsVideosSvc=supportingMaterialsVideosSvc,this.supportingMaterialsDownloadsSvc=supportingMaterialsDownloadsSvc,this.videoWatchedSvc=videoWatchedSvc,this.contactSvc=contactSvc,this.getStartedSvc=getStartedSvc,this.videoReady=!1,this.deferVideoPlay=null,videoWatchedSvc.load(),faqsSvc.getFAQs(),supportingMaterialsVideosSvc.getData(),supportingMaterialsDownloadsSvc.getData(),trainingSvc.getData(),$scope.$on("abLocaleChanged",function(event,params){faqsSvc.getFAQs(),supportingMaterialsVideosSvc.getData(),supportingMaterialsDownloadsSvc.getData(),trainingSvc.getData()}),$scope.activePath=function(){var slugs=$location.path().split("/");return slugs.length>=3?slugs[2]:null}(),$scope.trustSrc=function(src){return $sce.trustAsResourceUrl(src)},this.whyCollapsed=!0,this.loginCollapsed=!0,this.ready=!0,$(window).resize(function(){})}]),angular.module("alphaBuilder").filter("sanitize",["$sce",function($sce){return function(htmlCode){return $sce.trustAsHtml(htmlCode)}}]),angular.module("alphaBuilder").directive("abPreviewHeader",function(){return{restrict:"E",scope:!0,templateUrl:"./templates/preview/header.html"}}),angular.module("alphaBuilder").directive("abPreviewVideoPlayer",["$q","$timeout","authenticationSvc","crmSvc","videoWatchedSvc",function($q,$timeout,authenticationSvc,crmSvc,videoWatchedSvc){return{restrict:"E",scope:{initialVideo:"=",preview:"@preview"},templateUrl:"./templates/preview/video-player.html",link:function(scope,element,attrs){function onFinish(){0==finishLock&&(finishLock="real",_doFinish())}function _doFinish(){var target=container.data("end-cta-overlay-target");if(void 0!=target){var overlay=angular.element(target,container);overlay.show().velocity({opacity:1,width:"100%",height:"100%",left:"0%",top:"0%"},500)}videoWatchedSvc.markAsWatched(iframe.attr("src")),$timeout(function(){finishLock=!1},1e3)}function onPlayProgress(data){0==finishLock&&duration-data.seconds<1&&(finishLock="alt",$timeout(_doFinish,1e3))}var iframe=angular.element("#page-preview #ab-preview-video"),container=angular.element("#ab-preview-video-container"),duration=(angular.element(".play",container),0);scope.$parent.preview.videoReady=!1;var player=$f(iframe[0]);player.addEvent("ready",function(){scope.$parent.preview.videoReady=!0,null!=scope.$parent.preview.deferVideoPlay&&scope.$parent.preview.deferVideoPlay.resolve(),player.addEvent("finish",onFinish),player.addEvent("playProgress",onPlayProgress),player.api("getDuration",function(value){duration=value})});var finishLock=!1;scope.close=function(){var overlay=angular.element(".cta-overlay",container).filter(":visible");overlay.length>0&&overlay.velocity({width:"50%",height:"50%",top:"25%",left:"25%",opacity:0},500,function(){overlay.hide()})},scope.play=function(){var _playVideo=function(){iframe.removeClass("dropped").addClass("show");$timeout(function(){player.api("play")},1500)},attemptToPlayVideo=function(){scope.$parent.preview.videoReady?_playVideo():(scope.$parent.preview.deferVideoPlay=$q.defer(),scope.$parent.preview.deferVideoPlay.promise.then(_playVideo,function(){}))};authenticationSvc.isLoggedIn?attemptToPlayVideo():authenticationSvc.registerMinimal().then(function(){authenticationSvc.isLoggedIn&&attemptToPlayVideo()},function(){})}}}}]),angular.module("alphaBuilder").directive("abPreviewVideoList",["$timeout","videoWatchedSvc",function($timeout,videoWatchedSvc){return{restrict:"E",scope:{data:"=",endCtaOverlay:"="},templateUrl:"./templates/preview/video-list.html",link:function(scope,element,attrs){scope.isWatched=function(url){return videoWatchedSvc.isWatched(url)},scope.selectVideo=function(index){var video=scope.data[index],frame=angular.element("#ab-preview-video"),container=angular.element("#ab-preview-video-container"),title=angular.element(".video-title h2",container),subTitle=angular.element(".video-title p",container),image=angular.element(".preview-image img",container);if(video.embedUrl!=frame.attr("src")){scope.$parent.preview.videoReady=!1,null!=scope.$parent.preview.deferVideoPlay&&(scope.$parent.preview.deferVideoPlay.reject(),scope.$parent.preview.deferVideoPlay=null);var overlay=angular.element(".cta-overlay",container).filter(":visible");overlay.length>0&&overlay.velocity({width:"50%",height:"50%",top:"25%",left:"25%",opacity:0},500,function(){overlay.hide()}),title.html((video.preTitle?video.preTitle+"<br>":"")+video.title),subTitle.html(video.subTitle),video.hasOwnProperty("image")&&image.attr("src",video.image);var videosInCurrentGroup=this.$parent.data,showOverlay=!0;for(idx in videosInCurrentGroup){var vid=videosInCurrentGroup[idx];showOverlay&=idx!=this.idx&&videoWatchedSvc.isWatched(vid.url)||idx==this.idx&&!videoWatchedSvc.isWatched(vid.url)}showOverlay?container.data("end-cta-overlay-target",scope.endCtaOverlay):container.data("end-cta-overlay-target",null),frame.addClass("dropped").removeClass("show"),frame.attr("src",video.embedUrl)}angular.element("html, body").velocity("scroll",{duration:500,offset:container.offset().top-angular.element("#global-nav").height(),easing:"ease-in-out"})}}}}]),angular.module("alphaBuilder").factory("supportingMaterialsDownloadsSvc",["$http","$q","$routeParams","translationSvc",function($http,$q,$routeParams,translationSvc){return{networkActivity:!1,data:[],fetchedLocale:void 0,requestTimeout:void 0,ready:!1,propertyCount:function(obj){var count=0;for(var prop in obj)obj.hasOwnProperty(prop)&&count++;return count},getData:function(){var locale=translationSvc.locale;if(!(this.propertyCount(this.data)>0&&this.fetchedLocale==locale)){this.requestTimeout&&this.requestTimeout.resolve(),this.requestTimeout=$q.defer(),this.networkActivity=!0;var that=this;$http.get("/bundles/app/data/preview/"+locale+"/supporting-materials-downloads.json",{timeout:this.requestTimeout.promise}).then(function(response){that.data=[],that.propertyCount(response.data)>0&&(that.data=response.data,that.fetchedLocale=locale),that.networkActivity=!1,that.ready=!0},function(data){that.networkActivity=!1,that.ready=!1})}}}}]),angular.module("alphaBuilder").factory("supportingMaterialsVideosSvc",["$http","$q","$routeParams","translationSvc",function($http,$q,$routeParams,translationSvc){return{networkActivity:!1,sections:[],fetchedLocale:void 0,requestTimeout:void 0,ready:!1,propertyCount:function(obj){var count=0;for(var prop in obj)obj.hasOwnProperty(prop)&&count++;return count},getCurrentSectionId:function(){return $routeParams.section},getCurrentSection:function(){return this.sections[$routeParams.section]},setInitialVideos:function(){for(idx in this.sections){var section=this.sections[idx];section.length>0&&(section.initialVideo=section[0])}},getData:function(){var locale=translationSvc.locale;if($routeParams.hasOwnProperty("section"))var section=$routeParams.section;if(this.propertyCount(this.sections)>0&&this.fetchedLocale==locale)return void this.setInitialVideos();this.requestTimeout&&this.requestTimeout.resolve(),this.requestTimeout=$q.defer(),this.networkActivity=!0;var that=this;$http.get("/bundles/app/data/preview/"+locale+"/supporting-materials-videos.json",{timeout:this.requestTimeout.promise}).then(function(response){if(that.sections=[],that.propertyCount(response.data)>0){that.sections=response.data;for(section in that.sections)for(videoIdx in that.sections[section])that.sections[section][videoIdx].embedUrl=that.sections[section][videoIdx].url+"?api=1&player_id=ab-preview-video";that.setInitialVideos(),that.fetchedLocale=locale}that.networkActivity=!1,that.ready=!0},function(data){that.networkActivity=!1,that.ready=!1})}}}]),angular.module("alphaBuilder").factory("trainingSvc",["$http","$q","translationSvc",function($http,$q,translationSvc){return{networkActivity:!1,data:[],fetchedLocale:void 0,requestTimeout:void 0,ready:!1,setInitialVideo:function(){this.data.initialVideo=this.data.ready[0]},getData:function(){var locale=translationSvc.locale;if(this.data.length>0&&this.fetchedLocale==locale)return void this.setInitialVideo();this.requestTimeout&&this.requestTimeout.resolve(),this.requestTimeout=$q.defer(),this.networkActivity=!0;var that=this;$http.get("/bundles/app/data/preview/"+locale+"/training-videos.json",{timeout:this.requestTimeout.promise}).then(function(response){if(that.data=[],response.data.hasOwnProperty("ready")){that.data=response.data;for(groupIdx in that.data)for(videoIdx in that.data[groupIdx])that.data[groupIdx][videoIdx].embedUrl=that.data[groupIdx][videoIdx].url+"?api=1&player_id=ab-preview-video";that.setInitialVideo(),that.fetchedLocale=locale}that.networkActivity=!1,that.ready=!0},function(data){that.networkActivity=!1})}}}]),angular.module("alphaBuilder").factory("videoWatchedSvc",["$http","$q","authenticationSvc",function($http,$q,authenticationSvc){var STORAGE_ID="alpha-builder-preview-videos-watched";return{observers:[],networkActivity:!1,data:{},getVideoIdFromUrl:function(url){var matches=url.match(/[0-9]{8,9}/g);return matches.length>0?"video"+matches[0]:void 0},getUserId:function(){return"user"+authenticationSvc.userData.id},markAsWatched:function(url){authenticationSvc.isLoggedIn&&(this.data.hasOwnProperty(this.getUserId())||(this.data[this.getUserId()]={}),this.data[this.getUserId()][this.getVideoIdFromUrl(url)]=Date.now(),this.save())},isWatched:function(url){return authenticationSvc.isLoggedIn?this.data.hasOwnProperty(this.getUserId())&&this.data[this.getUserId()].hasOwnProperty(this.getVideoIdFromUrl(url)):!1},save:function(){localStorage.setItem(STORAGE_ID,JSON.stringify(this.data))},load:function(){var localData=localStorage.getItem(STORAGE_ID)||null;return localData?(this.data=JSON.parse(localData),this.notifyObservers(),!0):!1},registerObserver:function(callback){this.observers.push(callback)},notifyObservers:function(){var i=0,num=this.observers.length;for(i;num>i;i++)this.observers[i].profileChanged()}}}]),angular.module("alphaBuilder").controller("ProductCtrl",["$scope","$routeParams","productSvc","authenticationSvc","courseSvc","resizeTiles",function($scope,$routeParams,productSvc,authenticationSvc,courseSvc,resizeTiles){this.productService=productSvc,this.authService=authenticationSvc,this.courseService=courseSvc,productSvc.fetchProduct($routeParams.productId),resizeTiles(),$(window).resize(function(){resizeTiles()})}]),angular.module("alphaBuilder").directive("abSession",["authenticationSvc","courseSvc",function(authenticationSvc,courseSvc){return{restrict:"E",scope:{session:"=",index:"="},templateUrl:"/templates/product/session.html",link:function(scope,element,attrs){scope.loggedIn=authenticationSvc.isLoggedIn&&courseSvc.courses.length>0}}}]),angular.module("alphaBuilder").factory("productSvc",["$http","cacheSvc","gettextCatalog",function($http,cacheSvc,gettextCatalog){var API_BASE_URL="https://api.alpha.org";return{networkActivity:!1,ready:!1,product:null,related:[],fetchProduct:function(productId){if(this.ready=!1,this.product=null,this.related=[],void 0!==cacheSvc.tiles[productId]){var product=cacheSvc.tiles[productId];return this.processProduct(product,!1),this.networkActivity=!1,void(this.ready=!0)}this.networkActivity=!0;var that=this;$http.get(API_BASE_URL+"/public/products/"+productId).then(function(data){var product=data.data.product;that.processProduct(product,!0),that.networkActivity=!1,that.ready=!0},function(data){that.ready=!1,that.networkActivity=!1})},processProduct:function(product,updateCache){this.calculateDefaultLength(product),this.sortSessions(product),this.product=product,this.fetchRelated(product.id),"session"===product.productType&&(product.title=product.parentProduct.title,product.subtitle=product.parentProduct.subtitle,product.heroImageURL=product.parentProduct.heroImageURL,product.squareImageURL=product.parentProduct.squareImageURL,product.rectangleImageURL=product.parentProduct.rectangleImageURL,product.description=product.parentProduct.description,product.previewVideoURL=product.parentProduct.previewVideoURL),updateCache&&(cacheSvc.tiles[product.id]=product)},fetchRelated:function(productId){this.networkActivity=!0,this.related=[];var that=this;$http.get(API_BASE_URL+"/public/tile/"+productId+"/related").then(function(response){for(var i=0;i<response.data.tiles.length;i++){var tile=response.data.tiles[i];cacheSvc.tiles[response.data.tiles[i].id]=response.data.tiles[i],that.related.push(tile)}0==response.data.tiles.length&&($(".loading-tile").remove(),$(".main .content").addClass("col-sm-12").removeClass("col-sm-6")),that.ready=!0,that.networkActivity=!1},function(data){$(".row.related").remove(),that.ready=!0,that.networkActivity=!1})},calculateDefaultLength:function(product){angular.forEach(product.lengths,function(value,key){1==value.isDefaultLength&&(product.defaultLength=value.length)})},sortSessions:function(product){var realSessions=[],productLength=product.defaultLength,counter={s:0,w:0};angular.forEach(product.sessions,function(session){var nSession=null;if("main"===product.productType?angular.forEach(session.assignments,function(value,key){value.length==productLength&&(nSession={},nSession.titleOverride=value.titleOverride,nSession.priority=value.priority)}):nSession={},nSession){nSession.id=session.id,nSession.UUID=session.sessionUUID.UUID,nSession.title=session.sessionUUID.title,void 0!==nSession.titleOverride&&null!==nSession.titleOverride&&""!==nSession.titleOverride&&(nSession.title=nSession.titleOverride,delete nSession.titleOverride),nSession.downloadURL=session.downloadURL,nSession.previewVideoURL=session.previewVideoURL;var type=nSession.UUID.charAt(0).toLowerCase();"s"==type?(counter.s++,nSession.label=gettextCatalog.getString("Session")+" "+counter.s):"w"==type&&(counter.w++,nSession.label=gettextCatalog.getString("Weekend Session")+" "+counter.w),realSessions.push(nSession)}});var orderedSessions=realSessions;"main"===product.productType&&(orderedSessions=realSessions.sort(function(a,b){return a.priority-b.priority}));var counter={s:0,w:0};angular.forEach(orderedSessions,function(session){var type=session.UUID.charAt(0).toLowerCase();"s"==type?(counter.s++,session.label=gettextCatalog.getString("Session")+" "+counter.s):"w"==type&&(counter.w++,session.label=gettextCatalog.getString("Weekend Session")+" "+counter.w)}),product.processedSessions=orderedSessions}}}]),angular.module("alphaBuilder").controller("PreviewImageController",["$scope","$modalInstance","material","authenticationSvc",function($scope,$modalInstance,material,authenticationSvc){function checkWidth(){var $window=$(window),windowWidth=$window.width(),mediaWidth=$("img#preview").width(),margin=30,$loader=$(".col-loading");if($loader.remove(),windowWidth>=768){var imageWidth=$("img#preview").width()+margin;imageWidth>windowWidth?$(".modal-preview-image .modal-dialog").animate({width:"100%"},0,function(){$("img#preview").css({"max-width":"100%",height:"auto"}).fadeIn(500)}):$(".modal-preview-image .modal-dialog").animate({width:mediaWidth+margin+"px"},500,function(){$("img#preview").fadeIn(500)})}else $(".modal-preview-image .modal-dialog").animate({width:"100%"},0),$("img#preview").show()}function windowResized(){checkWidth()}authenticationSvc.performAuthCheck(),this.close=function(){$modalInstance.close("done")},this.material=material;var action;window.onresize=function(){clearTimeout(action),action=setTimeout(windowResized,100)},this.resizeWindow=function(){checkWidth()}}]),angular.module("alphaBuilder").controller("PromotePrintController",["$scope","promoteSvc","authenticationSvc",function($scope,promoteSvc,authenticationSvc){authenticationSvc.performAuthCheck(),authenticationSvc.performCurrentAlphaCheck(),this.promoteSvc=promoteSvc,this.oneAtATime=!0;var that=this;this.promoteSvc.fetch()["finally"](function(){that.promoteSvc.printMaterials[0].isOpen=!0}),$.fn.aiMaterialOptionsReveal=function(){return this.each(function(){var element=$(this);element.find(".btn-extra").click(function(){if(element.hasClass("animating"))return!1;element.addClass("animating");var table=element.find("table"),options=table.find(".options"),frame=table.find(".options-frame"),width=table.width(),optionsWidth=(element.height(),options.width()),numOptions=options.find(".options-frame").children().length,widthDiff=54*(numOptions-1);return element.hasClass("expanded")?frame.find("a").fadeOut(400,function(){table.animate({width:width-widthDiff},{duration:400,queue:!1}),options.animate({width:optionsWidth-widthDiff},{duration:400,queue:!1,complete:function(){frame.find(".btn-extra").fadeIn(),element.removeClass("expanded"),table.css({width:"100%"}),table.css({"float":"none"}),element.removeClass("animating")}})}):(frame.find("a").fadeOut(400),table.css({width:width}),table.css({"float":"right"}),table.animate({width:width+widthDiff},{duration:400,queue:!1}),options.animate({width:optionsWidth+widthDiff},{duration:400,queue:!1,complete:function(){frame.find("a").fadeIn(),element.addClass("expanded"),element.removeClass("animating")}})),!1})})},$(".material-group").aiMaterialOptionsReveal()}]),angular.module("alphaBuilder").controller("PromoteController",["$scope","$modal","$timeout","authenticationSvc","courseSvc","coachingNotificationSvc","delayedActionSvc","smoothScroll",function($scope,$modal,$timeout,authenticationSvc,courseSvc,coachingNotificationSvc,delayedActionSvc,smoothScroll){authenticationSvc.performAuthCheck(),authenticationSvc.performCurrentAlphaCheck(),this.course=void 0,authenticationSvc.registerObserver("promoteController",this),this.authChanged=function(){var that=this;$timeout(function(){that.loadCurrentCourse()})},this.loadCurrentCourse=function(){this.course=authenticationSvc.sessionData.currentAlpha},this.loadCurrentCourse(),this.promote=function(){var promoteModalInstance=$modal.open({templateUrl:"/templates/promote/publish-alpha-modal.html",controller:"PublishAlphaController",controllerAs:"publishAlphaCtrl",windowClass:"modal-promote-alpha",size:"sm"});promoteModalInstance.result["finally"](function(){if(authenticationSvc.isLoggedIn){var currentAlpha=authenticationSvc.sessionData.currentAlpha;courseSvc.hasCompletedTask(currentAlpha,"promote")||courseSvc.completeTask(currentAlpha,"promote")}})},this.unpromote=function(){$modal.open({templateUrl:"/templates/promote/unpublish-alpha-modal.html",controller:"PublishAlphaController",controllerAs:"publishAlphaCtrl",windowClass:"modal-unpromote-alpha",size:"sm"})};var that=this;$timeout(function(){var anchor=delayedActionSvc.getDelayedAnchor();void 0!==anchor&&that.scrollToAnchor(anchor)}),this.scrollToAnchor=function(anchor){var element=document.getElementById(anchor);smoothScroll(element,{duration:700,easing:"easeInOutQuad",offset:112})}}]),angular.module("alphaBuilder").directive("abPromotionalCategory",function(){return{restrict:"E",scope:{category:"=",materials:"="},templateUrl:"/templates/promote/category.html"}}),angular.module("alphaBuilder").directive("abPromotionalMaterial",["$timeout","$modal",function($timeout,$modal){return{restrict:"E",scope:{material:"="},templateUrl:"/templates/promote/material.html",link:function($scope,element,attrs){$timeout(function(){$(".material-group").aiMaterialOptionsReveal()}),$scope.preview=function(){$modal.open({templateUrl:"/templates/promote/preview-image-modal.html",controller:"PreviewImageController",controllerAs:"previewImageCtrl",windowClass:"modal-preview-image",size:"sm",resolve:{material:function(){return $scope.material}}})}}}}]),angular.module("alphaBuilder").directive("imageOnload",function(){return{restrict:"A",link:function(scope,element,attrs){element.bind("load",function(){scope.$apply(attrs.imageOnload)})}}}),angular.module("alphaBuilder").factory("promoteSvc",["$http","$q","translationSvc",function($http,$q,translationSvc){function Material(id,title,downloadURL,customiseURL,previewImageFilename){this.id=id,this.title=title,this.downloadURL=downloadURL,this.customiseURL=customiseURL,this.filename=previewImageFilename,this.thumbnailImageURL=void 0,this.previewImageURL=void 0,this.productType="promotional"}var API_BASE_URL="https://api.alpha.org",locale=translationSvc.locale;return Material.prototype.process=function(){return this.thumbnailImageURL=API_BASE_URL+this.filename+"?w=150&h=50&sharp=5&fit=contain",this.previewImageURL=API_BASE_URL+this.filename+"?w=1000&h=500&sharp=5&fit=contain",this},{networkConnections:0,fetch:function(forceReload){var defer=$q.defer();if(!forceReload&&this.printMaterials.length>0)return defer.resolve(),defer.promise;this.networkConnections++;var that=this;return $http.get(API_BASE_URL+"/public/"+locale+"/promotional-materials").then(function(response){_.forOwn(response.data.types.print,function(materials,category){var processedMaterials=[];_.forEach(materials,function(item){processedMaterials.push(new Material(item.id,item.title,item.downloadURL,item.customiseURL,item.previewImageFilename).process())}),that.printMaterials.push({title:category,isOpen:!1,materials:processedMaterials})}),_.forOwn(response.data.types.social,function(materials,category){var processedMaterials=[];_.forEach(materials,function(item){processedMaterials.push(new Material(item.id,item.title,item.downloadURL,item.customiseURL,item.previewImageFilename).process())}),that.socialMaterials.push({title:category,isOpen:!1,materials:processedMaterials})}),that.networkConnections--,defer.resolve()},function(response){that.networkConnections--,defer.reject()}),defer.promise},printMaterials:[],socialMaterials:[]}}]),angular.module("alphaBuilder").controller("PublishAlphaController",["$scope","$modalInstance","$location","authenticationSvc","commonSvc","courseSvc","dateSvc","coachingNotificationSvc","gettextCatalog",function($scope,$modalInstance,$location,authenticationSvc,commonSvc,courseSvc,dateSvc,coachingNotificationSvc,gettextCatalog){authenticationSvc.performAuthCheck(),this.close=function(){$modalInstance.dismiss()},this.promoted=!1,this.networkActivity=!1,this.errorMessage=null,this.successMessage=null,this.edit=function(){$modalInstance.dismiss(),$location.path("/update-alpha")},this.next=function(){$modalInstance.close(),$location.path("/invite/social"),coachingNotificationSvc.presentPromoted()},this.course=authenticationSvc.sessionData.currentAlpha,this.promote=function(){this.networkActivity=!0;var that=this;courseSvc.promote(this.course.id).then(function(updatedCourse){that.errorMessage=null,
that.networkActivity=!1,that.next()},function(error){that.networkActivity=!1,that.errorMessage=gettextCatalog.getString("We could not promote your Alpha at this time, please try again or contact support")})},this.unpromote=function(){this.networkActivity=!0;var that=this;courseSvc.unpromote(this.course.id).then(function(updatedCourse){that.errorMessage=null,that.successMessage=gettextCatalog.getString("Your Alpha has been successfully removed from Alpha.org"),that.networkActivity=!1},function(error){that.networkActivity=!1,that.errorMessage=gettextCatalog.getString("We could not remove your Alpha at this time, please try again or contact support"),that.successMessage=null})},this.startDate=dateSvc.stringToDate(this.course.start,"YYYY-MM-DDThh:mm:ss"),this.endDate=dateSvc.stringToDate(this.course.finish,"YYYY-MM-DDThh:mm:ss"),this.address="",this.addLineToAddress=function(line){line&&(this.address+=line+"<br/>")};var that=this;commonSvc.fetchCountries()["finally"](function(countries){that.addLineToAddress(that.course.venue.addressLine1),that.addLineToAddress(that.course.venue.addressLine2),that.addLineToAddress(that.course.venue.addressLine3),that.addLineToAddress(that.course.venue.city),that.addLineToAddress(that.course.venue.county),that.addLineToAddress(commonSvc.countryForISO(that.course.venue.country).name),that.addLineToAddress(that.course.postcode),that.address=that.address.substr(0,that.address.length-5)})}]),angular.module("alphaBuilder").controller("PromoteSocialController",["$scope","$modal","promoteSvc","authenticationSvc",function($scope,$modal,promoteSvc,authenticationSvc){authenticationSvc.performAuthCheck(),authenticationSvc.performCurrentAlphaCheck(),this.promoteSvc=promoteSvc,this.oneAtATime=!0;var that=this;this.promoteSvc.fetch()["finally"](function(){that.promoteSvc.socialMaterials[0].isOpen=!0}),$.fn.aiMaterialOptionsReveal=function(){return this.each(function(){var element=$(this);element.find(".btn-extra").click(function(){if(element.hasClass("animating"))return!1;element.addClass("animating");var table=element.find("table"),options=table.find(".options"),frame=table.find(".options-frame"),width=table.width(),optionsWidth=(element.height(),options.width()),numOptions=options.find(".options-frame").children().length,widthDiff=54*(numOptions-1);return element.hasClass("expanded")?frame.find("a").fadeOut(400,function(){table.animate({width:width-widthDiff},{duration:400,queue:!1}),options.animate({width:optionsWidth-widthDiff},{duration:400,queue:!1,complete:function(){frame.find(".btn-extra").fadeIn(),element.removeClass("expanded"),table.css({width:"100%"}),table.css({"float":"none"}),element.removeClass("animating")}})}):(frame.find("a").fadeOut(400),table.css({width:width}),table.css({"float":"right"}),table.animate({width:width+widthDiff},{duration:400,queue:!1}),options.animate({width:optionsWidth+widthDiff},{duration:400,queue:!1,complete:function(){frame.find("a").fadeIn(),element.addClass("expanded"),element.removeClass("animating")}})),!1})})},$(".material-group").aiMaterialOptionsReveal()}]),angular.module("alphaBuilder").factory("translationSvc",["$q","$http","$rootScope","tmhDynamicLocale","gettextCatalog",function($q,$http,$rootScope,tmhDynamicLocale,gettextCatalog){var STORAGE_ID="alpha-builder-translation",API_BASE_URL="https://api.alpha.org";return{locale:"en_GB",settings:void 0,networkConnections:0,ready:!1,requestTimeout:void 0,changeLocale:function(newLocale,localRootScope,loadSettings){var defer=$q.defer();this.ready=!1;var that=this;return tmhDynamicLocale.set(newLocale).then(function(){gettextCatalog.setCurrentLanguage(newLocale),gettextCatalog.loadRemote("/js/translations/"+newLocale+".json").then(function(){that.locale=newLocale,void 0===loadSettings||loadSettings===!0?(that.settings=void 0,that.fetch(newLocale)["finally"](function(){localRootScope.$broadcast("abLocaleChanged",{locale:newLocale}),that.save(),that.ready=!0}),defer.resolve()):(localRootScope.$broadcast("abLocaleChanged",{locale:newLocale}),that.save(),that.ready=!0,defer.resolve())})}),defer.promise},fetch:function(locale){var defer=$q.defer();if(this.settings&&locale==this.locale)return defer.reject(),defer.promise;this.requestTimeout&&this.requestTimeout.resolve(),this.requestTimeout=$q.defer(),this.networkConnections++;var that=this;return $http.get(API_BASE_URL+"/public/"+this.locale+"/settings",{timeout:this.requestTimeout.promise}).then(function(response){response.data.settings?that.settings=response.data.settings:that.settings=void 0,that.save(),defer.resolve(that.settings)},function(data){that.settings=void 0,defer.reject()})["finally"](function(){that.networkConnections--}),defer.promise},save:function(){localStorage.setItem(STORAGE_ID,JSON.stringify({locale:this.locale,settings:this.settings}))},restore:function(){var defer=$q.defer(),localData=localStorage.getItem(STORAGE_ID)||null;if(localData){var data=JSON.parse(localData);this.locale=data.locale,this.settings=data.settings,this.changeLocale(data.locale,$rootScope,!1)["finally"](function(){defer.resolve(this.locale)})}else{this.changeLocale(this.locale,$rootScope)["finally"](function(){defer.resolve(this.locale)})}return defer.promise},"switch":function(locale){this.changeLocale(locale,$rootScope)["finally"](function(){})}}}]);